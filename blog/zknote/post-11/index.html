<!doctype html><html class=scroll-smooth lang=en><head><meta charset=utf-8><link href=/css/style.css rel=stylesheet><link href=/line-awesome/css/line-awesome.min.css rel=stylesheet><script defer src=/js/main.js></script><title>R1CS to QAP in Python | Random thoughts here</title><body class="bg-white dark:bg-slate-900 transition ease-in-out"><section><div class="sticky top-0 bg-slate-100 dark:bg-slate-800"><div class="container mx-auto flex place-content-between py-16 lg:py-8 font-sans text-6xl lg:text-2xl text-slate-900 dark:text-slate-300"><div class=flex><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/> /blog </a><a class="m-0 p-0 text-slate-900 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-200" href=/blog/zknote/> /zknote </a></div><div class="flex gap-4"><div class="hidden cursor-pointer" id=back-to-top><i class="las la-level-up-alt"></i></div><a href=/><i class="las la-home"></i></a><div class=cursor-pointer id=darkmode-toggle><div class="hidden dark:inline"><i class="las la-sun"></i></div><div class="inline dark:hidden"><i class="las la-moon"></i></div></div></div></div></div><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$']]}
      });
    </script><div class="container mb-16"><div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl lg:text-base">2024-03-10</div><h1 class="w-full mt-4 mb-8 font-serif text-8xl lg:text-4xl text-slate-900 dark:text-slate-300">R1CS to QAP in Python</h1><div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div><div class=prose-boring><h3 id=r1cs-to-qap-in-python>R1CS to QAP in Python</h3><p>For constraint<p>$$ out = x⁴ - 5y²x² \ => \space\begin{equation}<br> \left{ \begin{array}{<strong>lr</strong>} v_1 = x<em>x \ v_2 = v_1</em>v_1 \ v_3 = -5y * y \ -v_2 + out = v_3 * v_1 \end{array} \right. \end{equation} $$<p>we have new matrices are<pre class=language-python data-lang=python style=color:#d8dee9;background-color:#2e3440><code class=language-python data-lang=python><span>L </span><span style=color:#81a1c1>= </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>array</span><span>([
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>74</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span>]</span><span style=color:#eceff4>,
</span><span>])
</span><span>
</span><span>R </span><span style=color:#81a1c1>= </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>array</span><span>([
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>])
</span><span>
</span><span>O </span><span style=color:#81a1c1>= </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>array</span><span>([
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span>]</span><span style=color:#eceff4>,
</span><span>    [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span style=color:#b48ead>78</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span>]</span><span style=color:#eceff4>,
</span><span>])
</span></code></pre><h3 id=finite-field-arithmetic-in-python>Finite Field Arithmetic in Python</h3><p>We can convert them to field arrays simply by wrapping them with GF like the following:<pre class=language-python data-lang=python style=color:#d8dee9;background-color:#2e3440><code class=language-python data-lang=python><span>L_galois </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(L)
</span><span>R_galois </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(R)
</span><span>O_galois </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(O)
</span><span>
</span><span>x </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(</span><span style=color:#b48ead>4</span><span>)
</span><span>y </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(</span><span style=color:#b48ead>79</span><span style=color:#81a1c1>-</span><span style=color:#b48ead>2</span><span>) </span><span style=color:#616e88># we are using 79 as the field size, so 79 - 2 is -2
</span><span>v1 </span><span style=color:#81a1c1>= </span><span>x </span><span style=color:#81a1c1>* </span><span>x
</span><span>v2 </span><span style=color:#81a1c1>= </span><span>v1 </span><span style=color:#81a1c1>* </span><span>v1         </span><span style=color:#616e88># x^4
</span><span>v3 </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(</span><span style=color:#b48ead>79</span><span style=color:#81a1c1>-</span><span style=color:#b48ead>5</span><span>)</span><span style=color:#81a1c1>*</span><span>y </span><span style=color:#81a1c1>* </span><span>y
</span><span>out </span><span style=color:#81a1c1>= </span><span>v3</span><span style=color:#81a1c1>*</span><span>v1 </span><span style=color:#81a1c1>+ </span><span>v2    </span><span style=color:#616e88># -5y^2 * x^2
</span><span>
</span><span>witness </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>array</span><span>([</span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span>out</span><span style=color:#eceff4>, </span><span>x</span><span style=color:#eceff4>, </span><span>y</span><span style=color:#eceff4>, </span><span>v1</span><span style=color:#eceff4>, </span><span>v2</span><span style=color:#eceff4>, </span><span>v3]))
</span><span>
</span><span style=color:#81a1c1>assert </span><span style=color:#88c0d0;font-style:italic>all</span><span>(np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>equal</span><span>(np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>matmul</span><span>(L_galois</span><span style=color:#eceff4>, </span><span>witness) </span><span style=color:#81a1c1>* </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>matmul</span><span>(R_galois</span><span style=color:#eceff4>, </span><span>witness)</span><span style=color:#eceff4>, </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>matmul</span><span>(O_galois</span><span style=color:#eceff4>, </span><span>witness))), </span><span style=color:#a3be8c>"not equal"
</span></code></pre><p>and then do the lagrange interpolation for our computation<h3 id=polynomial-interpolation-in-finite-fields>Polynomial interpolation in finite fields</h3><pre class=language-python data-lang=python style=color:#d8dee9;background-color:#2e3440><code class=language-python data-lang=python><span style=color:#81a1c1>def </span><span style=color:#88c0d0>interpolate_column</span><span>(col):
</span><span>    xs </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>GF</span><span>(np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>array</span><span>([</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#b48ead>2</span><span style=color:#eceff4>,</span><span style=color:#b48ead>3</span><span style=color:#eceff4>,</span><span style=color:#b48ead>4</span><span>]))
</span><span>    </span><span style=color:#81a1c1>return </span><span>galois</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lagrange_poly</span><span>(xs</span><span style=color:#eceff4>, </span><span>col)
</span><span>
</span><span style=color:#616e88># axis 0 is the columns. apply_along_axis is the same as doing a for loop over the columns and collecting the results in an array
</span><span>U_polys </span><span style=color:#81a1c1>= </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>apply_along_axis</span><span>(interpolate_column</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span>L_galois)
</span><span>V_polys </span><span style=color:#81a1c1>= </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>apply_along_axis</span><span>(interpolate_column</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span>R_galois)
</span><span>W_polys </span><span style=color:#81a1c1>= </span><span>np</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>apply_along_axis</span><span>(interpolate_column</span><span style=color:#eceff4>, </span><span style=color:#b48ead>0</span><span style=color:#eceff4>, </span><span>O_galois)
</span></code></pre><h3 id=computing-h-x>Computing h(x)</h3><p>t(x) will be (x - 1)(x - 2)(x - 3)(x - 4) by interpolation, since we’ve introduct this in the last episode.<p>Each of the terms is taking the inner product of the witness with the column-interpolating polynomials. That is, each of summation terms are effectively the inner product between &LT1, a₁, …, aₘ> and &LTu₀(x), u₁(x), …, uₘ(x)><pre class=language-python data-lang=python style=color:#d8dee9;background-color:#2e3440><code class=language-python data-lang=python><span style=color:#81a1c1>def </span><span style=color:#88c0d0>inner_product_polynomials_with_witness</span><span>(polys</span><span style=color:#eceff4>, </span><span>witness):
</span><span>    mul_ </span><span style=color:#81a1c1>= lambda </span><span>x</span><span style=color:#eceff4>, </span><span>y: x </span><span style=color:#81a1c1>* </span><span>y
</span><span>    sum_ </span><span style=color:#81a1c1>= lambda </span><span>x</span><span style=color:#eceff4>, </span><span>y: x </span><span style=color:#81a1c1>+ </span><span>y
</span><span>    </span><span style=color:#81a1c1>return </span><span style=color:#88c0d0;font-style:italic>reduce</span><span>(sum_</span><span style=color:#eceff4>, </span><span style=color:#88c0d0;font-style:italic>map</span><span>(mul_</span><span style=color:#eceff4>, </span><span>polys</span><span style=color:#eceff4>, </span><span>witness))
</span><span>
</span><span>term_1 </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>inner_product_polynomials_with_witness</span><span>(U_polys</span><span style=color:#eceff4>, </span><span>witness)
</span><span>term_2 </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>inner_product_polynomials_with_witness</span><span>(V_polys</span><span style=color:#eceff4>, </span><span>witness)
</span><span>term_3 </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>inner_product_polynomials_with_witness</span><span>(W_polys</span><span style=color:#eceff4>, </span><span>witness)
</span></code></pre><p>Note that we cannot compute h(x) unless we have a valid witness, as we have combined the witness into our polynomials.<pre class=language-python data-lang=python style=color:#d8dee9;background-color:#2e3440><code class=language-python data-lang=python><span style=color:#616e88># t = (x - 1)(x - 2)(x - 3)(x - 4)
</span><span>t </span><span style=color:#81a1c1>= </span><span>galois</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>Poly</span><span>([</span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>78</span><span>]</span><span style=color:#eceff4>, </span><span>field </span><span style=color:#81a1c1>= GF</span><span>) </span><span style=color:#81a1c1>* </span><span>galois</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>Poly</span><span>([</span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>77</span><span>]</span><span style=color:#eceff4>, </span><span>field </span><span style=color:#81a1c1>= GF</span><span>) </span><span style=color:#81a1c1>* </span><span>galois</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>Poly</span><span>([</span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>76</span><span>]</span><span style=color:#eceff4>, </span><span>field </span><span style=color:#81a1c1>= GF</span><span>) </span><span style=color:#81a1c1>* </span><span>galois</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>Poly</span><span>([</span><span style=color:#b48ead>1</span><span style=color:#eceff4>, </span><span style=color:#b48ead>75</span><span>]</span><span style=color:#eceff4>, </span><span>field </span><span style=color:#81a1c1>= GF</span><span>)
</span><span>
</span><span>h </span><span style=color:#81a1c1>= </span><span>(term_1 </span><span style=color:#81a1c1>* </span><span>term_2 </span><span style=color:#81a1c1>- </span><span>term_3) </span><span style=color:#81a1c1>// </span><span>t
</span></code></pre><p>Unlike poly1d from numpy, the galois library won’t indicate to us if there is a remainder, so we need to check if the QAP formula is still true.<pre class=language-python data-lang=python style=color:#d8dee9;background-color:#2e3440><code class=language-python data-lang=python><span style=color:#81a1c1>assert </span><span>term_1 </span><span style=color:#81a1c1>* </span><span>term_2 </span><span style=color:#81a1c1>== </span><span>term_3 </span><span style=color:#81a1c1>+ </span><span>h </span><span style=color:#81a1c1>* </span><span>t, </span><span style=color:#a3be8c>"division has a remainder"
</span></code></pre></div></div></section>