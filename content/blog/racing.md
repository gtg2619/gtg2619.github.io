---
title: "Racing and Smashing the state machine. learn from bh23"
date: 2023-08-17T00:00:00+08:00
---

# Thesis content & Personal summary

æ•´ç†æ€»ç»“è‡ª`jameskettle`åœ¨`Black Hat USA 2023`ä¸Šçš„å‘å¸ƒçš„æ¼”è®²ä¸»é¢˜å’Œæ–‡ç« `Smashing the state machine: the true potential of web race conditions`[^1]ï¼Œå¹¶å¤¹æ‚ä¸ªäººçç¢çš„ç†è§£å’Œè”æƒ³ã€‚





## Limited exploit

å¤§å¤šæ•°ç½‘ç«™ä½¿ç”¨**å¤šçº¿ç¨‹**å¤„ç†å¹¶å‘è¯·æ±‚ï¼Œæ‰€æœ‰çš„è¯»å†™éƒ½æ¥è‡ªä¸€ä¸ª**å•ä¸€çš„ã€å…±äº«**çš„æ•°æ®åº“ã€‚åº”ç”¨ç¨‹åºä»£ç å¾ˆå°‘è€ƒè™‘åˆ°**å¹¶å‘é£é™©**ï¼Œå› æ­¤ï¼Œç«æ€å†’é™©é—®é¢˜å›°æ‰°ç€å¤§é‡çš„webåº”ç”¨ã€‚ç«äº‰é—®é¢˜åœ¨æ­¤ä¹‹å‰é›†ä¸­åœ¨æå°‘æ•°çš„åœºæ™¯ä¸­ï¼Œç”±äº**æµ‹è¯•å›°éš¾ã€ç¼ºä¹å·¥å…·ã€ç½‘ç»œæŠ–åŠ¨ã€ä¸å¯é¿å…çš„å»¶è¿Ÿ**ç­‰å› ç´ ï¼Œè¿™ä¸€åˆ©ç”¨å¹¶æ²¡æœ‰å¹¿æ³›æµè¡Œã€å…¶å¨èƒæ€§æ²¡æœ‰å®Œæ•´ä½“ç°ã€‚

![race-conditions-discount-code-race](Racing and Smashing the state machine/race-conditions-discount-code-race.png)

ç»å…¸çš„ç«äº‰å†’é™©åˆ©ç”¨åŒ…æ‹¬**å¤šæ¬¡åº”ç”¨åŒä¸€æŠ˜æ‰£**ã€**é‡å¤æå–æˆ–è½¬ç§»è´¦æˆ·ä½™é¢çš„ç°é‡‘**ç­‰ï¼ŒåŸºæœ¬å¯ä»¥å½’çº³ä¸º**Limit-overrun attack**ï¼Œåˆ©ç”¨åº”ç”¨å­˜åœ¨çš„çš„**æ£€æŸ¥æ—¶é—´ï¼Œä½¿ç”¨æ—¶é—´(time of check, time of use, TOCTOU)**çš„ç¼ºé™·ï¼Œç»•è¿‡å®‰å…¨ä¿æŠ¤å¤šæ¬¡æ‰§è¡Œå—ä¿æŠ¤æ“ä½œã€‚



## Parallel transmission Technique

å•åŒ…æ”»å‡»è§£å†³äº†ç½‘ç»œæŠ–åŠ¨ï¼Œä½¿å¾—æ¯ä¸€æ¬¡æ”»å‡»éƒ½åƒæ˜¯åœ¨æœ¬åœ°ç³»ç»Ÿä¸Šè¿›è¡Œçš„ï¼Œè¿™æš´éœ²äº†ä»¥å‰å‡ ä¹ä¸å¯èƒ½æ£€æµ‹æˆ–åˆ©ç”¨çš„æ¼æ´ã€‚**å•åŒ…æ”»å‡»æ¯”æœ«å­—èŠ‚åŒæ­¥çš„æ•ˆç‡ä»ç„¶é«˜å‡ºä¸€ä¸ªæ•°é‡çº§ï¼Œå¦‚æœæœåŠ¡ç«¯æ”¯æŒHTTP /2åº”é¦–å…ˆé€‰ç”¨ã€‚**

### HTTP 2 - Single Package Attack Technique

å¯¹äº`HTTP /2`ç«äº‰åˆ©ç”¨çš„ç¨³å®šæ€§ï¼Œ`jameskettle`é‡‡ç”¨ USENIX presentation Timeless Timing Attacks[^2] çš„æ–¹å¼ï¼Œåˆ©ç”¨`HTTP /2`**å¤šè·¯å¤ç”¨ç‰¹æ€§**ï¼Œåœ¨å•ä¸ªè¿æ¥å¹¶å‘åœ°å‘é€ HTTP è¯·æ±‚ï¼Œå¯ä»¥ä½¿å¾—ä¸¤ä¸ªè¯·æ±‚ç›´æ¥çš„é—´éš”æå°(<1ms)ã€‚è¿™ç§æ€è·¯ä¸2020å¹´çš„ä¸€ä¸ªç ”ç©¶ååˆ†ç›¸ä¼¼[^3]

![9c53-article-blackhat_diagrams-13](Racing and Smashing the state machine/9c53-article-blackhat_diagrams-13-16922686162413.png)



### HTTP 1.x - Last-byte sync

ç”±äºHTTP 1.xä¸ºæ¯ä¸€ä¸ªè¯·æ±‚ä½¿ç”¨ä¸€æ¬¡TCPè¿æ¥ï¼Œæ— æ³•æ²¿ç”¨HTTP2çš„æ–¹æ³•ã€‚ä¸ºäº†æé«˜`HTTP /1.x`ç«äº‰åˆ©ç”¨çš„ç¨³å®šæ€§ï¼Œ`jameskettle`é€šè¿‡å¯¹ Nagle's algorithm[^4] åˆ›é€ æ€§æ»¥ç”¨ï¼Œæå‡ºäº†ä¸€ç§`æœ«å­—èŠ‚åŒæ­¥(last-byte sync technique)`çš„æ–¹å¼ï¼Œå¹¶å®Œæˆäº†å…·ä½“çš„å®ç°ã€‚

*é€‰ç”¨ä¸€ä¸ªå·²æœ‰çš„HTTP 2 libraryæ¥hook

é¦–å…ˆï¼Œé¢„å…ˆå‘é€æ¯ä¸ªè¯·æ±‚çš„å¤§éƒ¨åˆ†å†…å®¹: 

å¦‚æœè¯·æ±‚æ²¡æœ‰æ­£æ–‡ï¼Œåˆ™å‘é€æ‰€æœ‰æŠ¥å¤´ï¼Œä½†ä¸è®¾ç½® END_STREAM æ ‡å¿—ã€‚ä¿ç•™è®¾ç½®äº† END_STREAM çš„ç©ºæ•°æ®å¸§ã€‚ å¦‚æœè¯·æ±‚æœ‰æ­£æ–‡ï¼Œå‘é€ headers å’Œé™¤äº†æœ€åä¸€ä¸ªå­—èŠ‚ä¹‹å¤–çš„æ‰€æœ‰æ­£æ–‡æ•°æ®ã€‚ä¿ç•™ä¸€ä¸ªåŒ…å«æœ€åå­—èŠ‚çš„æ•°æ®æ®µã€‚

æ¥ä¸‹æ¥ï¼Œå‡†å¤‡å‘é€æœ€åçš„å¸§: 

ç­‰å¾…100msä»¥ç¡®ä¿åˆå§‹å¸§å·²ç»å‘é€ã€‚ç¡®ä¿TCP_NODELAYè¢«ç¦ç”¨(Nagle's algorithmå¯¹æœ€åçš„å¸§è¿›è¡Œæ‰¹å¤„ç†æ˜¯è‡³å…³é‡è¦çš„)ã€‚å‘é€ä¸€ä¸ªpingåŒ…æ¥æš–åŒ–æœ¬åœ°è¿æ¥(å¦‚æœä½ ä¸è¿™æ ·åšï¼ŒOSç½‘ç»œæ ˆä¼šæŠŠç¬¬ä¸€ä¸ªfinal-frameæ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åŒ…ä¸­)ã€‚

æœ€åï¼Œå‘é€è¢«æ‰£ç•™çš„å¸§ã€‚

![d56c-article-blackhat_diagrams-14](Racing and Smashing the state machine/d56c-article-blackhat_diagrams-14-16922686162414.png)



## Black-Box detection

åœ¨ç«äº‰å†’é™©åˆ©ç”¨é‡Œ**å¤æ‚åº¦(æ—¶é—´)**æ˜¯ä¸€ä¸ªå…³é”®çš„å› ç´ ï¼Œä»–ä¸`race window`çŠ¶æ€çš„å­˜åœ¨æ—¶é—´æœ‰è¾ƒå¤§çš„å…³è”ã€‚æœ‰äº›æ—¶å€™è¾ƒé•¿æ—¶é—´çš„å“åº”å¯èƒ½æ„å‘³ç€åç«¯å¤„ç†å¯èƒ½åº”ç”¨åˆ°äº†å¦å¤–çš„çº¿ç¨‹ï¼Œåœ¨æœ‰äº›æ—¶å€™å¯ä»¥ä½œä¸ºåˆ©ç”¨ç‚¹ã€‚

ç„¶è€Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè®¸å¤šåº”ç”¨ç¨‹åºä½äºå‰ç«¯æœåŠ¡å™¨åé¢ï¼Œè¿™äº›åº”ç”¨ç¨‹åºå¯èƒ½å†³å®šå°†ä¸€äº›è¯·æ±‚é€šè¿‡ç°æœ‰è¿æ¥è½¬å‘åˆ°åç«¯ï¼Œ å¹¶ä¸ºå…¶ä»–åº”ç”¨ç¨‹åº**åˆ›å»ºæ–°çš„è¿æ¥**ã€‚ å› æ­¤ï¼Œä¸åº”è¯¥å°†ä¸ä¸€è‡´çš„è¯·æ±‚æ—¶é—´å½’å› äºåº”ç”¨ç¨‹åºè¡Œä¸ºï¼Œä¾‹å¦‚åªå…è®¸å•ä¸ªçº¿ç¨‹ä¸€æ¬¡è®¿é—®èµ„æºçš„é”å®šæœºåˆ¶ã€‚**å‰ç«¯è¯·æ±‚è·¯ç”±**é€šå¸¸æ˜¯åœ¨æ¯ä¸ªè¿æ¥çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æ‰§è¡ŒæœåŠ¡å™¨ç«¯è¿æ¥**é¢„çƒ­(åœ¨æ‰§è¡Œæ”»å‡»ä¹‹å‰å‘é€ä¸€äº›æ— å…³ç´§è¦çš„è¯·æ±‚)**æ¥å¹³æ»‘è¯·æ±‚æ—¶é—´ã€‚

xxxxxxxxxxÂ $ cast call 0x364Ca1729564bdB0cE88301FC72cbE3dCCcC08eD "getFlag()" -r https://eth-sepolia.g.alchemy.com/v2/SMfUKiFXRNaIsjRSccFuYCq8Q3QJgks8 --private-key <64byteskey>  | cut -c3- | xxd -r -p | (cat && printf "\x0A") 8TCP1P{4_b1t_of_f0undry_s3nd_4nd_abiCoder_w0n7_hur7_y34h}bash



### Detailed Method

å…·ä½“è€Œè¨€ï¼Œç›¸å…³æµ‹è¯•éœ€è¦**å‘é€å¤§é‡çš„è¯·æ±‚**ï¼Œä»¥æœ€å¤§é™åº¦åœ°å¢åŠ å¯è§å‰¯ä½œç”¨çš„æœºä¼šï¼Œå¹¶å‡è½»æœåŠ¡å™¨ç«¯çš„æŠ–åŠ¨ã€‚

å¯ä»¥æŠŠè¿™çœ‹ä½œæ˜¯ä¸€ç§**åŸºäºæ··æ²Œçš„ç­–ç•¥**â€”â€”å¦‚æœæˆ‘ä»¬çœ‹åˆ°äº†ä¸€äº›**æœ‰è¶£(æˆ–æ˜¯ä¸å¸¸è§„)**çš„äº‹æƒ…ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åé¢çš„æµ‹è¯•ä¸­å¼„æ¸…æ¥šå®é™…å‘ç”Ÿäº†ä»€ä¹ˆã€‚ å‡†å¤‡å¥½ä½ çš„æ··åˆè¯·æ±‚ï¼Œç›®æ ‡ç«¯ç‚¹å’Œå‚æ•°ï¼Œä»¥è§¦å‘æ‰€æœ‰ç›¸å…³çš„ä»£ç è·¯å¾„ã€‚åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¤šä¸ªè¯·æ±‚å¤šæ¬¡è§¦å‘æ¯ä¸ªä»£ç è·¯å¾„ï¼Œä½¿ç”¨ä¸åŒçš„è¾“å…¥å€¼ã€‚

æ¥ä¸‹æ¥ï¼Œé€šè¿‡æ··åˆå‘é€ä½ çš„è¯·æ±‚ï¼Œåœ¨æ¯ä¸ªè¯·æ±‚ä¹‹é—´é—´éš”å‡ ç§’é’Ÿï¼Œå¯¹ç«¯ç‚¹åœ¨æ­£å¸¸æƒ…å†µä¸‹çš„è¡Œä¸ºè¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚ æœ€åï¼Œä½¿ç”¨å•åŒ…æ”»å‡»(å¦‚æœä¸æ”¯æŒ HTTP/2ï¼Œåˆ™ä½¿ç”¨ **last-byte sync** )ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰è¯·æ±‚ã€‚å¯ä»¥åœ¨`Turbo Intruder`ä¸­ä½¿ç”¨`single package attack template`ï¼Œæˆ–è€…åœ¨`repeater`ä¸­ä½¿ç”¨å¹³è¡Œå‘é€é€‰é¡¹ã€‚

åˆ†æç»“æœå¹¶**ä»¥ä»»ä½•åç¦»åŸºå‡†è¡Œä¸º**çš„æ–¹å¼å¯»æ‰¾çº¿ç´¢ã€‚è¿™å¯èƒ½æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå›å¤çš„å˜åŒ–ï¼Œæˆ–è€…æ˜¯äºŒé˜¶æ•ˆåº”ï¼Œæ¯”å¦‚ä¸åŒçš„é‚®ä»¶å†…å®¹ï¼Œæˆ–è€…æ˜¯ä¼šè¯ä¸­å¯è§çš„å˜åŒ–ã€‚çº¿ç´¢å¯èƒ½æ˜¯å¾®å¦™çš„ï¼Œè¿åç›´è§‰çš„ã€‚

**å‡ ä¹ä»»ä½•ä¸œè¥¿**éƒ½å¯ä»¥æˆä¸ºçº¿ç´¢ï¼Œä½†è¦å¯†åˆ‡æ³¨æ„è¯·æ±‚å¤„ç†æ—¶é—´ã€‚å¦‚æœå®ƒæ¯”ä½ é¢„æœŸçš„æ—¶é—´çŸ­ï¼Œè¿™å¯èƒ½è¡¨æ˜æ•°æ®æ­£åœ¨è¢«ä¼ é€’åˆ°ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¤§å¤§å¢åŠ äº†æ¼æ´çš„æœºä¼šã€‚å¦‚æœå®ƒæ¯”ä½ é¢„æœŸçš„é•¿ï¼Œè¿™å¯èƒ½è¡¨æ˜èµ„æºé™åˆ¶æˆ–åº”ç”¨ç¨‹åºæ­£åœ¨ä½¿ç”¨é”å®šæ¥é¿å…å¹¶å‘é—®é¢˜ã€‚

è¦æ³¨æ„çš„æ˜¯ï¼ŒPHP é»˜è®¤é”å®š sessionidï¼Œå› æ­¤æ‚¨éœ€è¦ä¸ºæ‰¹å¤„ç†ä¸­çš„æ¯ä¸ªè¯·æ±‚ä½¿ç”¨å•ç‹¬çš„ä¼šè¯ï¼Œå¦åˆ™å®ƒä»¬å°†è¢«æŒ‰ç…§é¡ºåºå¤„ç†ã€‚ä»¥åŠè¶Šå°‘çš„åŒæ—¶è¯·æ±‚æ„å‘³ç€å¯¹äº‹ä»¶æ›´åŠ æ•æ„Ÿã€éœ€è¦æ›´å¤šçš„æµ‹è¯•æ¬¡æ•°ã€‚



## White-Box Code Analyze

ä»ç™½ç›’è§’åº¦åˆ†æè¿™ç«äº‰å†’é™©æ¼æ´æ— ç–‘æ˜¯å›°éš¾ä¸”éš¾ä»¥å®Œå¤‡çš„ï¼Œå³ä½¿å¯ä»¥è·å–æºä»£ç ä¹Ÿåº”è¯¥åšå¤§é‡çš„é»‘ç›’æµ‹è¯•ã€‚

### CVE-2022-4037 Gitlab

è¿™æ˜¯ä½œè€…åœ¨æ–‡ä¸­æåˆ°çš„å”¯ä¸€ç™½ç›’ç¤ºä¾‹ï¼Œå·²ç»åšäº†ä¿®å¤[^5]ã€‚

```bash
git config --global http.proxy http://127.0.0.1:7890
git config --global https.proxy http://127.0.0.1:7890
git clone https://gitlab.com/gitlab-org/gitlab.git
cd gitlab
git reset --hard 613dbd78
```

GitLab çš„ä»“åº“è¾ƒä¸ºåºå¤§ï¼Œå¦‚æœä½ å¯¹å…¶å¹¶ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼ŒğŸ‘†è¿™å°†æ˜¯ä¸€ä¸ªé”™è¯¯çš„å†³å®šã€‚

```bash
cd ..; rm -rf gitlab/
```

GitLab çš„è®¤è¯éƒ¨åˆ†é›†æˆäº†`Ruby on rails`è®¤è¯æ¡†æ¶**devise**[^9]ã€‚

[/lib/devise/models/confirmable.rb](https://github.com/heartcombo/devise/blob/ec0674523e7909579a5a008f16fb9fe0c3a71712/lib/devise/models/confirmable.rb)

![image-20230816231345119](Racing and Smashing the state machine/image-20230816231345119.png)

å°†ä¼ å…¥çš„è¡¨å• email å†…å®¹è§£æï¼Œèµ‹å€¼ç»™è¯¥å®ä¾‹çš„`unconfirm_email`ã€‚

![image-20230816225924835](Racing and Smashing the state machine/image-20230816225924835.png)

è¿™é‡Œå°†`Devise.friendly_token`ç»™å‡ºçš„ **unique token **èµ‹ç»™äº†å®ä¾‹å˜é‡`@raw_confirmation_token`ï¼Œåœ¨ä¹‹åè¿›è¡Œäº†ä¿å­˜ã€‚

![image-20230816232622027](Racing and Smashing the state machine/image-20230816232622027.png)

å°†å®ä¾‹å˜é‡`@raw_confirmation_token`ä»¥åŠ`opts`ä»æ•°æ®åº“ä¸­åŠ è½½åˆ°`send_devise_notification`å‡½æ•°ä¸­ï¼Œå‘é€é‚®ä»¶ã€‚ç”±äº`send_devise_notification`è°ƒç”¨äº†å¦å¤–çš„çº¿ç¨‹ï¼Œå› è€Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¼šé€ æˆ`race window`ã€‚

![æœªå‘½åç»˜å›¾.drawio](Racing and Smashing the state machine/æœªå‘½åç»˜å›¾.drawio.png)

## Common exploitation categories

æ–‡ä¸­æåˆ°çš„ä¸‰ç§ç«äº‰å†’é™©åˆ©ç”¨æ–¹å¼ï¼Œæœ‰ä¸€å®šçš„äº¤å‰éƒ¨åˆ†ï¼Œå¹¶ä¸”å®é™…æƒ…å†µä¸­å¯èƒ½ä¸æ­¢è¿™å››ç§ã€‚

- Limit-overrun: ä¼ ç»Ÿçš„ racing æ–¹æ³•ï¼Œå»ºç«‹åœ¨TOCTOUçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡å¯¹æŸä¸€é™åˆ¶çš„**ç«äº‰æ»¥ç”¨**ï¼Œå®ç°å—ä¿æŠ¤æ“ä½œçš„é‡å¤æ‰§è¡Œã€‚

- Single-endpoint collisions: å•è¯·æ±‚çš„é‡å¤å‘é€ï¼Œéš¾ä»¥ç™½ç›’æ¢æµ‹è¿™ä¸€é—®é¢˜ï¼Œè€Œ**åç«¯å¤æ‚æ€§**ç»™äºˆäº†è¿™ä¸€ç±»æ¼æ´è¾ƒå¤§çš„å½±å“ã€‚ä¸Šæ–‡æåˆ°çš„CVE-2022-4037å°±å±è¿™ä¸€ç±»ã€‚

- Multi-endpoint collisions: **å¤šè¯·æ±‚ã€å¤šç»“æŸç‚¹**çš„åˆ©ç”¨ã€‚åœ¨å¤æ‚è¯·æ±‚çš„è¿‡ç¨‹ä¸­æ‰§è¡Œç®€å•è¯·æ±‚ä¸­æ’å…¥ç®€å•è¯·æ±‚ï¼Œä½¿å¾—ä¼ é€’çš„æœªæ£€éªŒæ•°æ®æ¥è§¦åˆ°å—ä¿æŠ¤æ“ä½œã€‚å…·ä½“å¯è§ä¸‹æ–‡çš„ Practice writeupã€‚



## Defence

**é¿å…æ··åˆä¸åŒæ—¶åˆ»çš„æ•°æ®**ã€‚æ¡ˆä¾‹ä¸­è®¾è®¡åº“ä»æ•°æ®åº“ä¸­è¯»å–ä»¤ç‰Œï¼Œç„¶åé€šè¿‡ç”µå­é‚®ä»¶å°†å…¶å‘é€åˆ°ä¿å­˜åœ¨å®ä¾‹å˜é‡ä¸­çš„åœ°å€ã€‚å¦‚æœå®ƒä»æ•°æ®åº“ä¸­åŒæ—¶è¯»å–äº†ä»¤ç‰Œå’Œç”µå­é‚®ä»¶åœ°å€ï¼Œæˆ–è€…å°†å®ƒä»¬éƒ½ä¼ é€’åˆ°å®ä¾‹å˜é‡ä¸­ï¼Œå®ƒå°±ä¸ä¼šå—åˆ°æ”»å‡»ã€‚

é€šè¿‡ä½¿ç”¨ datastore çš„å¹¶å‘ç‰¹æ€§ï¼Œ**ç¡®ä¿æ•æ„Ÿç«¯ç‚¹ä½¿çŠ¶æ€æ›´æ”¹åŸå­åŒ–**ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨å•ä¸€æ•°æ®åº“äº‹åŠ¡æ¥æ£€æŸ¥ä»˜æ¬¾æ˜¯å¦åŒ¹é… cart å€¼å¹¶ç¡®è®¤è®¢å•ã€‚ä½œä¸ºæ·±åº¦é˜²å¾¡æªæ–½ï¼Œåˆ©ç”¨æ•°æ®å­˜å‚¨å®Œæ•´æ€§/ä¸€è‡´æ€§ç‰¹å¾ï¼Œå¦‚å”¯ä¸€æ€§çº¦æŸã€‚

**ä¸è¦è¯•å›¾ä½¿ç”¨ä¸€ä¸ªæ•°æ®å­˜å‚¨å±‚æ¥ä¿æŠ¤å¦ä¸€ä¸ª**ã€‚ä¾‹å¦‚ï¼Œä¼šè¯ä¸é€‚åˆé˜²æ­¢å¯¹æ•°æ®åº“çš„é™åˆ¶-è¶…å‡ºæ”»å‡»ã€‚

**ç¡®ä¿ä½ çš„ä¼šè¯å¤„ç†æ¡†æ¶ä¿æŒä¼šè¯å†…éƒ¨ä¸€è‡´**ã€‚å•ç‹¬æ›´æ–°ä¼šè¯å˜é‡è€Œä¸æ˜¯æ‰¹é‡æ›´æ–°å¯èƒ½æ˜¯ä¸€ä¸ªä¸é”™çš„ä¼˜åŒ–ï¼Œä½†å®ƒæ˜¯æå…¶å±é™©çš„ã€‚è¿™ä¹Ÿé€‚ç”¨äº ORMs é€šè¿‡éšè—åƒ transactions è¿™æ ·çš„æ¦‚å¿µï¼Œä»–ä»¬ä¸ºå®ƒä»¬æ‰¿æ‹…å…¨éƒ¨è´£ä»»ã€‚

åœ¨æŸäº›æ¶æ„ä¸­ï¼Œå®Œå…¨é¿å…æœåŠ¡å™¨ç«¯çŠ¶æ€å¯èƒ½æ˜¯åˆé€‚çš„ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ å¯†æ¥æ¨é€çŠ¶æ€å®¢æˆ·ç«¯ï¼Œå¦‚ JWTã€‚




## Future Research

- Applied Range: ç«äº‰çš„åº”ç”¨èŒƒå›´ç›®å‰åŸºæœ¬å±€é™äºWebåº”ç”¨ï¼Œç„¶è€Œç«æ€å†’é™©å¹¶ä¸å±€é™äºç‰¹å®šçš„`web-app`æ¶æ„ã€‚å¤šçº¿ç¨‹å•æ•°æ®åº“åº”ç”¨ç¨‹åºæ˜¯æœ€å®¹æ˜“æ¨ç†çš„ï¼Œä½†æ›´å¤æ‚çš„è®¾ç½®é€šå¸¸ä¼šå¯¼è‡´çŠ¶æ€å­˜å‚¨åœ¨æ›´å¤šçš„åœ°æ–¹ï¼Œè€Œ`ORMs`åªæ˜¯å°†å±é™©éšè—åœ¨æŠ½è±¡å±‚ä¹‹ä¸‹ã€‚åƒ NodeJS è¿™æ ·çš„å•çº¿ç¨‹ç³»ç»Ÿæš´éœ²çš„ç¨å¾® å°‘ä¸€äº›ï¼Œä½†æœ€ç»ˆä»ç„¶å¯èƒ½å®¹æ˜“å—åˆ°æ”»å‡»ã€‚

- Partial construction attacks: éƒ¨åˆ†æ„é€ æ”»å‡»æ˜¯æ•°æ®ç»“æ„åœ¨åšå‡ºå®Œæ•´æ”¹å˜ä¹‹å‰çš„çŠ¶æ€æœªè¢«é™åˆ¶è®¿é—®ï¼Œé€ æˆçš„ä¸­é—´æ€ã€‚ä¸‹æ–‡ä¼šå°±ç›¸å…³çš„ pj0 çš„ WebRTC ç ”ç©¶åšå‡ºç®€å•æ€»ç»“ã€‚

- Single-packet attack enhancements: å•åŒ…æ”»å‡»è‡ªèº«çš„ä¼˜åŒ–ï¼Œé’ˆå¯¹`å»¶è¿Ÿmulti-endpointå•ä¸ªæ•°æ®åŒ…ä¸­ç‰¹å®šè¯·æ±‚çš„å¤„ç†`ï¼Œ`æ€»ä½“æ”¯æŒçš„æœ€å¤§å¹¶è¡Œæ•°é‡`ã€`ä»TCPè½¬ç§»åˆ°TLSå±‚åˆ©ç”¨`ä¸‰ä¸ªå±‚é¢ã€‚

- Unsafe data structures: ä¸€ã€æ•°æ®ç»“æ„å±‚åœ¨ç°å®ä¸­åº”å¯¹ç«äº‰çš„æ–¹å¼â€”â€”é”å®šã€‚ç„¶è€Œè¿™ä¸€æ–¹å¼å¯¹äºæ•ˆç‡è€Œè¨€è¿‡äºæ¿€è¿›ã€‚å› è€Œæœ‰äº›æ—¶å€™é”å®šé’ˆå¯¹çš„æ˜¯å•ä¸ªä¼šè¯ï¼Œè¿™æ˜¯å¦‚æœä½¿ç”¨ä¸¤ä¸ªå•ç‹¬çš„ä¼šè¯ï¼Œè¯¥æ¼æ´ä»ç„¶æ˜¯å¯åˆ©ç”¨çš„ã€‚äºŒã€æ‰¹å¤„ç†çš„ç»“æ„ä½¿å¾—å¼€å§‹å¤„ç†ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå®ƒä»¬ä¼šè¯»å–æ•´ä¸ªè®°å½•ï¼Œå°†éšåçš„è¯»/å†™æ“ä½œåº”ç”¨äºè¯¥è®°å½•çš„æœ¬åœ°å†…å­˜å‰¯æœ¬ï¼Œç„¶åå½“è¯·æ±‚å¤„ç†å®Œæˆæ—¶ï¼Œæ•´ä¸ªè®°å½•è¢«åºåˆ—åŒ–å›æ•°æ®åº“ã€‚ä½†å¦‚æœä¸¤ä¸ªè¯·æ±‚åŒæ—¶å¯¹åŒä¸€æ¡è®°å½•è¿›è¡Œæ“ä½œï¼Œå…¶ä¸­ä¸€ä¸ªå°†æœ€ç»ˆä»å¦ä¸€ä¸ªé‡å†™æ•°æ®åº“çš„æ›´æ”¹ã€‚è¿™æ„å‘³ç€å®ƒä»¬ä¸èƒ½ç”¨æ¥é˜²å¾¡å½±å“å…¶ä»–å­˜å‚¨å±‚çš„æ”»å‡»ã€‚ä¸‰ã€æ— ä¿æŠ¤æ˜¯æœ€å¸¸è§çš„ç»“æ„ï¼Œå¹¶ä¸”æ˜¯æœ€å®¹æ˜“åˆ©ç”¨çš„ã€‚

  paperä¸­ç»™å‡ºæ— ä¿æŠ¤ä¸‹çš„å¯åˆ©ç”¨ç‰‡æ®µå¦‚ä¸‹ï¼ˆåº”è¯¥äº‹pythonï¼‰ï¼š

  ```python
  # Bypass code-based password reset
  session['reset_username'] = username
  session['reset_code'] = randomCode()
  Exploit: Simultaneous reset for $your-username and $victim-username
  ```

  ```python
  # Bypass 2FA
  session['user'] = username
  if 2fa_enabled:
      session['require2fa'] = true
  Exploit: Simultaneous login and sensitive page fetch
  ```

  ```python
  # Session-swap
  session['user'] = username
  set_auth_cookies_for(session['user'])
  Detect: Simultaneous login to two separate accounts from same session
  Exploit: Force anon session cookie on victim, then log in simultaneously
  ```



# Related Knowledge

æ–‡ä¸­æåˆ°çš„ã€ä»¥åŠä¸ç«äº‰å¯†åˆ‡ç›¸å…³çš„å‡ ä¸ªçŸ¥è¯†ç‚¹ã€‚

## Atomic operation

å¦‚æœè¿™ä¸ªæ“ä½œæ‰€å¤„çš„å±‚(layer)çš„æ›´é«˜å±‚ä¸èƒ½å‘ç°å…¶å†…éƒ¨å®ç°ä¸ç»“æ„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œæ˜¯ä¸€ä¸ª**åŸå­(atomic)æ“ä½œ**[^6]ã€‚åŸå­æ“ä½œå¯ä»¥æ˜¯ä¸€ä¸ªæ­¥éª¤ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªæ“ä½œæ­¥éª¤ï¼Œä½†æ˜¯å…¶é¡ºåºä¸å¯ä»¥è¢«æ‰“ä¹±ï¼Œä¹Ÿä¸å¯ä»¥è¢«åˆ‡å‰²è€Œåªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚**å°†æ•´ä¸ªæ“ä½œè§†ä½œä¸€ä¸ªæ•´ä½“**æ˜¯åŸå­æ€§çš„æ ¸å¿ƒç‰¹å¾ã€‚

åœ¨å¤šè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œèƒ½å¤Ÿç¡®ä¿**æ‰€æœ‰å…¶ä»–çš„è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰**éƒ½ä¸åœ¨åŒä¸€æ—¶é—´å†…è®¿é—®ç›¸åŒçš„èµ„æºã€‚åŸå­æ“ä½œï¼ˆatomic operationï¼‰æ˜¯ä¸éœ€è¦**synchronized**ï¼Œä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼›è¿™ç§æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼Œä¸­é—´ä¸ä¼šæœ‰ä»»ä½• context switchï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒæŒ‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼‰[^7]ã€‚

**HTTP è¯·æ±‚**å¤„ç†ä¸æ˜¯**åŸå­**çš„â€”â€”ä»»ä½•ç«¯ç‚¹éƒ½å¯èƒ½é€šè¿‡ä¸å¯è§çš„å­çŠ¶æ€å‘é€åº”ç”¨ç¨‹åºã€‚è¿™æ„å‘³ç€åœ¨**ç«äº‰æ€åŠ¿**ä¸‹ï¼Œä¸€åˆ‡éƒ½æ˜¯å¤šæ­¥éª¤çš„ã€‚



## Nagle's algorithm

çº¦ç¿°Â·çº³æ ¼çš„æ–‡ä»¶æè¿°äº†ä»–æ‰€è°“çš„â€œå°æ•°æ®åŒ…é—®é¢˜â€ï¼æŸä¸ªåº”ç”¨ç¨‹åºä¸æ–­åœ°æäº¤å°å•ä½çš„èµ„æ–™ï¼Œä¸”æŸäº›å¸¸åªå 1 byteå¤§å°ã€‚è€Œç”±äºæ•°æ®åŒ…å…·æœ‰40 bytes çš„æ ‡å¤´ä¿¡æ¯ï¼ˆTCPä¸IPv4å„å 20å­—èŠ‚ï¼‰ï¼Œè¿™å¯¼è‡´äº†41 bytes å¤§å°çš„æ•°æ®åŒ…åªæœ‰ 1 byte çš„å¯ç”¨ä¿¡æ¯ï¼Œé€ æˆåºå¤§çš„æµªè´¹ã€‚è¿™ç§çŠ¶å†µå¸¸å¸¸å‘ç”Ÿäº Telnet å·¥ä½œé˜¶æ®µï¼å¤§éƒ¨åˆ†çš„é”®ç›˜æ“ä½œä¼šäº§ç”Ÿ1å­—èŠ‚çš„èµ„æ–™å¹¶é©¬ä¸Šæäº¤ã€‚æ›´ç³Ÿçš„æ˜¯ï¼Œåœ¨æ…¢é€Ÿçš„ç½‘ç»œè¿çº¿ä¸‹ï¼Œè¿™ç±»çš„æ•°æ®åŒ…ä¼šå¤§é‡åœ°åœ¨åŒä¸€æ—¶ç‚¹ä¼ è¾“ï¼Œé€ æˆå£…å¡ç¢°æ’ã€‚

çº³æ ¼ç®—æ³•çš„å·¥ä½œæ–¹å¼æ˜¯åˆå¹¶ï¼ˆcoalescingï¼‰ä¸€å®šæ•°é‡çš„è¾“å‡ºèµ„æ–™åä¸€æ¬¡æäº¤ã€‚ç‰¹åˆ«çš„æ˜¯ï¼Œåªè¦æœ‰å·²æäº¤çš„æ•°æ®åŒ…å°šæœªç¡®è®¤ï¼Œå‘é€è€…ä¼šæŒç»­ç¼“å†²æ•°æ®åŒ…ï¼Œç›´åˆ°ç´¯ç§¯ä¸€å®šæ•°é‡çš„èµ„æ–™æ‰æäº¤ã€‚

TCP å®ç°é€šå¸¸ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªæ¥å£æ¥ç¦ç”¨ Nagle ç®—æ³•ã€‚åœ¨Windowsä¸­ï¼Œåœ¨æ³¨å†Œè¡¨HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters ä¸‹æ–°å»ºä¸€ä¸ªåä¸º TcpAckFrequency çš„ DWORDï¼Œä½¿å…¶å€¼ä¸º0å³å¯ç¦ç”¨ Nagle ç®—æ³•ã€‚

åœ¨æœ«å­—èŠ‚åŒæ­¥æ”»å‡»æ‰‹æ®µçš„ç»“æŸå¸§å‘é€å°±åº”ç”¨äº†å†…æ ¼å°”ç®—æ³•å¯¹æœ€åå¸§çš„æ‰¹å¤„ç†ã€‚



## Locking

### Optimistic Locking

ä¹è§‚é”å¸¸è§çš„æœ‰ç‰ˆæœ¬å·å’ŒCASç®—æ³•ä¸¤ç§æœºåˆ¶[^8]ã€‚

- ç‰ˆæœ¬å·æœºåˆ¶ä¸€èˆ¬æ˜¯åœ¨æ•°æ®è¡¨ä¸­åŠ ä¸Šä¸€ä¸ªæ•°æ®ç‰ˆæœ¬å·versionå­—æ®µï¼Œè¡¨ç¤ºæ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ï¼Œå½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œversionå€¼ä¼šåŠ ä¸€ã€‚å½“çº¿ç¨‹Aè¦æ›´æ–°æ•°æ®å€¼æ—¶ï¼Œåœ¨è¯»å–æ•°æ®çš„åŒæ—¶ä¹Ÿä¼šè¯»å–versionå€¼ï¼Œåœ¨æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»å–åˆ°çš„versionå€¼ä¸ºå½“å‰æ•°æ®åº“ä¸­çš„versionå€¼ç›¸ç­‰æ—¶æ‰æ›´æ–°ï¼Œå¦åˆ™é‡è¯•æ›´æ–°æ“ä½œï¼Œç›´åˆ°æ›´æ–°æˆåŠŸã€‚~~_ä¸ªäººæ„Ÿè§‰ç›¸å½“äºä½¿ç”¨ä¸€ä¸ªæ•°æ®æ¥ä¿æŠ¤å¦ä¸€ä¸ªï¼Œå¹¶ä¸èƒ½å¾ˆå¥½èµ·åˆ°ä¿æŠ¤æ•ˆæœ_~~

- å³**compare and swapï¼ˆæ¯”è¾ƒä¸äº¤æ¢ï¼‰**ï¼Œæ˜¯ä¸€ç§æœ‰åçš„**æ— é”ç®—æ³•**ã€‚æ— é”ç¼–ç¨‹ï¼Œå³ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹å®ç°å¤šçº¿ç¨‹ä¹‹é—´çš„å˜é‡åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯åœ¨æ²¡æœ‰çº¿ç¨‹è¢«é˜»å¡çš„æƒ…å†µä¸‹å®ç°å˜é‡çš„åŒæ­¥ï¼Œæ‰€ä»¥ä¹Ÿå«éé˜»å¡åŒæ­¥ï¼ˆNon-blocking Synchronizationï¼‰ã€‚**CASç®—æ³•**æ¶‰åŠåˆ°ä¸‰ä¸ªæ“ä½œæ•°

  - éœ€è¦è¯»å†™çš„å†…å­˜å€¼ V
  - è¿›è¡Œæ¯”è¾ƒçš„å€¼ A
  - æ‹Ÿå†™å…¥çš„æ–°å€¼ B

  å½“ä¸”ä»…å½“ V çš„å€¼ç­‰äº Aæ—¶ï¼ŒCASé€šè¿‡åŸå­æ–¹å¼ç”¨æ–°å€¼Bæ¥æ›´æ–°Vçš„å€¼ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œï¼ˆæ¯”è¾ƒå’Œæ›¿æ¢æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸€ä¸ª**è‡ªæ—‹æ“ä½œ**ï¼Œå³**ä¸æ–­çš„é‡è¯•**ã€‚



### Pessimistic Locking

æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ç›´åˆ°å®ƒæ‹¿åˆ°é”ï¼ˆ**å…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹**ï¼‰ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“é‡Œè¾¹å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”ã€‚Javaä¸­`synchronized`å’Œ`ReentrantLock`ç­‰ç‹¬å é”å°±æ˜¯æ‚²è§‚é”æ€æƒ³çš„å®ç°ã€‚

æ‚²è§‚é”æ˜¯æœ€æ¿€è¿›çš„ä¿æŠ¤æ–¹å¼ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦å½±å“å¹¶å‘ä¸‹çš„ååé‡ã€‚



# Metioned Practice Writeup

>paperä¸­æåˆ°çš„web-security-labã€‚ä¸‹é¢å®Œæˆå¹¶è®°å½•äº†éƒ¨åˆ†è¿‡ç¨‹

## Lab: Limit overrun race conditions

https://portswigger.net/web-security/race-conditions/lab-race-conditions-limit-overrun

~~_å…ˆä¸‹ä¸ªcommunity burp 2023.9_~~

å…ˆä¹°ä¸ªæœ€ä¾¿å®œçš„å•†å“ï¼Œç®€å•æµ‹è¯•ä¸‹åŠŸèƒ½

![image-20230813210423059](Racing and Smashing the state machine/image-20230813210423059-16922686162425.png)

`GET /product`æŸ¥çœ‹å•†å“è¯¦ç»†ä¿¡æ¯ï¼Œ`POST /card`å°†æäº¤è¡¨å•ä¸­çš„å•†å“æ·»åŠ åˆ° cartï¼Œ`GET /cart`æŸ¥çœ‹è´­ç‰©è½¦ï¼Œ`POST /cart/coupon`åº”ç”¨ä¼˜æƒ åˆ¸ï¼Œ`POST /cart/checkout`å®Œæˆè´­ä¹°åŠ¨ä½œç„¶å303è·³è½¬åˆ°`GET /cart/order-comfirmation`æ˜¾ç¤ºè´­ä¹°åä¿¡æ¯ã€‚

å› ä¸ºä¸»é¢˜æ˜¯`single-package-attack`ï¼Œå•åŒ…æ”»å‡»ï¼Œå³ä¸€æ¬¡å‘é€å¤šä¸ªè¯·æ±‚ã€‚è€Œè¯¥ä¼˜æƒ åˆ¸åº”ç”¨è·¯ç”±å¯èƒ½ä¼šé€ æˆå¯èƒ½å­˜åœ¨çš„`Race Window`ã€‚

ç›´æ¥é‡‡ç”¨æ–°ç‰ˆ burpsuite æä¾›çš„åŠŸèƒ½ï¼Œå°†`POST /cart/coupon`å‘é€åˆ° repeater 19æ¬¡ï¼Œåˆå¹¶ä¸ºä¸€ä¸ªç»„ï¼Œç„¶åè°ƒæ•´å‘é€æ–¹å¼ï¼Œå‘é€å³å¯ã€‚ï¼ˆburpçš„send parallelå¯¹äºhttp/1.1é‡‡ç”¨æœ«å­—èŠ‚åŒæ­¥æŠ€æœ¯ï¼Œhttp/2é‡‡ç”¨å•åŒ…æ”»å‡»æŠ€æœ¯[^10]ï¼‰

<img src="Racing and Smashing the state machine/image-20230813213040972-16922669383881.png" alt="image-20230813213040972" style="zoom:50%;" />

æ­¤æ—¶å›åˆ°`GET /card`ç•Œé¢å·²ç»åªæœ‰$19.25äº†ï¼Œæ­¤æ—¶å†è´­ä¹°å³å¯ã€‚

<img src="Racing and Smashing the state machine/image-20230813213134092-16922669715043.png" alt="image-20230813213134092" style="zoom:33%;" />



## Lab: single-endpoint race conditions

https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint

ç›®æ ‡è¦æŠŠé‚®ç®±ä¿®æ”¹ä¸º`carlos@ginandjuice.shop`ï¼Œè€Œå¯ä»¥æ¥è§¦çš„åªæœ‰`@exploit-0afe0072043930a78126f2df0155002a.exploit-server.net`ä¸‹çš„é‚®ç®±ã€‚

ä½¿ç”¨ turbo Intruder è„šæœ¬å•åŒ…æ”»å‡»äºŒåæ¬¡

```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=1,
                           engine=Engine.BURP2
                           )

    for i in range(20):
        engine.queue(target.req, str(i), gate='race1')

    engine.openGate('race1')


def handleResponse(req, interesting):
    table.add(req)
```

å›åˆ°é‚®ç®±ç•Œé¢å¯ä»¥æ˜æ˜¾æ³¨æ„åˆ°ä¿®æ”¹åœ°å€å’Œ`send to`åœ°å€åŸºæœ¬ä¸åŒ¹é…



<img src="Racing and Smashing the state machine/image-20230817121032403.png" alt="image-20230817121032403" style="zoom: 50%;" />

ç°åœ¨ä»…ä¿ç•™ä¸¤ä¸ªæŠ¥æ–‡å‰¯æœ¬ï¼Œä¸€ä¸ªä¸ºå¯æ¥æ”¶çš„é‚®ç®±ï¼Œä¸€ä¸ªä¸º`carlos@ginandjuice.shop`

å¤šæ¬¡å‘é€ï¼ˆäº²æµ‹æŠŠ`carlos@ginandjuice.shop`æ”¾åœ¨åé¢æˆåŠŸç‡é«˜ã€‚è™½ç„¶åŒä¸ªTCPä½†å¯èƒ½è¿˜æ˜¯æœ‰å¾®ç§’çº§å½±å“ï¼‰

![image-20230817121740600](Racing and Smashing the state machine/image-20230817121740600.png)

éªŒè¯åœ°å€å†åˆ é™¤`carlos`ç”¨æˆ·å°±å¯ä»¥äº†ã€‚

## Lab: Multi-endpoint race conditions

https://portswigger.net/web-security/race-conditions/lab-race-conditions-multi-endpoint

ç½‘ç«™æ•´ä½“åŠŸèƒ½å’Œç¬¬ä¸€ä¸ªå®éªŒå·®ä¸å¤šï¼Œä½†æ˜¯å°‘äº†couponå¤šäº†ä¸€ä¸ªå¯è´­ä¹°çš„ç¤¼å“å¡ï¼ŒèŠ±$10å¾—åˆ°çš„ç¤¼å“å¡å°±æ˜¯ä¸€ä¸²codeï¼Œä½¿ç”¨åè·å¾—$10ç„¶åè¯¥codeé”€æ¯å¤±æ•ˆã€‚

`Multi-endpoint`æ˜¯æŒ‡å¤šæ­¥è¯·æ±‚çš„å¤šä¸ªç»“æŸä½ç½®åˆ©ç”¨ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªè¯·æ±‚æ¯”ç¬¬äºŒä¸ªè¯·æ±‚æ›´å¤æ‚ï¼ˆæˆ–è§¦å‘é€Ÿç‡é™åˆ¶ï¼‰ï¼Œä»è€Œåœ¨ç¬¬ä¸€ä¸ªè¯·æ±‚`endpoint`ä¹‹å‰çš„`Race Window`å®Œæˆç¬¬äºŒä¸ªè¯·æ±‚çš„`endpoint`ã€‚

åœ¨Repeateré‡Œï¼Œå°†`POST /card`å’Œ`POST /card/checkout`æ·»åŠ åˆ°ä¸€ä¸ªæ–°ç»„ä¸­ï¼Œç„¶åé€šè¿‡å•ä¸ªè¿æ¥æŒ‰åºåˆ—å‘é€ï¼Œå¯¹æ¯”å“åº”æ—¶é—´ã€‚

ç„¶åå†å°†`GET /`æ·»åŠ åˆ°è¯¥ç»„å¼€å¤´ï¼Œç»§ç»­é€šè¿‡å•ä¸ªè¿æ¥æŒ‰åºåˆ—å‘é€ï¼Œå¯¹æ¯”å“åº”æ—¶é—´ã€‚

<img src="Racing and Smashing the state machine/image-20230813233044992-16922671326167.png" alt="image-20230813233044992" style="zoom:50%;" />

PortSwigger çš„æ•™ç¨‹æŒ‡å‡ºè¿™é‡Œä¸¤æ¬¡æµ‹è¯•ä¸‹çš„`POST /card`çš„å“åº”æ—¶é—´è¦æ˜æ˜¾é•¿äº`POST /card/checkout`ã€‚å¯èƒ½æ˜¯æˆ‘çš„ç½‘ç»œç¯å¢ƒé—®é¢˜å¯¼è‡´å¹¶ä¸æ˜æ˜¾ï¼Œæˆ–è€…éœ€è¦æ›´ç›´è§‚çš„æ•°æ®ä½“ç°ã€‚

æ·»åŠ ç›®æ ‡ä¿®æ”¹`POST /card`çš„ productId ä¸º1ï¼Œé€šè¿‡ http/2 å•åŒ…å‘é€ã€‚è¿™é‡Œå¯èƒ½ç”±äºä¸€äº›å¹²æ‰°å› ç´ ï¼Œéœ€è¦å¤šæ¬¡å°è¯•ï¼Œæç¤º`insufficient funds`å°±å…ˆç§»é™¤jacketï¼Œæ¢æˆä¸€å¼ cardã€‚

![image-20230813233159601](Racing and Smashing the state machine/image-20230813233159601-16922670750615.png)

_å¾ˆæ˜æ˜¾æ˜¯ç»•è¿‡çš„`/card/checkout`è·¯ç”±ä¸‹çš„èµ„é‡‘æ˜¯å¦å……è£•æ£€æµ‹ç›´æ¥ç»“è´¦ å¯¼è‡´åç»­èµ„é‡‘ä¸ºè´Ÿæ•°_



## Lab: Partial construction race conditions

https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction

éƒ¨åˆ†æ„é€ æ”»å‡»[^11]æ˜¯é’ˆå¯¹æ•°æ®ç»“æ„å±‚é¢çš„åˆ©ç”¨ï¼Œå³åœ¨çŠ¶æ€æœºæ”¹å˜è¿‡ç¨‹ä¸­ç•™ä¸‹ä¸€ä¸ª`race window`ã€‚ä¾‹å¦‚ JSON æ•°æ®è®¾å®šè¿‡ç¨‹ä¸­ç•™ä¸‹äº†`undefined`æˆ–`null`çš„çŠ¶æ€ï¼ŒPHP array åˆ›å»ºè¿‡ç¨‹ä¸­ç•™ä¸‹äº†ç©ºæ•°ç»„ã€‚ç”±äºè‡ªå®šä¹‰å®¢æˆ·ç«¯çš„å¤„ç†ä¸ä¸€ï¼Œå¯èƒ½ä¼šå¯¹è¯¥ä¸­é—´çŠ¶æ€åšå‡ºä¸åŒçš„è§£é‡Šã€‚

é¢˜ç›®ç›®æ ‡æ˜¯åˆ©ç”¨ä¸å­˜åœ¨çš„é‚®ç®±æ³¨å†Œè´¦å·ï¼Œå¹¶èµ‹æœ‰`/email`çš„é‚®ç®±å®¢æˆ·ç«¯ã€‚æäº¤æ³¨å†Œè¯·æ±‚ï¼ŒæŸ¥çœ‹æµè§ˆå™¨ DevTools > Network å¯ä»¥çœ‹åˆ°èµ„æº`/resources/static/users.js`è¢«åŠ è½½ï¼Œå¹¶æ³„éœ²ç¡®è®¤é“¾æ¥å½¢ä¼¼`/comfirm?token=`ã€‚

è€ƒè™‘æœåŠ¡ç«¯åœ¨ä¿å­˜tokenæ—¶å­˜åœ¨éƒ¨åˆ†æ„é€ çŠ¶æ€ã€‚é€šè¿‡ä¿®æ”¹tokenè¿›è¡Œæµ‹è¯•ï¼šæäº¤`/confirm?token=1`è¿”å› "Incorrect token: 1"ï¼›æäº¤`/confirm?token[]=`è¿”å› "Incorrect token: Array"ï¼Œç”±æ­¤å¯ä»¥ç¡®è®¤æœåŠ¡ç«¯æ¡†æ¶è§£æ`token[]=`ä¸ºç©ºæ•°ç»„ã€‚ç°ä½¿ç”¨ç©ºæ•°ç»„åŒ¹é…éƒ¨åˆ†æ„é€ çŠ¶æ€ã€‚ï¼ˆè¿™é‡Œçš„å•åŒ…åˆæ­¥æµ‹è¯•å‡ºç°äº†åè®®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œç›´æ¥ä¿®æ”¹å†åå¤ç‚¹å‡»åˆ·æ–°ä¸ºhttp/2ï¼‰

ä¸ºäº†é¿å…é”™è¿‡çŸ­æš‚çš„`race window`ï¼Œä½¿ç”¨`turbo Intruder(Extension)`å¹¶å‘å¤§é‡è¯·æ±‚ã€‚

```python
def queueRequests(target, wordlists):

    engine = RequestEngine(endpoint=target.endpoint,
                                concurrentConnections=1,
                                engine=Engine.BURP2
                                )

    confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0aae00b1046ded96810f3f720043001b.web-security-academy.net
Cookie: phpsessionid=iDVi7uegZUoLuFLuHslvxFHWwi0buIxL
Content-Length: 0

'''
    for attempt in range(20):
        currentAttempt = str(attempt)
        username = 'U0er' + currentAttempt

        # queue a single registration request
        engine.queue(target.req, username, gate=currentAttempt)

        # queue 50 confirmation requests - note that this will probably sent in two separate packets
        for i in range(50):
            engine.queue(confirmationReq, gate=currentAttempt)

        # send all the queued requests for this attempt
        engine.openGate(currentAttempt)


def handleResponse(req, interesting):
    table.add(req)
```

æ‰¾åˆ°`/confirm`è¿”å›çš„200å“åº”ï¼Œç™»å½•ã€‚ç„¶ååˆ é™¤carlosç”¨æˆ·å³å¯å®Œæˆã€‚

![image-20230814214830252](Racing and Smashing the state machine/image-20230814214830252-16922686162426.png)

_u1s1 partial construction å®é™…ä¸Šä¹Ÿæ˜¯multi-endpointçš„ä¸€ç§_



# WebRTC Research

https://googleprojectzero.blogspot.com/2021/01/the-state-of-state-machines.html

# Quote Link

[^1]: https://portswigger.net/research/smashing-the-state-machine

[^2]: https://www.usenix.org/conference/usenixsecurity20/presentation/van-goethem

[^3]: https://aaltodoc.aalto.fi/bitstream/handle/123456789/47110/master_Papli_Kaspar_2020.pdf

[^4]: https://en.wikipedia.org/wiki/Nagle%27s_algorithm

[^5]: https://gitlab.com/gitlab-org/gitlab/-/commit/e4d8d4f818275d42469d154b72fc6367b2b86bbb

[^6]: https://baike.baidu.com/item/%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/1880992

[^7]: https://www.zhihu.com/question/25532384/answer/81152571

[^8]: https://zhuanlan.zhihu.com/p/40211594

[^9]: https://github.com/heartcombo/devise

[^10]: https://portswigger.net/burp/documentation/desktop/tools/repeater/send-group#sending-requests-in-parallel

[^11]: https://portswigger.net/research/smashing-the-state-machine#partial-construction
